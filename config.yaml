# ==============================================================================
# Azure VDI Deployment - Central Configuration
# ==============================================================================
#
# This is the single source of truth for all configuration values.
# Claude Code is always aware of this file via .claude/CLAUDE.md
#
# Configuration is loaded via: source core/config-manager.sh && load_config
#
# Security Note:
#   - This file should be added to .gitignore
#   - Never commit passwords or secrets
#   - Use environment variables for sensitive data
#
# ==============================================================================

# ==============================================================================
# Azure Global Settings
# ==============================================================================
azure:
  subscription_id: "00000000-0000-0000-0000-000000000000"  # REPLACE with your subscription ID
  tenant_id: "00000000-0000-0000-0000-000000000000"        # REPLACE with your tenant ID
  location: "centralus"                                     # Azure region
  resource_group: "RG-Azure-VDI-01"                        # Main resource group
  environment: "prod"                                       # Environment: prod, dev, test

# ==============================================================================
# Networking Configuration (Module 01) - Generic & Advanced
# ==============================================================================
networking:
  # Virtual Network
  vnet:
    name: "avd-vnet"
    address_space: ["10.0.0.0/16"]           # Array for multiple address spaces
    location: "{{AZURE_LOCATION}}"           # Inherit from global setting
    dns_servers: []                          # Optional custom DNS (empty = Azure default)

  # Subnets (User-defined array - add/remove as needed)
  subnets:
    # Session Hosts Subnet
    - name: "subnet-session-hosts"
      address_prefix: "10.0.1.0/24"
      service_endpoints:                     # Azure service endpoints
        - "Microsoft.Storage"                # For Azure Files/Blob
        - "Microsoft.KeyVault"               # For Key Vault access
      delegation: ""                         # Subnet delegation (leave empty for none)
      private_endpoint_network_policies: "Enabled"
      private_link_service_network_policies: "Enabled"
      nsg:
        enabled: true
        name: ""                             # Auto-generated: nsg-subnet-session-hosts
        use_defaults: true                   # Smart defaults for AVD session hosts
        custom_rules: []                     # Add custom rules here to extend defaults
        # Example custom rule:
        # - name: "Deny-Internet-Outbound"
        #   priority: 4000
        #   direction: "Outbound"
        #   access: "Deny"
        #   protocol: "*"
        #   source_address_prefix: "*"
        #   source_port_range: "*"
        #   destination_address_prefix: "Internet"
        #   destination_port_range: "*"

    # Private Endpoints Subnet (for Storage, Key Vault, etc.)
    - name: "subnet-private-endpoints"
      address_prefix: "10.0.2.0/24"
      service_endpoints: []
      delegation: ""
      private_endpoint_network_policies: "Disabled"  # Required for private endpoints
      private_link_service_network_policies: "Enabled"
      nsg:
        enabled: true
        name: ""                             # Auto-generated: nsg-subnet-private-endpoints
        use_defaults: true                   # Smart defaults for private endpoints
        custom_rules: []

    # Management Subnet (optional - for Azure Bastion, jump boxes)
    - name: "subnet-management"
      address_prefix: "10.0.3.0/27"          # Small subnet (32 IPs)
      service_endpoints:
        - "Microsoft.Storage"
      delegation: ""
      private_endpoint_network_policies: "Enabled"
      private_link_service_network_policies: "Enabled"
      nsg:
        enabled: true
        name: ""                             # Auto-generated: nsg-subnet-management
        use_defaults: true                   # Smart defaults for management subnet
        custom_rules: []

  # Private DNS Zones (for Azure PaaS services with private endpoints)
  private_dns:
    enabled: false                           # Set to true to enable private DNS zones
    zones:
      - name: "privatelink.file.core.windows.net"      # Azure Files
        link_to_vnet: true
      - name: "privatelink.blob.core.windows.net"      # Azure Blob Storage
        link_to_vnet: true
      - name: "privatelink.vaultcore.azure.net"        # Azure Key Vault
        link_to_vnet: true

  # VNet Peering (Hub-Spoke topology)
  peering:
    enabled: false                           # Set to true to enable VNet peering
    hub_vnet:
      name: ""                               # Hub VNet name
      resource_group: ""                     # Hub VNet resource group
      subscription_id: "{{AZURE_SUBSCRIPTION_ID}}"  # Can be different subscription
    allow_virtual_network_access: true
    allow_forwarded_traffic: true
    allow_gateway_transit: false             # Set true if hub has VPN/ExpressRoute gateway
    use_remote_gateways: false               # Set true to use hub's gateway

  # Route Tables (for forced tunneling, firewall routing)
  route_tables:
    enabled: false                           # Set to true to enable custom routing
    tables:
      - name: "rt-session-hosts"
        routes:
          - name: "route-to-firewall"
            address_prefix: "0.0.0.0/0"      # Default route
            next_hop_type: "VirtualAppliance"  # VirtualAppliance, VnetLocal, Internet, None
            next_hop_ip_address: "10.1.0.4"  # Firewall IP (if using VirtualAppliance)
        associated_subnets:
          - "subnet-session-hosts"           # Subnets to associate this route table with

# ==============================================================================
# Storage Configuration (Module 02)
# ==============================================================================
storage:
  # Storage Account Settings
  account_name: ""                      # Auto-generated if empty: fslogix<random5>
  sku: "Premium_LRS"                    # Premium_LRS, Premium_ZRS
  kind: "FileStorage"                   # FileStorage for Premium Files
  tier: "Premium"                       # Premium or Standard (use Premium for AVD)

  # File Share Settings
  file_share_name: "fslogix-profiles"   # File share name for FSLogix profiles
  quota_gb: 1024                        # File share quota in GB (1024 = 1TB)
  # Quota calculation: (Number of users Ã— 50GB) + 20% buffer
  # Examples:
  #   - 20 users: 1024GB (1TB)
  #   - 100 users: 6144GB (6TB)
  #   - 400 users: 24576GB (24TB)

  # Authentication Settings
  enable_entra_kerberos: true           # Enable Entra Kerberos for passwordless access
  enable_smb_multichannel: true         # Enable SMB Multichannel for performance

  # Network Security
  public_network_access: "Disabled"     # Disabled = private endpoint only
  allow_blob_public_access: false       # Block public blob access
  https_only: true                      # Require HTTPS
  min_tls_version: "TLS1_2"             # Minimum TLS version

  # Private Endpoint Settings
  private_endpoint:
    enabled: true                       # Create private endpoint
    subnet_name: "{{NETWORKING_PRIVATE_ENDPOINT_SUBNET_NAME}}"
    dns_zone_name: "privatelink.file.core.windows.net"

  # Advanced Settings
  enable_large_file_share: true         # Support for large file shares
  enable_soft_delete: true              # Enable soft delete for file shares
  soft_delete_retention_days: 7         # Retention period for deleted shares

# ==============================================================================
# Entra ID Configuration (Module 03)
# ==============================================================================
entra_id:
  # User groups
  group_users_standard: "AVD-Users-Standard"
  group_users_admins: "AVD-Users-Admins"

  # Device groups
  group_devices_sso: "AVD-Devices-Pooled-SSO"
  group_devices_fslogix: "AVD-Devices-Pooled-FSLogix"
  group_devices_network: "AVD-Devices-Pooled-Network"
  group_devices_security: "AVD-Devices-Pooled-Security"

# ==============================================================================
# Host Pool Configuration (Module 04)
# ==============================================================================
host_pool:
  name: "Pool-Pooled-Prod"
  type: "Pooled"                        # Pooled or Personal
  max_sessions: 10
  load_balancer: "BreadthFirst"         # BreadthFirst or DepthFirst

# ==============================================================================
# Workspace Configuration (Module 04)
# ==============================================================================
workspace:
  name: "AVD-Workspace-Prod"
  friendly_name: "Azure Virtual Desktop"
  description: "Production AVD workspace"

# ==============================================================================
# Application Group Configuration (Module 04)
# ==============================================================================
app_group:
  name: "Desktop-Prod"
  type: "Desktop"                       # Desktop or RemoteApp
  friendly_name: "Desktop"

# ==============================================================================
# Golden Image Configuration (Module 05)
# ==============================================================================
golden_image:
  # Temporary VM for image creation
  temp_vm_name: "gm-temp-vm"
  vm_size: "Standard_D4s_v6"

  # Windows base image
  image_publisher: "MicrosoftWindowsDesktop"
  image_offer: "windows-11"
  image_sku: "win11-25h2-avd"
  image_version: "latest"

  # VM credentials (password should be set via environment variable)
  admin_username: "entra-admin"
  admin_password: ""                    # NEVER commit password - use environment variable

  # Azure Compute Gallery
  gallery_name: "avd_gallery"
  definition_name: "windows11-golden-image"
  image_sku_name: "Win11-Pooled-FSLogix"
  image_publisher_name: "YourCompany"
  image_offer_name: "AVD"

  # Timezone
  timezone: "Central Standard Time"
  timezone_redirection_enabled: true

  # Software versions
  fslogix_version: "2.9.8653.48899"
  vdot_version: "3.8"

# ==============================================================================
# Session Host Configuration (Module 06)
# ==============================================================================
session_host:
  vm_count: 1
  vm_size: "Standard_D4s_v6"
  name_prefix: "avd-sh"

  # Image source (from golden image)
  use_golden_image: true

# ==============================================================================
# Intune Configuration (Module 07)
# ==============================================================================
intune:
  enabled: true
  device_compliance_required: false

# ==============================================================================
# RBAC Configuration (Module 08)
# ==============================================================================
rbac:
  # Role assignments for user groups
  assign_desktop_users: true
  assign_admin_users: true

# ==============================================================================
# SSO Configuration (Module 09)
# ==============================================================================
sso:
  enabled: true
  method: "azuread"                     # azuread or adfs

# ==============================================================================
# Autoscaling Configuration (Module 10)
# ==============================================================================
autoscaling:
  enabled: true
  schedule:
    weekday_start_hour: 7               # 7 AM
    weekday_stop_hour: 19               # 7 PM
    weekend_enabled: false

  capacity:
    min_vms: 1
    max_vms: 10
    ramp_up_capacity_threshold: 60      # Percentage
    ramp_down_capacity_threshold: 30    # Percentage

# ==============================================================================
# Testing Configuration (Module 11)
# ==============================================================================
testing:
  validate_connectivity: true
  validate_fslogix: true
  validate_sso: true
  test_user_login: false                # Requires test user credentials

# ==============================================================================
# Tags (Applied to all resources)
# ==============================================================================
tags:
  environment: "production"
  project: "avd-deployment"
  managed_by: "azure-cli-automation"
  cost_center: "IT"
