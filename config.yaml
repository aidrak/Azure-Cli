# ==============================================================================
# Azure VDI Deployment - Central Configuration
# ==============================================================================
#
# This is the single source of truth for all configuration values.
# Claude Code is always aware of this file via .claude/CLAUDE.md
#
# Configuration is loaded via: source core/config-manager.sh && load_config
#
# Security Note:
#   - This file should be added to .gitignore
#   - Never commit passwords or secrets
#   - Use environment variables for sensitive data
#
# ==============================================================================

# ==============================================================================
# Azure Global Settings
# ==============================================================================
azure:
  subscription_id: "6c7eb5e0-8e77-40dd-a06c-bdb06c2d5856" # REPLACE with your subscription ID
  tenant_id: "e61ea1b3-fb30-4c33-90c0-18570ade4b60" # REPLACE with your tenant ID
  location: "centralus" # Azure region
  resource_group: "RG-Azure-VDI-01" # Main resource group
  environment: "prod" # Environment: prod, dev, test
# ==============================================================================
# Networking Configuration (Module 01) - Generic & Advanced
# ==============================================================================
networking:
  # Virtual Network
  vnet:
    name: "avd-vnet"
    address_space: ["10.0.0.0/16"] # Array for multiple address spaces
    location: "{{AZURE_LOCATION}}" # Inherit from global setting
    dns_servers: [] # Optional custom DNS (empty = Azure default)
  # Subnets (User-defined array - add/remove as needed)
  subnets:
    # Session Hosts Subnet
    - name: "subnet-session-hosts"
      address_prefix: "10.0.1.0/24"
      service_endpoints: # Azure service endpoints
        - "Microsoft.Storage" # For Azure Files/Blob
        - "Microsoft.KeyVault" # For Key Vault access
      delegation: "" # Subnet delegation (leave empty for none)
      private_endpoint_network_policies: "Enabled"
      private_link_service_network_policies: "Enabled"
      nsg:
        enabled: true
        name: "" # Auto-generated: nsg-subnet-session-hosts
        use_defaults: true # Smart defaults for AVD session hosts
        custom_rules:
          - name: "Allow-RDP-From-Admin"
            priority: 3900
            direction: "Inbound"
            access: "Allow"
            protocol: "Tcp"
            source_address_prefix: "67.3.179.193" # Your IP address
            source_port_range: "*"
            destination_address_prefix: "*"
            destination_port_range: "3389" # RDP port
    # Private Endpoints Subnet (for Storage, Key Vault, etc.)
    - name: "subnet-private-endpoints"
      address_prefix: "10.0.2.0/24"
      service_endpoints: []
      delegation: ""
      private_endpoint_network_policies: "Disabled" # Required for private endpoints
      private_link_service_network_policies: "Enabled"
      nsg:
        enabled: true
        name: "" # Auto-generated: nsg-subnet-private-endpoints
        use_defaults: true # Smart defaults for private endpoints
        custom_rules: []
    # Management Subnet (optional - for monitoring VMs, Azure Firewall, or future use)
    - name: "subnet-management"
      address_prefix: "10.0.3.0/27" # Small subnet (32 IPs)
      service_endpoints:
        - "Microsoft.Storage"
      delegation: ""
      private_endpoint_network_policies: "Enabled"
      private_link_service_network_policies: "Enabled"
      nsg:
        enabled: true
        name: "" # Auto-generated: nsg-subnet-management
        use_defaults: true # Smart defaults for management subnet
        custom_rules: []
  # Private DNS Zones (for Azure PaaS services with private endpoints)
  private_dns:
    enabled: false # Set to true to enable private DNS zones
    zones:
      - name: "privatelink.file.core.windows.net" # Azure Files
        link_to_vnet: true
      - name: "privatelink.blob.core.windows.net" # Azure Blob Storage
        link_to_vnet: true
      - name: "privatelink.vaultcore.azure.net" # Azure Key Vault
        link_to_vnet: true
  # VNet Peering (Hub-Spoke topology)
  peering:
    enabled: false # Set to true to enable VNet peering
    hub_vnet:
      name: "" # Hub VNet name
      resource_group: "" # Hub VNet resource group
      subscription_id: "{{AZURE_SUBSCRIPTION_ID}}" # Can be different subscription
    allow_virtual_network_access: true
    allow_forwarded_traffic: true
    allow_gateway_transit: false # Set true if hub has VPN/ExpressRoute gateway
    use_remote_gateways: false # Set true to use hub's gateway
  # Route Tables (for forced tunneling, firewall routing)
  route_tables:
    enabled: false # Set to true to enable custom routing
    tables:
      - name: "rt-session-hosts"
        routes:
          - name: "route-to-firewall"
            address_prefix: "0.0.0.0/0" # Default route
            next_hop_type: "VirtualAppliance" # VirtualAppliance, VnetLocal, Internet, None
            next_hop_ip_address: "10.1.0.4" # Firewall IP (if using VirtualAppliance)
        associated_subnets:
          - "subnet-session-hosts" # Subnets to associate this route table with
  # VPN Gateway Configuration
  vpn_gateway:
    enabled: true # Set to true to enable VPN gateway
    name: "vpn-gw-ipsec"
    type: "Vpn" # Vpn or ExpressRoute
    sku: "VpnGw1" # VpnGw1, VpnGw2, VpnGw3, VpnGw4, VpnGw5
    generation: "Generation1" # Generation1 or Generation2
    active_active: false # Enable active-active mode for high availability
  # Local Network Gateway Configuration
  local_network_gateways:
    enabled: true # Set to true to enable local network gateways
    gateways:
      - name: "lng-onprem-ipsec"
        gateway_address: "203.0.113.50" # Public IP of on-premises VPN device
        address_spaces:
          - "192.168.0.0/16" # On-premises network address space
        bgp_settings:
          enabled: false # Enable BGP for dynamic routing
          asn: 65000 # Autonomous System Number
      # Add more local network gateways as needed
      # - name: "lng-datacenter"
      #   gateway_address: "203.0.113.51"
      #   address_spaces:
      #     - "172.16.0.0/12"
      #   bgp_settings:
      #     enabled: true
      #     asn: 65001
  # VPN Connection Configuration
  vpn_connections:
    enabled: true # Set to true to enable VPN connections
    connections:
      - name: "vpn-conn-ipsec"
        local_network_gateway_name: "lng-onprem-ipsec"
        connection_type: "IPsec" # IPsec or Vnet2Vnet
        shared_key: "SharedKeyForIPsec123!" # Pre-shared key (set via environment variable for security)
        enable_bgp: false # Enable BGP for this connection
        # Example with BGP:
        # - name: "vpn-conn-datacenter"
        #   local_network_gateway_name: "lng-datacenter"
        #   connection_type: "IPsec"
        #   shared_key: ""
        #   enable_bgp: true

  # ===========================================================================
  # Additional Networking Resources (For operations)
  # ===========================================================================

  # Load Balancer (for session host load balancing)
  load_balancer_name: "lb-session-hosts"
  load_balancer_sku: "Standard" # Basic or Standard
  load_balancer_type: "Internal" # Internal or Public

  # Public IP (for VPN gateway or load balancer)
  public_ip_name: "pip-vpn-gateway"
  public_ip_sku: "Standard" # Basic or Standard
  public_ip_allocation_method: "Static" # Static or Dynamic

  # Route Table (for custom routing/forced tunneling)
  route_table_name: "rt-session-hosts"

  # Session Host Subnet Name (reference for operations)
  session_host_subnet_name: "subnet-session-hosts"

# ==============================================================================
# Storage Configuration (Module 02)
# ==============================================================================
storage:
  # Storage Account Settings
  account_name: "" # Auto-generated if empty: fslogix<random5>
  sku: "Premium_LRS" # Premium_LRS, Premium_ZRS
  kind: "FileStorage" # FileStorage for Premium Files
  tier: "Premium" # Premium or Standard (use Premium for AVD)
  # File Share Settings
  file_share_name: "fslogix-profiles" # File share name for FSLogix profiles
  quota_gb: 1 # File share quota in GB (1 = 1GB for testing)
  # Quota calculation: (Number of users Ã— 50GB) + 20% buffer
  # Examples:
  #   - 20 users: 1024GB (1TB)
  #   - 100 users: 6144GB (6TB)
  #   - 400 users: 24576GB (24TB)

  # Authentication Settings
  enable_entra_kerberos: true # Enable Entra Kerberos for passwordless access
  enable_smb_multichannel: true # Enable SMB Multichannel for performance
  # Network Security
  public_network_access: "Disabled" # Disabled = private endpoint only
  allow_blob_public_access: false # Block public blob access
  https_only: true # Require HTTPS
  min_tls_version: "TLS1_2" # Minimum TLS version
  # Private Endpoint Settings
  private_endpoint:
    enabled: true # Create private endpoint
    subnet_name: "{{NETWORKING_PRIVATE_ENDPOINT_SUBNET_NAME}}"
    dns_zone_name: "privatelink.file.core.windows.net"
  # Private DNS Configuration
  private_dns:
    enabled: true # Enable private DNS zone for storage
    zone_name: "privatelink.file.core.windows.net"
    link_to_vnet: true # Link private DNS zone to VNet
  # Advanced Settings
  enable_large_file_share: true # Support for large file shares
  enable_soft_delete: true # Enable soft delete for file shares
  soft_delete_retention_days: 7 # Retention period for deleted shares

  # Blob Storage Settings (for general-purpose storage accounts)
  blob_container_name: "" # TODO: Set if using blob containers
  blob_public_access: "None" # None, Blob, Container

# ==============================================================================
# Entra ID Configuration (Module 03)
# ==============================================================================
entra_id:
  # User groups
  group_users_standard: "AVD-Users-Standard"
  group_users_standard_description: "Standard users with access to AVD resources"
  group_users_admins: "AVD-Users-Admins"
  group_users_admins_description: "Administrative users with elevated AVD access"
  # Device groups (for Intune/Conditional Access policies)
  group_devices_sso: "AVD-Devices-Pooled-SSO"
  group_devices_sso_description: "Device group for SSO configuration policies"
  group_devices_fslogix: "AVD-Devices-Pooled-FSLogix"
  group_devices_fslogix_description: "Device group for FSLogix profile management"
  group_devices_network: "AVD-Devices-Pooled-Network"
  group_devices_network_description: "Device group for network configuration policies"
  group_devices_security: "AVD-Devices-Pooled-Security"
  group_devices_security_description: "Device group for security baseline policies"
# ==============================================================================
# Host Pool Configuration (Module 04)
# ==============================================================================
host_pool:
  name: "Pool-Pooled-Prod"
  type: "Pooled" # Pooled or Personal
  max_sessions: 10
  load_balancer: "BreadthFirst" # BreadthFirst or DepthFirst
  friendly_name: "Production Pooled Desktop" # Host pool friendly name
  description: "Pooled desktop host pool for production users" # Host pool description

# ==============================================================================
# Workspace Configuration (Module 04)
# ==============================================================================
workspace:
  name: "AVD-Workspace-Prod"
  friendly_name: "Azure Virtual Desktop"
  description: "Production AVD workspace"
# ==============================================================================
# Application Group Configuration (Module 04)
# ==============================================================================
app_group:
  name: "Desktop-Prod"
  type: "Desktop" # Desktop or RemoteApp
  friendly_name: "Desktop"

# ==============================================================================
# AVD Application Configuration
# ==============================================================================
avd_application:
  name: "" # TODO: Set application name when adding RemoteApps
  friendly_name: "" # Application display name
  description: "" # Application description
  path: "" # Application executable path
  command_line_args: "" # Command line arguments
  icon_path: "" # Icon file path
  icon_index: 0 # Icon index in the file
  show_in_portal: true # Show in Azure portal

# ==============================================================================
# AVD Scaling Plan Configuration
# ==============================================================================
avd_scaling_plan:
  name: "scaling-plan-pooled-prod"
  description: "Autoscaling plan for pooled host pool"
  time_zone: "Central Standard Time"
  enabled: true

# ==============================================================================
# Golden Image Configuration (Module 05)
# ==============================================================================
golden_image:
  # Temporary VM for image creation
  temp_vm_name: "vm-golden-img"
  vm_size: "Standard_D4s_v6"
  # Windows base image
  image_publisher: "MicrosoftWindowsDesktop"
  image_offer: "windows-11"
  image_sku: "win11-25h2-avd"
  image_version: "latest"
  # VM credentials (password should be set via environment variable)
  admin_username: "entra-admin"
  admin_password: "" # Set in secrets.yaml (NEVER commit passwords here!)
  # Azure Compute Gallery
  gallery_name: "avd_gallery"
  definition_name: "windows11-golden-image"
  image_sku_name: "Win11-Pooled-FSLogix"
  image_publisher_name: "YourCompany"
  image_offer_name: "AVD"
  # Application manifest for parallel installation
  applications:
    - chrome
    - adobereader
    # - vscode
    # - teams
  # Timezone
  timezone: "Central Standard Time"
  timezone_redirection_enabled: true
  # Software versions
  fslogix_version: "2.9.8653.48899"
  vdot_version: "3.8"

  # Golden Image Name (for compute gallery image definition)
  image_name: "windows11-golden-image" # Alias for definition_name

  # Compute-related settings
  vm_name: "gm-temp-vm" # Alias for temp_vm_name (used by some operations)
  disk_name: "gm-temp-vm-osdisk" # OS disk name for golden image VM
  disk_size_gb: 128 # OS disk size in GB

# ==============================================================================
# Session Host Configuration (Module 06)
# ==============================================================================
session_host:
  vm_count: 1
  vm_size: "Standard_D4s_v6"
  name_prefix: "avd-sh"
  # Image source (from golden image)
  use_golden_image: true

  # Compute VM name (for individual VMs)
  vm_name: "avd-sh-01" # Individual session host VM name

# ==============================================================================
# Compute Resources (Availability Sets, Extensions)
# ==============================================================================
compute:
  # Availability Set Configuration
  availability_set_name: "avset-session-hosts"
  availability_set_enabled: false # Set to true to use availability sets
  fault_domain_count: 2
  update_domain_count: 5

  # VM Extension Configuration
  extension_name: "" # TODO: Set when deploying VM extensions
  extension_publisher: "" # e.g., "Microsoft.Compute"
  extension_type: "" # e.g., "CustomScriptExtension"
  extension_version: "" # e.g., "1.10"

# ==============================================================================
# Intune Configuration (Module 07)
# ==============================================================================
intune:
  enabled: true
  device_compliance_required: false
# ==============================================================================
# RBAC Configuration (Module 08)
# ==============================================================================
rbac:
  # Role assignments for user groups
  assign_desktop_users: true
  assign_admin_users: true
# ==============================================================================
# SSO Configuration (Module 09)
# ==============================================================================
sso:
  enabled: true
  method: "azuread" # azuread or adfs
# ==============================================================================
# Autoscaling Configuration (Module 10)
# ==============================================================================
autoscaling:
  enabled: true

  # Schedule Configuration
  schedule:
    weekday_start_hour: 7 # 7 AM
    weekday_stop_hour: 19 # 7 PM
    weekend_enabled: false

  # Capacity Configuration
  capacity:
    min_vms: 1 # Minimum number of session hosts
    max_vms: 10 # Maximum number of session hosts
    ramp_up_capacity_threshold: 60 # Percentage
    ramp_down_capacity_threshold: 30 # Percentage

  # Additional autoscaling variables (for operations)
  min_vms: 1 # Top-level alias for operations
  max_vms: 10 # Top-level alias for operations
  weekday_start_hour: 7 # Top-level alias for operations
  weekday_stop_hour: 19 # Top-level alias for operations
# ==============================================================================
# Testing Configuration (Module 11)
# ==============================================================================
testing:
  validate_connectivity: true
  validate_fslogix: true
  validate_sso: true
  test_user_login: false # Requires test user credentials
# ==============================================================================
# Tags (Applied to all resources)
# ==============================================================================
tags:
  environment: "production"
  project: "avd-deployment"
  managed_by: "azure-cli-automation"
  cost_center: "IT"
