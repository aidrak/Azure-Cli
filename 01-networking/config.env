#!/bin/bash

################################################################################
# Networking Configuration for AVD Deployment
#
# This file configures the networking infrastructure (VNets, subnets, NSGs)
# for Azure Virtual Desktop deployments.
#
# Configuration Priority (highest to lowest):
#   1. Environment variables
#   2. Values in this file
#   3. ../config/avd-config.sh (centralized config)
#   4. Script defaults
################################################################################

# Load centralized configuration first
CENTRALIZED_CONFIG="${CENTRALIZED_CONFIG:-../config/avd-config.sh}"
if [[ -f "$CENTRALIZED_CONFIG" ]]; then
    source "$CENTRALIZED_CONFIG"
fi

# ============================================================================
# AZURE ENVIRONMENT
# ============================================================================

export SUBSCRIPTION_ID="${SUBSCRIPTION_ID:-}"
export RESOURCE_GROUP_NAME="${RESOURCE_GROUP_NAME:-RG-Azure-VDI-01}"
export LOCATION="${LOCATION:-centralus}"

# ============================================================================
# VIRTUAL NETWORK
# ============================================================================

export VNET_NAME="${VNET_NAME:-avd-vnet}"
export VNET_CIDR="${VNET_CIDR:-10.0.0.0/16}"
export VNET_LOCATION="${VNET_LOCATION:-${LOCATION}}"

# ============================================================================
# SUBNETS
# ============================================================================

# Session Hosts Subnet
export SESSION_HOSTS_SUBNET_NAME="${SESSION_HOSTS_SUBNET_NAME:-session-hosts-subnet}"
export SESSION_HOSTS_SUBNET_CIDR="${SESSION_HOSTS_SUBNET_CIDR:-10.0.1.0/24}"

# Private Endpoints Subnet
export PRIVATE_ENDPOINTS_SUBNET_NAME="${PRIVATE_ENDPOINTS_SUBNET_NAME:-private-endpoints-subnet}"
export PRIVATE_ENDPOINTS_SUBNET_CIDR="${PRIVATE_ENDPOINTS_SUBNET_CIDR:-10.0.2.0/24}"

# File Server Subnet
export FILE_SERVER_SUBNET_NAME="${FILE_SERVER_SUBNET_NAME:-file-server-subnet}"
export FILE_SERVER_SUBNET_CIDR="${FILE_SERVER_SUBNET_CIDR:-10.0.3.0/24}"

# ============================================================================
# NETWORK SECURITY GROUPS
# ============================================================================

# NSG for Session Hosts
export SESSION_HOSTS_NSG_NAME="${SESSION_HOSTS_NSG_NAME:-session-hosts-nsg}"
export SESSION_HOSTS_NSG_RULES="allow-rdp allow-https allow-winrm"

# NSG for Private Endpoints
export PRIVATE_ENDPOINTS_NSG_NAME="${PRIVATE_ENDPOINTS_NSG_NAME:-private-endpoints-nsg}"

# NSG for File Server
export FILE_SERVER_NSG_NAME="${FILE_SERVER_NSG_NAME:-file-server-nsg}"

# ============================================================================
# VNET PEERING (OPTIONAL)
# ============================================================================

# Hub VNet for peering (optional)
export HUB_VNET_NAME="${HUB_VNET_NAME:-}"
export HUB_VNET_RESOURCE_GROUP="${HUB_VNET_RESOURCE_GROUP:-}"
export HUB_VNET_ALLOW_FORWARDED_TRAFFIC="${HUB_VNET_ALLOW_FORWARDED_TRAFFIC:-true}"
export HUB_VNET_ALLOW_GATEWAY_TRANSIT="${HUB_VNET_ALLOW_GATEWAY_TRANSIT:-false}"

# ============================================================================
# TAGS
# ============================================================================

export TAGS="${TAGS:-environment=production owner=infrastructure}"

# ============================================================================
# LOGGING & ARTIFACTS
# ============================================================================

export LOG_LEVEL="${LOG_LEVEL:-INFO}"
export ENABLE_LOGGING="${ENABLE_LOGGING:-1}"
export ARTIFACTS_DIR="${ARTIFACTS_DIR:-artifacts}"

# ============================================================================
# TIMEOUTS
# ============================================================================

export OPERATION_TIMEOUT="${OPERATION_TIMEOUT:-300}"
export POLLING_INTERVAL="${POLLING_INTERVAL:-10}"
