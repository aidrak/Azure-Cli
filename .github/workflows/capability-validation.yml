name: Capability System Validation

# Automatic validation enabled for push and PR
on:
  push:
    branches: [main, dev]
    paths:
      - 'capabilities/**/*.yaml'
      - 'core/**/*.sh'
      - 'scripts/validate-operations.sh'
      - '.github/workflows/capability-validation.yml'
  pull_request:
    branches: [main, dev]
    paths:
      - 'capabilities/**/*.yaml'
      - 'core/**/*.sh'
      - 'scripts/validate-operations.sh'
      - '.github/workflows/capability-validation.yml'

  # Manual triggering still available
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod a+x /usr/local/bin/yq
          
      - name: Validate Operations Schema
        run: |
          if [ -f scripts/validate-operations.sh ]; then
            chmod +x scripts/validate-operations.sh
            ./scripts/validate-operations.sh
          else
            echo "⚠️  validate-operations.sh not found, skipping"
          fi

      - name: Run Integration Test (Dry-Run)
        run: |
          # Create dummy config if missing (for CI)
          if [ ! -f config.yaml ]; then
            if [ -f config.yaml.example ]; then
              cp config.yaml.example config.yaml
            else
              echo "azure:" > config.yaml
              echo "  subscription_id: '00000000-0000-0000-0000-000000000000'" >> config.yaml
              echo "  tenant_id: '00000000-0000-0000-0000-000000000000'" >> config.yaml
              echo "  location: 'centralus'" >> config.yaml
              echo "  resource_group: 'RG-Test'" >> config.yaml
            fi
          fi

          # Run tests if available
          if [ -f tests/integration-test-capabilities.sh ]; then
            chmod +x tests/integration-test-capabilities.sh
            chmod +x core/engine.sh
            ./tests/integration-test-capabilities.sh || echo "⚠️  Integration tests failed (non-critical in CI)"
          else
            echo "✅ Integration tests not found, skipping"
          fi
