# ==============================================================================
# Application Operation: Adobe Acrobat Reader DC
# ==============================================================================

operation:
  id: "app-adobereader"
  name: "Install Adobe Acrobat Reader DC"
  description: "Download and install Adobe Acrobat Reader DC with VDI-optimized settings"

  capability: "applications"
  operation_mode: "configure"
  resource_type: "Microsoft.Compute/virtualMachines"

  duration:
    expected: 300
    timeout: 600
    type: "NORMAL"

  parameters:
    required:
      - name: "vm_name"
        type: "string"
        description: "Name of the target VM"
        default: "{{GOLDEN_IMAGE_TEMP_VM_NAME}}"
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
    optional: []

  idempotency:
    enabled: true
    check_command: |
      az vm run-command invoke \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" \
        --command-id RunPowerShellScript \
        --scripts "if (Test-Path 'C:\Program Files\Adobe\Acrobat DC\Acrobat\Acrobat.exe') { exit 0 } else { exit 1 }" \
        --output none 2>/dev/null
    skip_if_exists: true

  validation:
    enabled: true
    checks:
      - type: "file_exists"
        path: "C:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\Acrobat.exe"
        description: "Adobe Acrobat Reader executable installed"

  template:
    type: "powershell-vm-command"
    command: |
      cat > /tmp/app-adobereader-wrapper.ps1 << 'PSWRAPPER'
      $scriptContent = @'
      {{POWERSHELL_CONTENT}}
      '@
      $tempScript = "/tmp/app-adobereader-$([guid]::NewGuid()).ps1"
      $scriptContent | Out-File -FilePath $tempScript -Encoding UTF8
      az vm run-command invoke --resource-group "{{AZURE_RESOURCE_GROUP}}" --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" --command-id RunPowerShellScript --scripts "@$tempScript" --output json
      if (Test-Path $tempScript) { Remove-Item -Path $tempScript -Force -ErrorAction SilentlyContinue }
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/app-adobereader-wrapper.ps1
      rm -f /tmp/app-adobereader-wrapper.ps1

  powershell:
    file: "app-adobereader.ps1"
    content: |
      # ==============================================================================
      # Install Adobe Acrobat Reader DC
      # Complex installation: ZIP download -> Extract -> Run Setup.exe
      # ==============================================================================

      Write-Host "[START] Installing Adobe Acrobat Reader DC: $(Get-Date -Format 'HH:mm:ss')"

      $tempDir = "C:\Temp"
      $zipFile = "$tempDir\Acrobat_DC_Web.zip"
      $extractDir = "$tempDir\Acrobat_DC"
      $url = "https://trials.adobe.com/AdobeProducts/APRO/Acrobat_HelpX/win32/Acrobat_DC_Web_x64_WWMUI.zip"

      try {
          # Ensure temp directory exists
          if (-not (Test-Path $tempDir)) {
              New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
          }

          # ==========================================
          # STAGE 1: Download
          # ==========================================
          Write-Host "[STAGE 1/4] Downloading Adobe Acrobat installer..."
          Write-Host "[i] URL: $url"

          Invoke-WebRequest -Uri $url -OutFile $zipFile -UseBasicParsing -TimeoutSec 600

          if (-not (Test-Path $zipFile)) {
              throw "Download failed: ZIP file not found"
          }

          $fileSize = [math]::Round((Get-Item $zipFile).Length / 1MB, 2)
          Write-Host "[v] Download complete: $fileSize MB"

          # ==========================================
          # STAGE 2: Extract
          # ==========================================
          Write-Host "[STAGE 2/4] Extracting installer..."

          if (Test-Path $extractDir) {
              Remove-Item $extractDir -Recurse -Force
          }

          Expand-Archive -Path $zipFile -DestinationPath $extractDir -Force
          Write-Host "[v] Extraction complete"

          # ==========================================
          # STAGE 3: Install
          # ==========================================
          Write-Host "[STAGE 3/4] Installing Adobe Acrobat..."

          # Find Setup.exe (path may vary based on ZIP structure)
          $setupExe = Get-ChildItem -Path $extractDir -Recurse -Filter "Setup.exe" | Select-Object -First 1

          if (-not $setupExe) {
              throw "Setup.exe not found in extracted files"
          }

          Write-Host "[i] Found installer: $($setupExe.FullName)"

          # Adobe silent install switches:
          # /sAll - Silent install
          # EULA_ACCEPT=YES - Accept license
          # DISABLE_ARM_SERVICE_INSTALL=1 - Disable Adobe ARM (update service)
          $proc = Start-Process -FilePath $setupExe.FullName `
              -ArgumentList "/sAll /rs /msi EULA_ACCEPT=YES DISABLE_ARM_SERVICE_INSTALL=1" `
              -Wait -PassThru

          if ($proc.ExitCode -notin @(0, 1603)) {
              throw "Installation failed with exit code $($proc.ExitCode)"
          }

          Write-Host "[v] Installation complete"

          # ==========================================
          # STAGE 4: Validate and Configure
          # ==========================================
          Write-Host "[STAGE 4/4] Validating and configuring..."

          $acrobatPath = "C:\Program Files\Adobe\Acrobat DC\Acrobat\Acrobat.exe"
          if (-not (Test-Path $acrobatPath)) {
              throw "Validation failed: Acrobat executable not found"
          }

          # Disable auto-updates for VDI (registry settings)
          $regPath = "HKLM:\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown"
          if (-not (Test-Path $regPath)) {
              New-Item -Path $regPath -Force | Out-Null
          }
          Set-ItemProperty -Path $regPath -Name "bUpdater" -Value 0 -Type DWord -Force

          Write-Host "[v] Auto-updates disabled for VDI"

          # Cleanup
          Remove-Item $zipFile -Force -ErrorAction SilentlyContinue
          Remove-Item $extractDir -Recurse -Force -ErrorAction SilentlyContinue

          Write-Host "[v] Adobe Acrobat Reader DC installed successfully"
          exit 0

      } catch {
          Write-Host "[x] Error: $($_.Exception.Message)"
          # Cleanup on failure
          Remove-Item $zipFile -Force -ErrorAction SilentlyContinue
          Remove-Item $extractDir -Recurse -Force -ErrorAction SilentlyContinue
          exit 1
      }

  rollback:
    enabled: false
    steps: []

  fixes: []
