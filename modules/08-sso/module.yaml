# ==============================================================================
# Module: SSO Configuration
# ==============================================================================
module:
  id: "08-sso"
  name: "SSO Configuration"
  description: "Configure Single Sign-On (SSO) for Azure Virtual Desktop using Entra ID"

  # Module-level configuration
  config:
    resource_group: "{{AZURE_RESOURCE_GROUP}}"
    host_pool_name: "{{HOST_POOL_NAME}}"
    sso_enabled: "{{SSO_ENABLED}}"
    sso_method: "{{SSO_METHOD}}"

  # Operations in this module (executed in order)
  operations:
    - id: "sso-configure-host-pool"
      name: "Configure Host Pool RDP Properties"
      description: "Enable Entra ID authentication in host pool RDP properties"
      duration: 120  # 2 minutes
      type: "FAST"

    - id: "sso-configure-service-principal"
      name: "Configure Windows Cloud Login Service Principal"
      description: "Enable RDP protocol and configure trusted device groups via PowerShell"
      duration: 180  # 3 minutes
      type: "FAST"

    - id: "sso-verify-configuration"
      name: "Verify SSO Configuration"
      description: "Verify SSO is enabled and configured correctly"
      duration: 60   # 1 minute
      type: "FAST"

  # Module-level validation (run after all operations complete)
  validation:
    enabled: true
    checks:
      - type: "bash_command"
        command: |
          # Verify host pool has enablerdsaadauth property
          RDP_PROPS=$(az desktopvirtualization hostpool show \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --name "{{HOST_POOL_NAME}}" \
            --query "customRdpProperty" -o tsv)

          if echo "$RDP_PROPS" | grep -q "enablerdsaadauth:i:1"; then
            echo "[VALIDATE] SSO enabled in host pool RDP properties"
            exit 0
          else
            echo "[ERROR] SSO not enabled in host pool"
            exit 1
          fi
        description: "Verify SSO enabled in host pool"

  # Expected total duration
  total_duration:
    expected: 360   # 6 minutes (sum of all operations)
    timeout: 720    # 12 minutes (2x expected)

  # Module state file
  state_file: "modules/08-sso/state.json"

  # Artifacts
  artifacts:
    logs: "artifacts/logs/"
    outputs: "artifacts/outputs/"
