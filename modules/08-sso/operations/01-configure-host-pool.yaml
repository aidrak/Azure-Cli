# ==============================================================================
# Operation: Configure Host Pool for SSO
# ==============================================================================
operation:
  id: "sso-configure-host-pool"
  name: "Configure Host Pool RDP Properties"
  description: "Enable Entra ID authentication (SSO) in host pool RDP properties"

  # Duration expectations
  duration:
    expected: 120   # 2 minutes
    timeout: 300    # 5 minutes (fail-fast if exceeds)
    type: "FAST"    # FAST (<5min) or WAIT (10+min)

  # Prerequisites (check state.json)
  requires:
    - operation: "host-pool-create"
      status: "completed"
      optional: true  # Host pool may have been created previously

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          $rdpProps = az desktopvirtualization hostpool show `
            --resource-group "{{AZURE_RESOURCE_GROUP}}" `
            --name "{{HOST_POOL_NAME}}" `
            --query "customRdpProperty" -o tsv

          if ($rdpProps -match "enablerdsaadauth:i:1") {
            Write-Host "[VALIDATE] SSO enabled in RDP properties"
            exit 0
          } else {
            Write-Host "[ERROR] SSO not found in RDP properties"
            exit 1
          }
        description: "Verify SSO enabled in host pool"

  # Template command (executed via PowerShell)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/sso-01-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] SSO Host Pool Configuration: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $hostPoolName = "{{HOST_POOL_NAME}}"
      $ssoEnabled = "{{SSO_ENABLED}}"

      # Step 1: Validate Azure authentication
      Write-Host "[PROGRESS] Step 1/5: Validating Azure authentication..."
      az account show --output none 2>$null
      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Not authenticated to Azure"
        exit 1
      }

      # Step 2: Check if SSO is enabled in config
      Write-Host "[PROGRESS] Step 2/5: Checking SSO configuration..."
      if ($ssoEnabled -ne "true") {
        Write-Host "[WARNING] SSO is disabled in config.yaml (sso.enabled: false)"
        Write-Host "[WARNING] Skipping SSO configuration"

        $reportContent = @"
SSO Configuration Skipped
=========================
Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

SSO is disabled in configuration.
To enable SSO, set sso.enabled: true in config.yaml

"@
        $reportContent | Out-File -FilePath "artifacts/outputs/sso-configure-host-pool.txt" -Encoding UTF8
        exit 0
      }

      # Step 3: Verify host pool exists
      Write-Host "[PROGRESS] Step 3/5: Verifying host pool exists..."
      az desktopvirtualization hostpool show `
        --resource-group $resourceGroup `
        --name $hostPoolName `
        --output none 2>$null

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Host pool not found: $hostPoolName"
        Write-Host "[ERROR] Please ensure host pool was created (Module 04)"
        exit 1
      }

      Write-Host "[VALIDATE] Host pool found: $hostPoolName"

      # Step 4: Get current RDP properties
      Write-Host "[PROGRESS] Step 4/5: Getting current RDP properties..."
      $currentRdpProps = az desktopvirtualization hostpool show `
        --resource-group $resourceGroup `
        --name $hostPoolName `
        --query "customRdpProperty" -o tsv

      if ([string]::IsNullOrEmpty($currentRdpProps) -or $currentRdpProps -eq "null") {
        $currentRdpProps = ""
      }

      Write-Host "[VALIDATE] Current RDP properties: $(if ($currentRdpProps) { $currentRdpProps } else { '<empty>' })"

      # Check if SSO already enabled
      if ($currentRdpProps -match "enablerdsaadauth:i:1") {
        Write-Host "[SUCCESS] SSO already enabled in host pool"
      } else {
        # Step 5: Update RDP properties to enable SSO
        Write-Host "[PROGRESS] Step 5/5: Enabling SSO in RDP properties..."

        # Add SSO property to existing properties
        if (-not [string]::IsNullOrEmpty($currentRdpProps)) {
          # Append to existing properties
          $newRdpProps = "${currentRdpProps};enablerdsaadauth:i:1"
        } else {
          # No existing properties, just set SSO
          $newRdpProps = "enablerdsaadauth:i:1"
        }

        # Update host pool
        az desktopvirtualization hostpool update `
          --resource-group $resourceGroup `
          --name $hostPoolName `
          --custom-rdp-property $newRdpProps `
          --output none 2>$null

        if ($LASTEXITCODE -eq 0) {
          Write-Host "[SUCCESS] SSO enabled in host pool"
        } else {
          Write-Host "[ERROR] Failed to update host pool RDP properties"
          exit 1
        }

        # Verify the update
        $updatedRdpProps = az desktopvirtualization hostpool show `
          --resource-group $resourceGroup `
          --name $hostPoolName `
          --query "customRdpProperty" -o tsv

        Write-Host "[VALIDATE] Updated RDP properties: $updatedRdpProps"
      }

      # Save configuration details
      $reportContent = @"
SSO Host Pool Configuration
===========================
Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

Host Pool:
  Name: $hostPoolName
  Resource Group: $resourceGroup

SSO Configuration:
  Enabled: Yes
  Method: Entra ID (Azure AD)
  RDP Property: enablerdsaadauth:i:1

What This Enables:
  - Single Sign-On with Entra ID credentials
  - Passwordless authentication support
  - Windows Hello for Business integration
  - FIDO2 security key support
  - Seamless authentication from Entra-joined devices

Next Steps:
  1. Configure Windows Cloud Login service principal (manual)
  2. Add trusted device groups for SSO (manual)
  3. Configure Conditional Access policies (manual)
  4. Test user SSO experience

Manual Configuration Required:

Step 1: Enable RDP on Windows Cloud Login Service Principal
  Service Principal ID: 270efc09-cd0d-444b-a71f-39af4910ec45
  This must be done via Microsoft Graph API or Portal

Step 2: Configure Trusted Device Groups (Optional but Recommended)
  Add your device group (e.g., AVD-Devices-Pooled-SSO) to eliminate
  consent prompts for users connecting from managed devices

Step 3: Configure Conditional Access Policies
  Required Cloud Apps:
    - Azure Virtual Desktop (9cdead84-a844-4324-93f2-b2e6bb768d07)
    - Windows Cloud Login (270efc09-cd0d-444b-a71f-39af4910ec45)
    - Microsoft Remote Desktop (a4a365df-50f1-4397-bc59-1a1564b8bb9c)

  IMPORTANT: Do NOT apply sign-in frequency policies to Windows Cloud Login

Testing SSO:
  1. User launches Windows App or Remote Desktop client
  2. Signs in with Entra ID credentials (once)
  3. Desktop should launch without additional credential prompt
  4. If credential prompt appears, SSO configuration needs review

Troubleshooting:
  - Wait 10-15 minutes for changes to propagate
  - Verify session hosts are Entra-joined (not hybrid)
  - Check Virtual Machine User Login RBAC role is assigned
  - Review Conditional Access policies for conflicts

"@
      $reportContent | Out-File -FilePath "artifacts/outputs/sso-configure-host-pool.txt" -Encoding UTF8

      Write-Host "[SUCCESS] SSO host pool configuration completed"
      Write-Host ""
      Write-Host "IMPORTANT: Manual Steps Required"
      Write-Host "================================="
      Write-Host "The host pool has been configured for SSO, but additional manual"
      Write-Host "configuration is required in the Azure Portal:"
      Write-Host ""
      Write-Host "1. Configure Windows Cloud Login service principal"
      Write-Host "2. Add trusted device groups (optional)"
      Write-Host "3. Configure Conditional Access policies"
      Write-Host ""
      Write-Host "See artifacts/outputs/sso-configure-host-pool.txt for detailed instructions"
      Write-Host ""

      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/sso-01-wrapper.ps1
      rm -f /tmp/sso-01-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
