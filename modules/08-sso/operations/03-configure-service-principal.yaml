# ==============================================================================
# Operation: Configure Windows Cloud Login Service Principal
# ==============================================================================
operation:
  id: "sso-configure-service-principal"
  name: "Configure Windows Cloud Login Service Principal"
  description: "Enable RDP protocol on Windows Cloud Login service principal and configure trusted device groups"

  # Duration expectations
  duration:
    expected: 180   # 3 minutes
    timeout: 600    # 10 minutes
    type: "FAST"

  # Prerequisites
  requires:
    - operation: "sso-configure-host-pool"
      status: "completed"

  # Validation checks
  validation:
    enabled: true
    checks:
      - type: "bash_command"
        command: |
          if [[ -f "artifacts/outputs/sso-configure-service-principal.txt" ]]; then
            echo "[VALIDATE] Service principal configuration completed"
            exit 0
          else
            echo "[ERROR] Service principal configuration file not found"
            exit 1
          fi
        description: "Verify service principal configuration completed"

  # Template command (PowerShell via bash wrapper)
  template:
    type: "bash-script"
    command: |
      #!/bin/bash
      set -euo pipefail

      echo "[START] Windows Cloud Login Service Principal Configuration: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      # Configuration from config.yaml
      SSO_ENABLED="{{SSO_ENABLED}}"
      DEVICE_GROUP_NAME="{{ENTRA_GROUP_DEVICES_SSO}}"

      # Check if SSO is enabled
      if [[ "$SSO_ENABLED" != "true" ]]; then
        echo "[WARNING] SSO is disabled in configuration"
        echo "Configuration skipped" > "artifacts/outputs/sso-configure-service-principal.txt"
        exit 0
      fi

      echo "[PROGRESS] Configuring Windows Cloud Login service principal via PowerShell..."

      # Create PowerShell script
      cat > /tmp/configure-sso-sp.ps1 << 'PWSH_EOF'
      # Windows Cloud Login Service Principal Configuration
      Write-Host "[START] Configuring Windows Cloud Login Service Principal" -ForegroundColor Cyan

      try {
          # Step 1: Connect to Microsoft Graph
          Write-Host "[PROGRESS] Step 1/5: Connecting to Microsoft Graph..." -ForegroundColor Yellow

          # Check if already connected
          $context = Get-MgContext -ErrorAction SilentlyContinue
          if (-not $context) {
              Write-Host "[PROGRESS] Connecting to Microsoft Graph (user authentication required)..." -ForegroundColor Yellow
              Connect-MgGraph -Scopes "Application.ReadWrite.All", "Directory.Read.All" -NoWelcome
          } else {
              Write-Host "[SUCCESS] Already connected to Microsoft Graph" -ForegroundColor Green
          }

          # Verify connection
          $context = Get-MgContext
          Write-Host "[VALIDATE] Connected to tenant: $($context.TenantId)" -ForegroundColor Green

          # Step 2: Get Windows Cloud Login Service Principal
          Write-Host "[PROGRESS] Step 2/5: Finding Windows Cloud Login service principal..." -ForegroundColor Yellow

          $appId = "270efc09-cd0d-444b-a71f-39af4910ec45"  # Windows Cloud Login
          $servicePrincipal = Get-MgServicePrincipal -Filter "appId eq '$appId'" -ErrorAction Stop

          if (-not $servicePrincipal) {
              Write-Host "[ERROR] Windows Cloud Login service principal not found" -ForegroundColor Red
              Write-Host "[ERROR] This service principal should exist in all Azure AD tenants" -ForegroundColor Red
              exit 1
          }

          Write-Host "[SUCCESS] Found service principal: $($servicePrincipal.DisplayName)" -ForegroundColor Green
          Write-Host "[VALIDATE] Service Principal ID: $($servicePrincipal.Id)" -ForegroundColor Green

          # Step 3: Enable RDP Protocol
          Write-Host "[PROGRESS] Step 3/5: Enabling RDP protocol..." -ForegroundColor Yellow

          # Check current RDP enablement status
          $remoteDesktopSecurityConfig = $servicePrincipal.RemoteDesktopSecurityConfiguration

          if ($remoteDesktopSecurityConfig.IsRemoteDesktopProtocolEnabled) {
              Write-Host "[SUCCESS] RDP protocol already enabled" -ForegroundColor Green
          } else {
              Write-Host "[PROGRESS] Enabling RDP protocol on service principal..." -ForegroundColor Yellow

              # Enable RDP protocol
              $body = @{
                  "@odata.type" = "#microsoft.graph.remoteDesktopSecurityConfiguration"
                  isRemoteDesktopProtocolEnabled = $true
              }

              Update-MgServicePrincipalRemoteDesktopSecurityConfiguration `
                  -ServicePrincipalId $servicePrincipal.Id `
                  -BodyParameter $body `
                  -ErrorAction Stop

              Write-Host "[SUCCESS] RDP protocol enabled" -ForegroundColor Green
          }

          # Step 4: Configure Trusted Device Groups (Optional)
          Write-Host "[PROGRESS] Step 4/5: Configuring trusted device groups..." -ForegroundColor Yellow

          $deviceGroupName = $env:DEVICE_GROUP_NAME
          if ([string]::IsNullOrEmpty($deviceGroupName) -or $deviceGroupName -eq "{{ENTRA_GROUP_DEVICES_SSO}}") {
              Write-Host "[WARNING] Device group name not configured, skipping trusted device group setup" -ForegroundColor Yellow
          } else {
              # Find the device group
              Write-Host "[PROGRESS] Searching for device group: $deviceGroupName" -ForegroundColor Yellow
              $deviceGroup = Get-MgGroup -Filter "displayName eq '$deviceGroupName'" -ErrorAction SilentlyContinue

              if ($deviceGroup) {
                  Write-Host "[SUCCESS] Found device group: $($deviceGroup.DisplayName) ($($deviceGroup.Id))" -ForegroundColor Green

                  # Get current target device groups
                  $currentGroups = Get-MgServicePrincipalRemoteDesktopSecurityConfigurationTargetDeviceGroup `
                      -ServicePrincipalId $servicePrincipal.Id `
                      -ErrorAction SilentlyContinue

                  # Check if group already added
                  $alreadyAdded = $currentGroups | Where-Object { $_.Id -eq $deviceGroup.Id }

                  if ($alreadyAdded) {
                      Write-Host "[SUCCESS] Device group already configured as trusted" -ForegroundColor Green
                  } else {
                      Write-Host "[PROGRESS] Adding device group to trusted list..." -ForegroundColor Yellow

                      # Add the device group
                      New-MgServicePrincipalRemoteDesktopSecurityConfigurationTargetDeviceGroup `
                          -ServicePrincipalId $servicePrincipal.Id `
                          -BodyParameter @{ id = $deviceGroup.Id } `
                          -ErrorAction Stop

                      Write-Host "[SUCCESS] Device group added to trusted list" -ForegroundColor Green
                      Write-Host "[SUCCESS] Users connecting from devices in this group will not see consent prompts" -ForegroundColor Green
                  }
              } else {
                  Write-Host "[WARNING] Device group not found: $deviceGroupName" -ForegroundColor Yellow
                  Write-Host "[WARNING] Users may see consent prompts when connecting" -ForegroundColor Yellow
              }
          }

          # Step 5: Verify Configuration
          Write-Host "[PROGRESS] Step 5/5: Verifying configuration..." -ForegroundColor Yellow

          $finalConfig = Get-MgServicePrincipal -ServicePrincipalId $servicePrincipal.Id `
              -Property "Id,DisplayName,RemoteDesktopSecurityConfiguration"

          Write-Host "[VALIDATE] Configuration Summary:" -ForegroundColor Cyan
          Write-Host "  Service Principal: $($finalConfig.DisplayName)" -ForegroundColor White
          Write-Host "  RDP Enabled: $($finalConfig.RemoteDesktopSecurityConfiguration.IsRemoteDesktopProtocolEnabled)" -ForegroundColor White

          $trustedGroups = Get-MgServicePrincipalRemoteDesktopSecurityConfigurationTargetDeviceGroup `
              -ServicePrincipalId $servicePrincipal.Id `
              -ErrorAction SilentlyContinue

          if ($trustedGroups) {
              Write-Host "  Trusted Device Groups: $($trustedGroups.Count)" -ForegroundColor White
              foreach ($group in $trustedGroups) {
                  $groupDetails = Get-MgGroup -GroupId $group.Id -ErrorAction SilentlyContinue
                  if ($groupDetails) {
                      Write-Host "    - $($groupDetails.DisplayName)" -ForegroundColor Gray
                  }
              }
          } else {
              Write-Host "  Trusted Device Groups: None configured" -ForegroundColor White
          }

          Write-Host "[SUCCESS] Service principal configuration completed successfully" -ForegroundColor Green

          # Disconnect
          Disconnect-MgGraph | Out-Null

          exit 0

      } catch {
          Write-Host "[ERROR] Failed to configure service principal: $($_.Exception.Message)" -ForegroundColor Red
          Write-Host "[ERROR] Stack trace: $($_.ScriptStackTrace)" -ForegroundColor Red

          # Try to disconnect on error
          try { Disconnect-MgGraph | Out-Null } catch { }

          exit 1
      }
      PWSH_EOF

      # Export device group name for PowerShell
      export DEVICE_GROUP_NAME="$DEVICE_GROUP_NAME"

      # Execute PowerShell script
      if pwsh -NoProfile -NonInteractive -File /tmp/configure-sso-sp.ps1; then
        echo "[SUCCESS] Service principal configuration completed"
      else
        echo "[ERROR] Service principal configuration failed"
        echo "[ERROR] Check PowerShell output above for details"
        exit 1
      fi

      # Save details
      {
        echo "Windows Cloud Login Service Principal Configuration"
        echo "==================================================="
        echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "Configuration Completed:"
        echo "  - RDP protocol enabled on Windows Cloud Login SP"
        echo "  - Trusted device group configured (if available)"
        echo ""
        echo "Service Principal:"
        echo "  App ID: 270efc09-cd0d-444b-a71f-39af4910ec45"
        echo "  Name: Windows Cloud Login"
        echo ""
        echo "What This Enables:"
        echo "  - Passwordless SSO for AVD connections"
        echo "  - No consent prompts for trusted device groups"
        echo "  - Seamless authentication experience"
        echo ""
        echo "Next Steps:"
        echo "  1. Configure Conditional Access policies"
        echo "  2. Test SSO with end users"
        echo "  3. Monitor authentication logs"
        echo ""
      } > "artifacts/outputs/sso-configure-service-principal.txt"

      # Cleanup
      rm -f /tmp/configure-sso-sp.ps1

      echo "[SUCCESS] Windows Cloud Login service principal configured"
      exit 0

  # Self-healing
  fixes:
    # Fixes will be added here automatically when errors occur
