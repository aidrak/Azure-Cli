# ==============================================================================
# Operation: Deploy Session Host VMs from Golden Image
# ==============================================================================
operation:
  id: "session-host-01-deploy-vms"
  name: "01: Deploy Session Host VMs"
  description: "Deploy multiple session host VMs from the golden image in the Azure Compute Gallery"

  # Duration expectations
  duration:
    expected: 900   # 15 minutes (parallel deployment)
    timeout: 1800   # 30 minutes (fail-fast if exceeds)
    type: "WAIT"    # FAST (<5min) or WAIT (10+min)

  # Prerequisites (check state.json)
  requires:
    - operation: "golden-image-validate-all"
      status: "completed"
      optional: true  # Golden image may have been created previously

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          for ($i = 1; $i -le {{SESSION_HOST_VM_COUNT}}; $i++) {
            $vmName = "{{SESSION_HOST_NAME_PREFIX}}-{0:D2}" -f $i
            az vm show --resource-group "{{AZURE_RESOURCE_GROUP}}" --name $vmName --output none 2>$null
            if ($LASTEXITCODE -ne 0) {
              Write-Host "VM not found: $vmName"
              exit 1
            }
          }
          Write-Host "All {{SESSION_HOST_VM_COUNT}} VMs verified"
          exit 0
        description: "Verify all session host VMs exist"

      - type: "powershell_command"
        command: |
          $runningCount = 0
          for ($i = 1; $i -le {{SESSION_HOST_VM_COUNT}}; $i++) {
            $vmName = "{{SESSION_HOST_NAME_PREFIX}}-{0:D2}" -f $i
            $vmState = az vm get-instance-view `
              --resource-group "{{AZURE_RESOURCE_GROUP}}" `
              --name $vmName `
              --query "instanceView.statuses[?starts_with(code, 'PowerState/')].displayStatus" `
              -o tsv 2>$null
            if ($vmState -eq "VM running") {
              $runningCount++
            }
          }
          Write-Host "Running VMs: $runningCount/{{SESSION_HOST_VM_COUNT}}"
          if ($runningCount -eq {{SESSION_HOST_VM_COUNT}}) {
            exit 0
          } else {
            exit 1
          }
        description: "Verify all session host VMs are running"

  # Template command (executed via PowerShell)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/session-host-01-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] Session Host Deployment: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $location = "{{AZURE_LOCATION}}"
      $vmPrefix = "{{SESSION_HOST_NAME_PREFIX}}"
      $vmCount = {{SESSION_HOST_VM_COUNT}}
      $vmSize = "{{SESSION_HOST_VM_SIZE}}"
      $galleryName = "{{GOLDEN_IMAGE_GALLERY_NAME}}"
      $imageDefinition = "{{GOLDEN_IMAGE_DEFINITION_NAME}}"
      $vnetName = "{{NETWORKING_VNET_NAME}}"
      $subnetName = "{{NETWORKING_SESSION_HOST_SUBNET_NAME}}"

      # Step 1: Validate Azure authentication
      Write-Host "[PROGRESS] Step 1/6: Validating Azure authentication..."
      az account show --output none 2>$null
      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Not authenticated to Azure"
        exit 1
      }

      # Step 2: Validate resource group exists
      Write-Host "[PROGRESS] Step 2/6: Validating resource group..."
      $rgExists = az group exists --name $resourceGroup 2>$null
      if ($rgExists -ne "true") {
        Write-Host "[ERROR] Resource group not found: $resourceGroup"
        exit 1
      }

      # Step 3: Get golden image ID from gallery
      Write-Host "[PROGRESS] Step 3/6: Getting golden image from gallery..."
      $imageId = az sig image-definition show `
        --resource-group $resourceGroup `
        --gallery-name $galleryName `
        --gallery-image-definition $imageDefinition `
        --query id -o tsv 2>$null

      if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrEmpty($imageId)) {
        Write-Host "[ERROR] Image definition not found: $imageDefinition in gallery $galleryName"
        Write-Host "[ERROR] Please ensure golden image was captured successfully (Module 05)"
        exit 1
      }

      Write-Host "[VALIDATE] Found image: $imageId"

      # Step 4: Get subnet ID
      Write-Host "[PROGRESS] Step 4/6: Getting subnet ID..."
      $subnetId = az network vnet subnet show `
        --resource-group $resourceGroup `
        --vnet-name $vnetName `
        --name $subnetName `
        --query id -o tsv 2>$null

      if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrEmpty($subnetId)) {
        Write-Host "[ERROR] Subnet not found: $subnetName in VNet $vnetName"
        exit 1
      }

      Write-Host "[VALIDATE] Found subnet: $subnetId"

      # Step 5: Deploy session host VMs
      Write-Host "[PROGRESS] Step 5/6: Deploying $vmCount session host VMs..."
      Write-Host "[PROGRESS] VM prefix: $vmPrefix"
      Write-Host "[PROGRESS] VM size: $vmSize"
      Write-Host "[PROGRESS] Location: $location"

      $deployedVms = @()
      $failedVms = @()

      for ($i = 1; $i -le $vmCount; $i++) {
        $vmName = "$vmPrefix-{0:D2}" -f $i

        # Check if VM already exists
        az vm show --resource-group $resourceGroup --name $vmName --output none 2>$null
        if ($LASTEXITCODE -eq 0) {
          Write-Host "[PROGRESS] VM already exists: $vmName ($i/$vmCount)"
          $deployedVms += $vmName
          continue
        }

        Write-Host "[PROGRESS] Creating VM: $vmName ($i/$vmCount)..."

        # Deploy VM from golden image
        az vm create `
          --resource-group $resourceGroup `
          --name $vmName `
          --location $location `
          --image $imageId `
          --size $vmSize `
          --subnet $subnetId `
          --admin-username "{{GOLDEN_IMAGE_ADMIN_USERNAME}}" `
          --generate-ssh-keys `
          --nsg "" `
          --public-ip-address "" `
          --os-disk-delete-option Delete `
          --data-disk-delete-option Delete `
          --nic-delete-option Delete `
          --output json > "artifacts/outputs/session-host-deploy-${vmName}.json" 2>&1

        if ($LASTEXITCODE -eq 0) {
          Write-Host "[SUCCESS] VM created: $vmName"
          $deployedVms += $vmName
        } else {
          Write-Host "[ERROR] Failed to create VM: $vmName"
          $failedVms += $vmName
        }
      }

      # Step 6: Summary
      Write-Host "[PROGRESS] Step 6/6: Deployment summary..."
      Write-Host "[VALIDATE] Successfully deployed: $($deployedVms.Count)/$vmCount"
      Write-Host "[VALIDATE] Failed: $($failedVms.Count)/$vmCount"

      if ($failedVms.Count -gt 0) {
        Write-Host "[ERROR] Failed VMs: $($failedVms -join ', ')"
        Write-Host "[ERROR] Check artifacts/outputs/ for detailed error logs"
        exit 1
      }

      # Save deployment details
      $reportContent = @"
Session Host Deployment Summary
================================
Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

Configuration:
  Resource Group: $resourceGroup
  Location: $location
  VM Count: $vmCount
  VM Size: $vmSize
  VM Prefix: $vmPrefix

Image Source:
  Gallery: $galleryName
  Definition: $imageDefinition
  Image ID: $imageId

Network:
  VNet: $vnetName
  Subnet: $subnetName

Deployed VMs:
$($deployedVms | ForEach-Object { "  - $_" })

Next Steps:
  1. Wait for VMs to fully initialize
  2. Register VMs with host pool (next operation)
  3. Verify connectivity and join status

"@
      $reportContent | Out-File -FilePath "artifacts/outputs/session-host-deploy-summary.txt" -Encoding UTF8

      Write-Host "[SUCCESS] Session host deployment completed successfully"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/session-host-01-wrapper.ps1
      rm -f /tmp/session-host-01-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
    # Example:
    # - issue: "VM creation timeout during high load"
    #   detected: "2025-12-05"
    #   fix: "Increased timeout and added retry logic"
    #   applied_to_template: true
