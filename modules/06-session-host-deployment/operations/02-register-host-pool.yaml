# ==============================================================================
# Operation: Register Session Hosts to Host Pool
# ==============================================================================
operation:
  id: "session-host-02-register-pool"
  name: "02: Register to Host Pool"
  description: "Generate registration token and prepare session hosts for host pool registration"

  # Duration expectations
  duration:
    expected: 600   # 10 minutes
    timeout: 1200   # 20 minutes (fail-fast if exceeds)
    type: "WAIT"    # FAST (<5min) or WAIT (10+min)

  # Prerequisites (check state.json)
  requires:
    - operation: "session-host-01-deploy-vms"
      status: "completed"

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          az desktopvirtualization hostpool show `
            --resource-group "{{AZURE_RESOURCE_GROUP}}" `
            --name "{{HOST_POOL_NAME}}" `
            --output none 2>$null
          if ($LASTEXITCODE -ne 0) {
            Write-Host "[ERROR] Host pool not found: {{HOST_POOL_NAME}}"
            exit 1
          }
          Write-Host "[VALIDATE] Host pool exists: {{HOST_POOL_NAME}}"
          exit 0
        description: "Verify host pool exists"

      - type: "powershell_command"
        command: |
          if (-not (Test-Path "artifacts/outputs/session-host-registration-token.txt")) {
            Write-Host "[ERROR] Registration token file not found"
            exit 1
          }
          Write-Host "[VALIDATE] Registration token saved"
          exit 0
        description: "Verify registration token was generated"

      - type: "powershell_command"
        command: |
          $runningCount = 0
          for ($i = 1; $i -le {{SESSION_HOST_VM_COUNT}}; $i++) {
            $vmName = "{{SESSION_HOST_NAME_PREFIX}}-{0:D2}" -f $i
            $vmState = az vm get-instance-view `
              --resource-group "{{AZURE_RESOURCE_GROUP}}" `
              --name $vmName `
              --query "instanceView.statuses[?starts_with(code, 'PowerState/')].displayStatus" `
              -o tsv 2>$null
            if ($vmState -eq "VM running") {
              $runningCount++
            }
          }
          Write-Host "[VALIDATE] Running VMs ready for registration: $runningCount/{{SESSION_HOST_VM_COUNT}}"
          exit 0
        description: "Verify VMs are ready for registration"

  # Template command (executed via PowerShell)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/session-host-02-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] Host Pool Registration: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $hostPoolName = "{{HOST_POOL_NAME}}"
      $vmPrefix = "{{SESSION_HOST_NAME_PREFIX}}"
      $vmCount = {{SESSION_HOST_VM_COUNT}}

      # Step 1: Validate Azure authentication
      Write-Host "[PROGRESS] Step 1/5: Validating Azure authentication..."
      az account show --output none 2>$null
      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Not authenticated to Azure"
        exit 1
      }

      # Step 2: Validate host pool exists
      Write-Host "[PROGRESS] Step 2/5: Validating host pool exists..."
      az desktopvirtualization hostpool show `
        --resource-group $resourceGroup `
        --name $hostPoolName `
        --output none 2>$null

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Host pool not found: $hostPoolName"
        Write-Host "[ERROR] Please ensure host pool was created (Module 04)"
        exit 1
      }

      Write-Host "[VALIDATE] Host pool found: $hostPoolName"

      # Get host pool resource ID
      $hpId = az desktopvirtualization hostpool show `
        --resource-group $resourceGroup `
        --name $hostPoolName `
        --query id -o tsv 2>$null

      Write-Host "[VALIDATE] Host pool ID: $hpId"

      # Step 3: Generate registration token
      Write-Host "[PROGRESS] Step 3/5: Generating host pool registration token..."

      # Calculate expiration time (24 hours from now)
      $expiration = (Get-Date).ToUniversalTime().AddHours(24).ToString('yyyy-MM-ddTHH:mm:ss.000Z')

      $tokenOutput = az desktopvirtualization hostpool update `
        --resource-group $resourceGroup `
        --name $hostPoolName `
        --registration-info "expiration-time=$expiration" "registration-token-operation=Update" `
        --output json 2>&1

      # Retrieve the registration token
      $registrationToken = az desktopvirtualization hostpool show `
        --resource-group $resourceGroup `
        --name $hostPoolName `
        --query "registrationInfo.token" -o tsv 2>$null

      if ([string]::IsNullOrEmpty($registrationToken) -or $registrationToken -eq "null") {
        Write-Host "[ERROR] Failed to generate registration token"
        Write-Host "[ERROR] Token output: $tokenOutput"
        exit 1
      }

      Write-Host "[SUCCESS] Registration token generated (valid for 24 hours)"

      # Step 4: Save token securely
      Write-Host "[PROGRESS] Step 4/5: Saving registration token..."
      $tokenFile = "artifacts/outputs/session-host-registration-token.txt"
      $registrationToken | Out-File -FilePath $tokenFile -Encoding UTF8
      icacls $tokenFile /inheritance:r /grant:r "$($env:USERNAME):(F)" | Out-Null

      Write-Host "[VALIDATE] Token saved to: $tokenFile"
      Write-Host "[WARNING] Token is sensitive - keep it secure"

      # Step 5: Verify VMs are ready
      Write-Host "[PROGRESS] Step 5/5: Verifying session host VMs..."

      $readyCount = 0
      $runningCount = 0

      for ($i = 1; $i -le $vmCount; $i++) {
        $vmName = "$vmPrefix-{0:D2}" -f $i

        az vm show `
          --resource-group $resourceGroup `
          --name $vmName `
          --output none 2>$null

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[WARNING] VM not found: $vmName"
          continue
        }

        $readyCount++

        # Check VM state
        $vmState = az vm get-instance-view `
          --resource-group $resourceGroup `
          --name $vmName `
          --query "instanceView.statuses[?starts_with(code, 'PowerState/')].displayStatus" `
          -o tsv 2>$null

        Write-Host "[PROGRESS] $vmName`: $vmState"

        if ($vmState -eq "VM running") {
          $runningCount++
        }
      }

      Write-Host "[VALIDATE] VMs found: $readyCount/$vmCount"
      Write-Host "[VALIDATE] VMs running: $runningCount/$vmCount"

      if ($readyCount -eq 0) {
        Write-Host "[ERROR] No VMs found - deployment may have failed"
        exit 1
      }

      # Save registration details
      $reportContent = "Host Pool Registration Details" + [Environment]::NewLine + "===============================" + [Environment]::NewLine + "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" + [Environment]::NewLine + [Environment]::NewLine + "Host Pool:" + [Environment]::NewLine + "  Name: $hostPoolName" + [Environment]::NewLine + "  Resource Group: $resourceGroup" + [Environment]::NewLine + "  ID: $hpId" + [Environment]::NewLine + [Environment]::NewLine + "Registration:" + [Environment]::NewLine + "  Total VMs: $vmCount" + [Environment]::NewLine + "  VMs Found: $readyCount" + [Environment]::NewLine + "  VMs Running: $runningCount" + [Environment]::NewLine + "  Token Expiration: 24 hours from generation" + [Environment]::NewLine + "  Token File: $tokenFile" + [Environment]::NewLine + [Environment]::NewLine + "Next Steps:" + [Environment]::NewLine + "  1. Install AVD agent on each session host VM" + [Environment]::NewLine + "  2. Provide registration token during installation" + [Environment]::NewLine + "  3. Complete registration process" + [Environment]::NewLine + "  4. Verify hosts appear in host pool" + [Environment]::NewLine + "  5. Test user access" + [Environment]::NewLine + [Environment]::NewLine + "Manual Registration (if needed):" + [Environment]::NewLine + "  On each session host VM, run:" + [Environment]::NewLine + "  - Download AVD Agent from: https://aka.ms/avdagent" + [Environment]::NewLine + "  - Install with registration token" + [Environment]::NewLine + "  - Complete Entra ID join if not already joined" + [Environment]::NewLine + [Environment]::NewLine + "Verify Registration:" + [Environment]::NewLine + "  az desktopvirtualization sessionhost list ``" + [Environment]::NewLine + "    --resource-group ""$resourceGroup"" ``" + [Environment]::NewLine + "    --host-pool-name ""$hostPoolName""" + [Environment]::NewLine + [Environment]::NewLine + "Token Security:" + [Environment]::NewLine + "  - Token is valid for 24 hours" + [Environment]::NewLine + "  - Store securely if using for manual registration" + [Environment]::NewLine + "  - Regenerate if token expires before registration completes"
      $reportContent | Out-File -FilePath "artifacts/outputs/session-host-registration-details.txt" -Encoding UTF8

      Write-Host "[SUCCESS] Host pool registration preparation completed"
      Write-Host ""
      Write-Host "IMPORTANT: Next Steps Required"
      Write-Host "================================"
      Write-Host "The session host VMs are deployed and a registration token has been generated."
      Write-Host ""
      Write-Host "To complete registration, you have two options:"
      Write-Host ""
      Write-Host "Option 1: Automatic (via VM extension - recommended):"
      Write-Host "  - The VMs deployed from golden image should auto-register if AVD agent is pre-installed"
      Write-Host "  - Verify by checking the host pool for registered session hosts"
      Write-Host ""
      Write-Host "Option 2: Manual (if auto-registration fails):"
      Write-Host "  - RDP into each session host VM"
      Write-Host "  - Install AVD Agent (if not already installed)"
      Write-Host "  - Provide registration token from: $tokenFile"
      Write-Host "  - Complete Entra ID join process"
      Write-Host ""
      Write-Host "Verification:"
      Write-Host "  Run: az desktopvirtualization sessionhost list \"
      Write-Host "       --resource-group '$resourceGroup' \"
      Write-Host "       --host-pool-name '$hostPoolName'"
      Write-Host ""
      Write-Host "All session hosts should show 'Available' status when ready for user connections."
      Write-Host ""

      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/session-host-02-wrapper.ps1
      rm -f /tmp/session-host-02-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
    # Example:
    # - issue: "Registration token generation timeout"
    #   detected: "2025-12-05"
    #   fix: "Added expiration-time parameter for token generation"
    #   applied_to_template: true
