# ==============================================================================
# Operation: Assign Application Group Permissions
# ==============================================================================
operation:
  id: "rbac-app-group-permissions"
  name: "Assign Application Group Permissions"
  description: "Assign Desktop Virtualization User role to application groups for both user groups"

  # Duration expectations
  duration:
    expected: 120   # 2 minutes
    timeout: 300    # 5 minutes (fail-fast if exceeds)
    type: "FAST"    # FAST (<5min) or WAIT (10+min)

  # Prerequisites (check state.json)
  requires:
    - operation: "rbac-vm-login-permissions"
      status: "completed"

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          $appGroup = Get-AzWvdApplicationGroup -ResourceGroupName "{{AZURE_RESOURCE_GROUP}}" | Select-Object -First 1

          if (-not $appGroup) {
            Write-Host "[ERROR] Application group not found"
            exit 1
          }

          $stdGroup = Get-AzADGroup -DisplayName "{{ENTRA_GROUP_USERS_STANDARD}}"

          $assignment = Get-AzRoleAssignment -ObjectId $stdGroup.Id -Scope $appGroup.Id | Where-Object { $_.RoleDefinitionName -eq 'Desktop Virtualization User' }

          if ($assignment) {
            Write-Host "[VALIDATE] Standard users have application group access"
            exit 0
          } else {
            Write-Host "[ERROR] Standard users application group access not found"
            exit 1
          }
        description: "Verify application group permissions are assigned"

  # Template command (executed via PowerShell)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/rbac-03-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] Application Group Permissions Assignment: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $appGroupName = "{{APP_GROUP_NAME}}"
      $stdGroupName = "{{ENTRA_GROUP_USERS_STANDARD}}"
      $adminGroupName = "{{ENTRA_GROUP_USERS_ADMINS}}"

      # Step 1: Validate Azure authentication
      Write-Host "[PROGRESS] Step 1/5: Validating Azure authentication..."
      az account show --output none 2>$null
      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Not authenticated to Azure"
        exit 1
      }

      # Step 2: Get application group
      Write-Host "[PROGRESS] Step 2/5: Finding application group..."

      # Initialize APP_GROUP_ID
      $appGroupId = ""

      # Try to find by configured name first
      if (-not [string]::IsNullOrEmpty($appGroupName) -and $appGroupName -ne "{{APP_GROUP_NAME}}") {
        $appGroupId = az desktopvirtualization applicationgroup show `
          --resource-group $resourceGroup `
          --name $appGroupName `
          --query id `
          --output tsv 2>$null

        if ($LASTEXITCODE -ne 0) {
          $appGroupId = ""
        }
      }

      # If not found, find first available application group
      if ([string]::IsNullOrEmpty($appGroupId) -or $appGroupId -eq "null") {
        Write-Host "[PROGRESS] Searching for application group in resource group..."
        $appGroupId = az desktopvirtualization applicationgroup list `
          --resource-group $resourceGroup `
          --query "[0].id" `
          --output tsv

        if ([string]::IsNullOrEmpty($appGroupId) -or $appGroupId -eq "null") {
          Write-Host "[ERROR] No application group found in resource group: $resourceGroup"
          Write-Host "[ERROR] Please ensure application group was created (Module 04)"
          exit 1
        }

        # Get the name from the ID
        $appGroupName = az desktopvirtualization applicationgroup list `
          --resource-group $resourceGroup `
          --query "[0].name" `
          --output tsv
      }

      Write-Host "[VALIDATE] Found application group: $appGroupName"
      Write-Host "[VALIDATE] Application group ID: $appGroupId"

      # Step 3: Get user group IDs
      Write-Host "[PROGRESS] Step 3/5: Getting user group IDs..."

      $stdGroupId = az ad group list `
        --filter "displayName eq '$stdGroupName'" `
        --query "[0].id" `
        --output tsv

      if ([string]::IsNullOrEmpty($stdGroupId) -or $stdGroupId -eq "null") {
        Write-Host "[ERROR] Standard users group not found: $stdGroupName"
        exit 1
      }

      Write-Host "[VALIDATE] Standard users group ID: $stdGroupId"

      $adminGroupId = az ad group list `
        --filter "displayName eq '$adminGroupName'" `
        --query "[0].id" `
        --output tsv

      if ([string]::IsNullOrEmpty($adminGroupId) -or $adminGroupId -eq "null") {
        Write-Host "[ERROR] Admin users group not found: $adminGroupName"
        exit 1
      }

      Write-Host "[VALIDATE] Admin users group ID: $adminGroupId"

      # Step 4: Assign application group permissions to standard users
      Write-Host "[PROGRESS] Step 4/5: Assigning application group access to standard users..."
      Write-Host "[PROGRESS] Role: Desktop Virtualization User"
      Write-Host "[PROGRESS] Group: $stdGroupName"
      Write-Host "[PROGRESS] Application Group: $appGroupName"

      az role assignment create `
        --assignee $stdGroupId `
        --role "Desktop Virtualization User" `
        --scope $appGroupId `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] Application group access assigned to standard users"
      } else {
        # Check if already exists
        $existingAssignment = az role assignment list `
          --assignee $stdGroupId `
          --scope $appGroupId `
          --query "[?roleDefinitionName=='Desktop Virtualization User']" `
          --output tsv

        if (-not [string]::IsNullOrEmpty($existingAssignment)) {
          Write-Host "[SUCCESS] Application group access already assigned to standard users"
        } else {
          Write-Host "[ERROR] Failed to assign application group access to standard users"
          exit 1
        }
      }

      # Step 5: Assign application group permissions to admin users
      Write-Host "[PROGRESS] Step 5/5: Assigning application group access to admin users..."
      Write-Host "[PROGRESS] Role: Desktop Virtualization User"
      Write-Host "[PROGRESS] Group: $adminGroupName"
      Write-Host "[PROGRESS] Application Group: $appGroupName"

      az role assignment create `
        --assignee $adminGroupId `
        --role "Desktop Virtualization User" `
        --scope $appGroupId `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] Application group access assigned to admin users"
      } else {
        # Check if already exists
        $existingAssignment = az role assignment list `
          --assignee $adminGroupId `
          --scope $appGroupId `
          --query "[?roleDefinitionName=='Desktop Virtualization User']" `
          --output tsv

        if (-not [string]::IsNullOrEmpty($existingAssignment)) {
          Write-Host "[SUCCESS] Application group access already assigned to admin users"
        } else {
          Write-Host "[ERROR] Failed to assign application group access to admin users"
          exit 1
        }
      }

      # Verify assignments
      Write-Host "[VALIDATE] Verifying application group role assignments..."

      $stdAssignments = az role assignment list `
        --assignee $stdGroupId `
        --scope $appGroupId `
        --query "[].roleDefinitionName" `
        --output tsv

      $adminAssignments = az role assignment list `
        --assignee $adminGroupId `
        --scope $appGroupId `
        --query "[].roleDefinitionName" `
        --output tsv

      Write-Host "[VALIDATE] Standard users roles: $stdAssignments"
      Write-Host "[VALIDATE] Admin users roles: $adminAssignments"

      # Save assignment details
      $reportContent = "\n" + [Environment]::NewLine + "Application Group RBAC Assignment Details" + [Environment]::NewLine + "==========================================" + [Environment]::NewLine + "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "Application Group:" + [Environment]::NewLine + "  Name: $appGroupName" + [Environment]::NewLine + "  Resource Group: $resourceGroup" + [Environment]::NewLine + "  ID: $appGroupId" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "Standard Users ($stdGroupName):" + [Environment]::NewLine + "  Group ID: $stdGroupId" + [Environment]::NewLine + "  Role: Desktop Virtualization User" + [Environment]::NewLine + "  Scope: Application Group" + [Environment]::NewLine + "  Permissions: Access to AVD desktop/applications" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "Admin Users ($adminGroupName):" + [Environment]::NewLine + "  Group ID: $adminGroupId" + [Environment]::NewLine + "  Role: Desktop Virtualization User" + [Environment]::NewLine + "  Scope: Application Group" + [Environment]::NewLine + "  Permissions: Access to AVD desktop/applications" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "Next Steps:" + [Environment]::NewLine + "  1. Verify all RBAC assignments (next operation)" + [Environment]::NewLine + "  2. Test user access to AVD desktops" + [Environment]::NewLine + "  3. Verify users can see desktops in AVD client" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "User Access Verification:" + [Environment]::NewLine + "  - Standard users should see desktop in AVD web client" + [Environment]::NewLine + "  - Admin users should have both desktop access AND admin rights on VMs" + [Environment]::NewLine + "  - Both groups should have FSLogix profiles working" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "\n"
      $reportContent | Out-File -FilePath "artifacts/outputs/rbac-app-group-permissions.txt" -Encoding UTF8

      Write-Host "[SUCCESS] Application group permissions assignment completed"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/rbac-03-wrapper.ps1
      rm -f /tmp/rbac-03-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
