# ==============================================================================
# Operation: Assign VM Login Permissions
# ==============================================================================
operation:
  id: "rbac-vm-login-permissions"
  name: "Assign VM Login Permissions"
  description: "Assign Virtual Machine login permissions to standard and admin user groups"

  # Duration expectations
  duration:
    expected: 120   # 2 minutes
    timeout: 300    # 5 minutes (fail-fast if exceeds)
    type: "FAST"    # FAST (<5min) or WAIT (10+min)

  # Prerequisites (check state.json)
  requires:
    - operation: "rbac-storage-permissions"
      status: "completed"

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          $rgId = "/subscriptions/{{AZURE_SUBSCRIPTION_ID}}/resourceGroups/{{AZURE_RESOURCE_GROUP}}"

          $stdGroup = Get-AzADGroup -DisplayName "{{ENTRA_GROUP_USERS_STANDARD}}"
          if (-not $stdGroup) {
            Write-Host "[ERROR] Standard users group not found"
            exit 1
          }

          $assignment = Get-AzRoleAssignment -ObjectId $stdGroup.Id -Scope $rgId | Where-Object { $_.RoleDefinitionName -eq 'Virtual Machine User Login' }

          if ($assignment) {
            Write-Host "[VALIDATE] Standard users have VM login permissions"
            exit 0
          } else {
            Write-Host "[ERROR] Standard users VM login permissions not found"
            exit 1
          }
        description: "Verify VM login permissions are assigned"

  # Template command (executed via PowerShell)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/rbac-02-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] VM Login Permissions Assignment: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $subscriptionId = "{{AZURE_SUBSCRIPTION_ID}}"
      $stdGroupName = "{{ENTRA_GROUP_USERS_STANDARD}}"
      $adminGroupName = "{{ENTRA_GROUP_USERS_ADMINS}}"

      # Step 1: Validate Azure authentication
      Write-Host "[PROGRESS] Step 1/5: Validating Azure authentication..."
      az account show --output none 2>$null
      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Not authenticated to Azure"
        exit 1
      }

      # Step 2: Validate resource group exists
      Write-Host "[PROGRESS] Step 2/5: Validating resource group..."
      $rgExists = az group exists --name $resourceGroup
      if ($rgExists -ne "true") {
        Write-Host "[ERROR] Resource group not found: $resourceGroup"
        exit 1
      }

      # Get resource group ID
      $rgId = az group show --name $resourceGroup --query id --output tsv
      Write-Host "[VALIDATE] Resource group ID: $rgId"

      # Step 3: Get user group IDs
      Write-Host "[PROGRESS] Step 3/5: Getting user group IDs..."

      $stdGroupId = az ad group list `
        --filter "displayName eq '$stdGroupName'" `
        --query "[0].id" `
        --output tsv

      if ([string]::IsNullOrEmpty($stdGroupId) -or $stdGroupId -eq "null") {
        Write-Host "[ERROR] Standard users group not found: $stdGroupName"
        exit 1
      }

      Write-Host "[VALIDATE] Standard users group ID: $stdGroupId"

      $adminGroupId = az ad group list `
        --filter "displayName eq '$adminGroupName'" `
        --query "[0].id" `
        --output tsv

      if ([string]::IsNullOrEmpty($adminGroupId) -or $adminGroupId -eq "null") {
        Write-Host "[ERROR] Admin users group not found: $adminGroupName"
        exit 1
      }

      Write-Host "[VALIDATE] Admin users group ID: $adminGroupId"

      # Step 4: Assign VM login permissions to standard users
      Write-Host "[PROGRESS] Step 4/5: Assigning VM login permissions to standard users..."
      Write-Host "[PROGRESS] Role: Virtual Machine User Login"
      Write-Host "[PROGRESS] Group: $stdGroupName"
      Write-Host "[PROGRESS] Scope: Resource Group ($resourceGroup)"

      az role assignment create `
        --assignee $stdGroupId `
        --role "Virtual Machine User Login" `
        --scope $rgId `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] VM login permissions assigned to standard users"
      } else {
        # Check if already exists
        $existingAssignment = az role assignment list `
          --assignee $stdGroupId `
          --scope $rgId `
          --query "[?roleDefinitionName=='Virtual Machine User Login']" `
          --output tsv

        if (-not [string]::IsNullOrEmpty($existingAssignment)) {
          Write-Host "[SUCCESS] VM login permissions already assigned to standard users"
        } else {
          Write-Host "[ERROR] Failed to assign VM login permissions to standard users"
          exit 1
        }
      }

      # Step 5: Assign VM admin login permissions to admin users
      Write-Host "[PROGRESS] Step 5/5: Assigning VM admin login permissions to admin users..."
      Write-Host "[PROGRESS] Role: Virtual Machine Administrator Login"
      Write-Host "[PROGRESS] Group: $adminGroupName"
      Write-Host "[PROGRESS] Scope: Resource Group ($resourceGroup)"

      az role assignment create `
        --assignee $adminGroupId `
        --role "Virtual Machine Administrator Login" `
        --scope $rgId `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] VM admin login permissions assigned to admin users"
      } else {
        # Check if already exists
        $existingAssignment = az role assignment list `
          --assignee $adminGroupId `
          --scope $rgId `
          --query "[?roleDefinitionName=='Virtual Machine Administrator Login']" `
          --output tsv

        if (-not [string]::IsNullOrEmpty($existingAssignment)) {
          Write-Host "[SUCCESS] VM admin login permissions already assigned to admin users"
        } else {
          Write-Host "[ERROR] Failed to assign VM admin login permissions to admin users"
          exit 1
        }
      }

      # Optional: Assign power management permissions to admin users
      Write-Host "[PROGRESS] (Optional) Assigning power management permissions to admin users..."
      Write-Host "[PROGRESS] Role: Desktop Virtualization Power On Off Contributor"

      az role assignment create `
        --assignee $adminGroupId `
        --role "Desktop Virtualization Power On Off Contributor" `
        --scope $rgId `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] Power management permissions assigned to admin users"
      } else {
        $existingAssignment = az role assignment list `
          --assignee $adminGroupId `
          --scope $rgId `
          --query "[?roleDefinitionName=='Desktop Virtualization Power On Off Contributor']" `
          --output tsv

        if (-not [string]::IsNullOrEmpty($existingAssignment)) {
          Write-Host "[SUCCESS] Power management permissions already assigned to admin users"
        } else {
          Write-Host "[WARNING] Failed to assign power management permissions (optional)"
        }
      }

      # Verify assignments
      Write-Host "[VALIDATE] Verifying VM login role assignments..."

      $stdAssignments = az role assignment list `
        --assignee $stdGroupId `
        --scope $rgId `
        --query "[?contains(roleDefinitionName, 'Virtual Machine')].roleDefinitionName" `
        --output tsv

      $adminAssignments = az role assignment list `
        --assignee $adminGroupId `
        --scope $rgId `
        --query "[?contains(roleDefinitionName, 'Virtual Machine') || contains(roleDefinitionName, 'Desktop Virtualization')].roleDefinitionName" `
        --output tsv

      Write-Host "[VALIDATE] Standard users roles:"
      foreach ($role in $stdAssignments) {
        Write-Host "  - $role"
      }

      Write-Host "[VALIDATE] Admin users roles:"
      foreach ($role in $adminAssignments) {
        Write-Host "  - $role"
      }

      # Save assignment details
      $reportContent = @"
VM Login RBAC Assignment Details
=================================
Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

Resource Group:
  Name: $resourceGroup
  ID: $rgId

Standard Users ($stdGroupName):
  Group ID: $stdGroupId
  Role: Virtual Machine User Login
  Scope: Resource Group
  Permissions: Standard user login to session hosts (no admin rights)

Admin Users ($adminGroupName):
  Group ID: $adminGroupId
  Roles:
    - Virtual Machine Administrator Login
    - Desktop Virtualization Power On Off Contributor (optional)
  Scope: Resource Group
  Permissions:
    - Admin login to session hosts with local admin rights
    - Manage session host power state

Next Steps:
  1. Assign application group permissions (next operation)
  2. Test user login to session hosts
  3. Verify admin users have elevated access

"@
      $reportContent | Out-File -FilePath "artifacts/outputs/rbac-vm-login-permissions.txt" -Encoding UTF8

      Write-Host "[SUCCESS] VM login permissions assignment completed"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/rbac-02-wrapper.ps1
      rm -f /tmp/rbac-02-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
