# ==============================================================================
# Operation: Validate Resource Group
# ==============================================================================
operation:
  id: "resource-group-validate"
  name: "Validate Resource Group"
  description: "Verify resource group is accessible and properly configured"

  # Duration estimates
  duration:
    expected: 15
    timeout: 30
    type: "FAST"

  # Prerequisites
  prerequisites:
    required:
      - operation: "resource-group-create"
        status: "completed"

  # Template
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/rg-02-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] Resource group validation: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"

      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $expectedLocation = "{{AZURE_LOCATION}}"

      Write-Host "[PROGRESS] Validating resource group: $resourceGroup"

      # Check if resource group exists
      $rgInfoJson = az group show --name $resourceGroup --output json 2>$null

      if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrEmpty($rgInfoJson)) {
        Write-Host "[ERROR] Resource group not found: $resourceGroup"
        exit 1
      }

      # Extract details
      $rgInfo = $rgInfoJson | ConvertFrom-Json
      $actualLocation = $rgInfo.location
      $provisioningState = $rgInfo.properties.provisioningState
      $rgId = $rgInfo.id

      Write-Host "[VALIDATE] Resource Group ID: $rgId"
      Write-Host "[VALIDATE] Location: $actualLocation (expected: $expectedLocation)"
      Write-Host "[VALIDATE] Provisioning State: $provisioningState"

      # Validate provisioning state
      if ($provisioningState -ne "Succeeded") {
        Write-Host "[ERROR] Resource group is not in 'Succeeded' state"
        Write-Host "[ERROR] Current state: $provisioningState"
        exit 1
      }

      # Validate location (warning only if different)
      if ($actualLocation -ne $expectedLocation) {
        Write-Host "[WARNING] Location mismatch (using existing location)"
        Write-Host "[WARNING]   Expected: $expectedLocation"
        Write-Host "[WARNING]   Actual: $actualLocation"
      }

      # Check permissions (try to list resources)
      Write-Host "[VALIDATE] Checking permissions..."
      $resourceList = az resource list --resource-group $resourceGroup --output json 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] Resource group is accessible and ready"
      } else {
        Write-Host "[ERROR] Cannot list resources in resource group (permission issue?)"
        exit 1
      }

      Write-Host "[SUCCESS] Resource group validation complete"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/rg-02-wrapper.ps1
      rm -f /tmp/rg-02-wrapper.ps1

  # Validation
  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "Microsoft.Resources/resourceGroups"
        resource_name: "{{AZURE_RESOURCE_GROUP}}"

  # Fixes (populated by error handler)
  fixes: []
