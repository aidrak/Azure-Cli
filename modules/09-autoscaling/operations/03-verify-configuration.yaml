# ==============================================================================
# Operation: Verify Autoscaling Configuration
# ==============================================================================
operation:
  id: "autoscaling-verify-configuration"
  name: "Verify Autoscaling Configuration"
  description: "Verify autoscaling plan is properly configured and assigned to host pool"

  # Duration expectations
  duration:
    expected: 60    # 1 minute
    timeout: 180    # 3 minutes (fail-fast if exceeds)
    type: "FAST"    # FAST (<5min) or WAIT (10+min)

  # Prerequisites (check state.json)
  requires:
    - operation: "autoscaling-create-plan"
      status: "completed"

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          if (Test-Path "artifacts/outputs/autoscaling-verification-complete.txt") {
            Write-Host "[VALIDATE] Autoscaling verification completed"
            exit 0
          } else {
            Write-Host "[ERROR] Autoscaling verification file not found"
            exit 1
          }
        description: "Verify autoscaling verification completed"

  # Template command (executed via PowerShell)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/autoscaling-03-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] Autoscaling Configuration Verification: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $hostPoolName = "{{HOST_POOL_NAME}}"
      $subscriptionId = "{{AZURE_SUBSCRIPTION_ID}}"
      $autoscalingEnabled = "{{AUTOSCALING_ENABLED}}"

      # Scaling plan name
      $scalingPlanName = "ScalingPlan-$hostPoolName"

      # Counters
      $totalChecks = 0
      $passedChecks = 0
      $failedChecks = 0
      $warningChecks = 0

      # Step 1: Validate Azure authentication
      Write-Host "[PROGRESS] Step 1/4: Validating Azure authentication..."
      az account show --output none 2>$null
      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Not authenticated to Azure"
        exit 1
      }

      # Step 2: Check if autoscaling is enabled in config
      Write-Host "[PROGRESS] Step 2/4: Checking autoscaling configuration..."
      if ($autoscalingEnabled -ne "true") {
        Write-Host "[WARNING] Autoscaling is disabled in configuration"
        Write-Host "[WARNING] Skipping verification"

        $reportContent = @"
Autoscaling Verification Skipped
=================================
Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

Autoscaling is disabled in configuration.

"@
        $reportContent | Out-File -FilePath "artifacts/outputs/autoscaling-verification-complete.txt" -Encoding UTF8
        exit 0
      }

      # Step 3: Verify autoscaling configuration
      Write-Host "[PROGRESS] Step 3/4: Verifying autoscaling configuration..."

      # Check if host pool exists
      $totalChecks++
      az desktopvirtualization hostpool show `
        --resource-group $resourceGroup `
        --name $hostPoolName `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] ✓ Host pool exists: $hostPoolName"
        $passedChecks++
      } else {
        Write-Host "[ERROR] ✗ Host pool not found: $hostPoolName"
        $failedChecks++
      }

      # Check if scaling plan exists
      $totalChecks++
      az desktopvirtualization scaling-plan show `
        --resource-group $resourceGroup `
        --name $scalingPlanName `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] ✓ Scaling plan exists: $scalingPlanName"
        $passedChecks++
      } else {
        Write-Host "[ERROR] ✗ Scaling plan not found: $scalingPlanName"
        $failedChecks++
      }

      # Check RBAC role assignment
      $totalChecks++
      Write-Host "[PROGRESS] Checking RBAC assignments..."

      $avdSpId = az ad sp list --filter "displayName eq 'Azure Virtual Desktop'" --query "[0].id" -o tsv 2>$null

      if ($LASTEXITCODE -ne 0) {
        $avdSpId = ""
      }

      if (-not [string]::IsNullOrEmpty($avdSpId) -and $avdSpId -ne "null") {
        $subscriptionScope = "/subscriptions/$subscriptionId"

        $roleAssignment = az role assignment list `
          --assignee $avdSpId `
          --scope $subscriptionScope `
          --query "[?roleDefinitionName=='Desktop Virtualization Power On Off Contributor']" -o tsv 2>$null

        if ($roleAssignment -match "Desktop") {
          Write-Host "[SUCCESS] ✓ RBAC role assigned to AVD service principal"
          $passedChecks++
        } else {
          Write-Host "[WARNING] ⚠ RBAC role not found (may need manual assignment)"
          $warningChecks++
        }
      } else {
        Write-Host "[WARNING] ⚠ Azure Virtual Desktop service principal not found"
        $warningChecks++
      }

      # Check session hosts exist
      $totalChecks++
      $sessionHostCount = az desktopvirtualization sessionhost list `
        --resource-group $resourceGroup `
        --host-pool-name $hostPoolName `
        --query "length(@)" -o tsv 2>$null

      if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrEmpty($sessionHostCount)) {
        $sessionHostCount = "0"
      }

      if ([int]$sessionHostCount -gt 0) {
        Write-Host "[SUCCESS] ✓ Session hosts exist: $sessionHostCount host(s)"
        $passedChecks++
      } else {
        Write-Host "[WARNING] ⚠ No session hosts found (autoscaling will have no VMs to manage)"
        $warningChecks++
      }

      # Step 4: Summary
      Write-Host "[PROGRESS] Step 4/4: Generating verification summary..."
      Write-Host ""
      Write-Host "=========================================="
      Write-Host "AUTOSCALING VERIFICATION SUMMARY"
      Write-Host "=========================================="
      Write-Host "Total Checks: $totalChecks"
      Write-Host "Passed: $passedChecks"
      Write-Host "Failed: $failedChecks"
      Write-Host "Warnings: $warningChecks"
      Write-Host "=========================================="

      # Determine overall status
      if ($failedChecks -eq 0) {
        Write-Host "[SUCCESS] Autoscaling configuration verification passed!"
        $verificationStatus = "PASSED"
        $exitCode = 0
      } else {
        Write-Host "[ERROR] Some autoscaling configuration checks failed"
        Write-Host "[ERROR] Please review the failed checks above"
        $verificationStatus = "FAILED"
        $exitCode = 1
      }

      # Save detailed verification report
      $reportContent = @"
Autoscaling Configuration Verification Report
==============================================
Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

Overall Status: $verificationStatus

Summary:
  Total Checks: $totalChecks
  Passed: $passedChecks
  Failed: $failedChecks
  Warnings: $warningChecks

Host Pool: $hostPoolName
Scaling Plan: $scalingPlanName
Resource Group: $resourceGroup

Automated Checks:
  1. Host pool exists
  2. Scaling plan exists
  3. RBAC role assigned (Desktop Virtualization Power On Off Contributor)
  4. Session hosts registered

Manual Configuration Required:
==============================

The scaling plan was created but schedules must be configured manually:

1. Configure Scaling Schedules (via Azure Portal)
   - Navigate to: Azure Virtual Desktop → Scaling plans
   - Select: $scalingPlanName
   - Click: 'Schedules' → '+ Add schedule'

   Recommended Weekday Schedule:
     - Ramp-Up: 07:00 AM (BreadthFirst, 20-25% min hosts, 70% capacity)
     - Peak: 09:00 AM - 05:00 PM (BreadthFirst, 70% capacity)
     - Ramp-Down: 05:00 PM (DepthFirst, 10% min hosts, 80% capacity)
     - Off-Peak: 07:00 PM (DepthFirst, 5% min hosts, 90% capacity)

   Recommended Weekend Schedule:
     - Off-Peak 24/7 (DepthFirst, 5% min hosts, 85% capacity)

2. Test Autoscaling Behavior
   - Monitor session host power states
   - Verify VMs power on/off according to schedule
   - Check scaling behavior during different load scenarios

3. Monitor and Adjust
   - Review Azure Activity Log for scaling events
   - Check host pool Insights tab for metrics
   - Adjust thresholds based on usage patterns

Expected Behavior:
==================

Ramp-Up Phase:
  - VMs power on 10-15 minutes before users arrive
  - Minimum percentage of hosts powered on
  - Additional VMs start based on capacity threshold

Peak Hours:
  - Scale up/down based on session load
  - Capacity threshold determines when to start new VMs
  - Load balancing distributes sessions

Ramp-Down Phase:
  - Depth-first balancing consolidates sessions
  - Lightly-loaded hosts drain and shut down
  - Users receive warning before forced logoff

Off-Peak Hours:
  - Only minimum hosts remain powered on
  - Significant cost savings (60-75%)
  - Weekend: Minimum hosts only

Cost Optimization:
==================

Typical Savings:
  - Without autoscaling: 100% VM uptime = High cost
  - With autoscaling: 25-40% average uptime = 60-75% savings

Example (40 VMs × `$1/hour):
  - Before: 40 VMs × 24h × 30d = `$28,800/month
  - After: ~8-12 VMs average × 24h × 30d = `$7,000-9,000/month
  - Savings: ~`$20,000/month (65-75%)

Troubleshooting:
================

Issue: VMs not powering on/off
  - Verify RBAC role assigned
  - Check scaling plan is enabled
  - Verify schedules are configured
  - Wait 15-20 minutes for first cycle
  - Review Azure Activity Log for errors

Issue: Too many/few VMs running
  - Adjust capacity thresholds
  - Change minimum host percentages
  - Review session load patterns
  - Modify schedule times

Issue: Users complaining about forced logoff
  - Increase wait time (20→30 minutes)
  - Adjust ramp-down start time
  - Customize notification message
  - Consider excluding certain users

"@

      if ($failedChecks -gt 0) {
        $reportContent += @"
Action Required:
  Review failed checks above and re-run autoscaling configuration operations

"@
      }

      $reportContent | Out-File -FilePath "artifacts/outputs/autoscaling-verification-complete.txt" -Encoding UTF8

      if ($exitCode -eq 0) {
        Write-Host "[SUCCESS] Autoscaling verification completed successfully"
        Write-Host ""
        Write-Host "Next Steps:"
        Write-Host "  1. Configure scaling schedules in Azure Portal"
        Write-Host "  2. Monitor autoscaling activity for 1 week"
        Write-Host "  3. Adjust schedules based on usage patterns"
        Write-Host "  4. Review cost savings in Azure Cost Management"
        Write-Host ""
      } else {
        Write-Host "[ERROR] Autoscaling verification failed - see report for details"
      }

      exit $exitCode
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/autoscaling-03-wrapper.ps1
      rm -f /tmp/autoscaling-03-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
