# ==============================================================================
# Operation: Verify Autoscaling Configuration
# ==============================================================================
operation:
  id: "autoscaling-verify-configuration"
  name: "Verify Autoscaling Configuration"
  description: "Verify autoscaling plan is properly configured and assigned to host pool"

  # Duration expectations
  duration:
    expected: 60    # 1 minute
    timeout: 180    # 3 minutes (fail-fast if exceeds)
    type: "FAST"    # FAST (<5min) or WAIT (10+min)

  # Prerequisites (check state.json)
  requires:
    - operation: "autoscaling-create-plan"
      status: "completed"

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          if (Test-Path "artifacts/outputs/autoscaling-verification-complete.txt") {
            Write-Host "[VALIDATE] Autoscaling verification completed"
            exit 0
          } else {
            Write-Host "[ERROR] Autoscaling verification file not found"
            exit 1
          }
        description: "Verify autoscaling verification completed"

  # Template command (executed via PowerShell)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/autoscaling-03-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] Autoscaling Configuration Verification: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $hostPoolName = "{{HOST_POOL_NAME}}"
      $subscriptionId = "{{AZURE_SUBSCRIPTION_ID}}"
      $autoscalingEnabled = "{{AUTOSCALING_ENABLED}}"

      # Scaling plan name
      $scalingPlanName = "ScalingPlan-$hostPoolName"

      # Counters
      $totalChecks = 0
      $passedChecks = 0
      $failedChecks = 0
      $warningChecks = 0

      # Step 1: Validate Azure authentication
      Write-Host "[PROGRESS] Step 1/4: Validating Azure authentication..."
      az account show --output none 2>$null
      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Not authenticated to Azure"
        exit 1
      }

      # Step 2: Check if autoscaling is enabled in config
      Write-Host "[PROGRESS] Step 2/4: Checking autoscaling configuration..."
      if ($autoscalingEnabled -ne "true") {
        Write-Host "[WARNING] Autoscaling is disabled in configuration"
        Write-Host "[WARNING] Skipping verification"

        $reportContent = @"
Autoscaling Verification Skipped
=================================
Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

Autoscaling is disabled in configuration.

"@
        $reportContent | Out-File -FilePath "artifacts/outputs/autoscaling-verification-complete.txt" -Encoding UTF8
        exit 0
      }

      # Step 3: Verify autoscaling configuration
      Write-Host "[PROGRESS] Step 3/4: Verifying autoscaling configuration..."

      # Check if host pool exists
      $totalChecks++
      az desktopvirtualization hostpool show `
        --resource-group $resourceGroup `
        --name $hostPoolName `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] ✓ Host pool exists: $hostPoolName"
        $passedChecks++
      } else {
        Write-Host "[ERROR] ✗ Host pool not found: $hostPoolName"
        $failedChecks++
      }

      # Check if scaling plan exists
      $totalChecks++
      az desktopvirtualization scaling-plan show `
        --resource-group $resourceGroup `
        --name $scalingPlanName `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] ✓ Scaling plan exists: $scalingPlanName"
        $passedChecks++
      } else {
        Write-Host "[ERROR] ✗ Scaling plan not found: $scalingPlanName"
        $failedChecks++
      }

      # Check RBAC role assignment
      $totalChecks++
      Write-Host "[PROGRESS] Checking RBAC assignments..."

      $avdSpId = az ad sp list --filter "displayName eq 'Azure Virtual Desktop'" --query "[0].id" -o tsv 2>$null

      if ($LASTEXITCODE -ne 0) {
        $avdSpId = ""
      }

      if (-not [string]::IsNullOrEmpty($avdSpId) -and $avdSpId -ne "null") {
        $subscriptionScope = "/subscriptions/$subscriptionId"

        $roleAssignment = az role assignment list `
          --assignee $avdSpId `
          --scope $subscriptionScope `
          --query "[?roleDefinitionName=='Desktop Virtualization Power On Off Contributor']" -o tsv 2>$null

        if ($roleAssignment -match "Desktop") {
          Write-Host "[SUCCESS] ✓ RBAC role assigned to AVD service principal"
          $passedChecks++
        } else {
          Write-Host "[WARNING] ⚠ RBAC role not found (may need manual assignment)"
          $warningChecks++
        }
      } else {
        Write-Host "[WARNING] ⚠ Azure Virtual Desktop service principal not found"
        $warningChecks++
      }

      # Check session hosts exist
      $totalChecks++
      $sessionHostCount = az desktopvirtualization sessionhost list `
        --resource-group $resourceGroup `
        --host-pool-name $hostPoolName `
        --query "length(@)" -o tsv 2>$null

      if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrEmpty($sessionHostCount)) {
        $sessionHostCount = "0"
      }

      if ([int]$sessionHostCount -gt 0) {
        Write-Host "[SUCCESS] ✓ Session hosts exist: $sessionHostCount host(s)"
        $passedChecks++
      } else {
        Write-Host "[WARNING] ⚠ No session hosts found (autoscaling will have no VMs to manage)"
        $warningChecks++
      }

      # Step 4: Summary
      Write-Host "[PROGRESS] Step 4/4: Generating verification summary..."
      Write-Host ""
      Write-Host "=========================================="
      Write-Host "AUTOSCALING VERIFICATION SUMMARY"
      Write-Host "=========================================="
      Write-Host "Total Checks: $totalChecks"
      Write-Host "Passed: $passedChecks"
      Write-Host "Failed: $failedChecks"
      Write-Host "Warnings: $warningChecks"
      Write-Host "=========================================="

      # Determine overall status
      if ($failedChecks -eq 0) {
        Write-Host "[SUCCESS] Autoscaling configuration verification passed!"
        $verificationStatus = "PASSED"
        $exitCode = 0
      } else {
        Write-Host "[ERROR] Some autoscaling configuration checks failed"
        Write-Host "[ERROR] Please review the failed checks above"
        $verificationStatus = "FAILED"
        $exitCode = 1
      }

      # Save detailed verification report
      {
        echo "Autoscaling Configuration Verification Report"
        echo "=============================================="
        echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "Overall Status: $VERIFICATION_STATUS"
        echo ""
        echo "Summary:"
        echo "  Total Checks: $TOTAL_CHECKS"
        echo "  Passed: $PASSED_CHECKS"
        echo "  Failed: $FAILED_CHECKS"
        echo "  Warnings: $WARNING_CHECKS"
        echo ""
        echo "Host Pool: $HOST_POOL_NAME"
        echo "Scaling Plan: $SCALING_PLAN_NAME"
        echo "Resource Group: $RESOURCE_GROUP"
        echo ""
        echo "Automated Checks:"
        echo "  1. Host pool exists"
        echo "  2. Scaling plan exists"
        echo "  3. RBAC role assigned (Desktop Virtualization Power On Off Contributor)"
        echo "  4. Session hosts registered"
        echo ""
        echo "Manual Configuration Required:"
        echo "=============================="
        echo ""
        echo "The scaling plan was created but schedules must be configured manually:"
        echo ""
        echo "1. Configure Scaling Schedules (via Azure Portal)"
        echo "   - Navigate to: Azure Virtual Desktop → Scaling plans"
        echo "   - Select: $SCALING_PLAN_NAME"
        echo "   - Click: 'Schedules' → '+ Add schedule'"
        echo ""
        echo "   Recommended Weekday Schedule:"
        echo "     - Ramp-Up: 07:00 AM (BreadthFirst, 20-25% min hosts, 70% capacity)"
        echo "     - Peak: 09:00 AM - 05:00 PM (BreadthFirst, 70% capacity)"
        echo "     - Ramp-Down: 05:00 PM (DepthFirst, 10% min hosts, 80% capacity)"
        echo "     - Off-Peak: 07:00 PM (DepthFirst, 5% min hosts, 90% capacity)"
        echo ""
        echo "   Recommended Weekend Schedule:"
        echo "     - Off-Peak 24/7 (DepthFirst, 5% min hosts, 85% capacity)"
        echo ""
        echo "2. Test Autoscaling Behavior"
        echo "   - Monitor session host power states"
        echo "   - Verify VMs power on/off according to schedule"
        echo "   - Check scaling behavior during different load scenarios"
        echo ""
        echo "3. Monitor and Adjust"
        echo "   - Review Azure Activity Log for scaling events"
        echo "   - Check host pool Insights tab for metrics"
        echo "   - Adjust thresholds based on usage patterns"
        echo ""
        echo "Expected Behavior:"
        echo "=================="
        echo ""
        echo "Ramp-Up Phase:"
        echo "  - VMs power on 10-15 minutes before users arrive"
        echo "  - Minimum percentage of hosts powered on"
        echo "  - Additional VMs start based on capacity threshold"
        echo ""
        echo "Peak Hours:"
        echo "  - Scale up/down based on session load"
        echo "  - Capacity threshold determines when to start new VMs"
        echo "  - Load balancing distributes sessions"
        echo ""
        echo "Ramp-Down Phase:"
        echo "  - Depth-first balancing consolidates sessions"
        echo "  - Lightly-loaded hosts drain and shut down"
        echo "  - Users receive warning before forced logoff"
        echo ""
        echo "Off-Peak Hours:"
        echo "  - Only minimum hosts remain powered on"
        echo "  - Significant cost savings (60-75%)"
        echo "  - Weekend: Minimum hosts only"
        echo ""
        echo "Cost Optimization:"
        echo "=================="
        echo ""
        echo "Typical Savings:"
        echo "  - Without autoscaling: 100% VM uptime = High cost"
        echo "  - With autoscaling: 25-40% average uptime = 60-75% savings"
        echo ""
        echo "Example (40 VMs × \$1/hour):"
        echo "  - Before: 40 VMs × 24h × 30d = \$28,800/month"
        echo "  - After: ~8-12 VMs average × 24h × 30d = \$7,000-9,000/month"
        echo "  - Savings: ~\$20,000/month (65-75%)"
        echo ""
        echo "Troubleshooting:"
        echo "================"
        echo ""
        echo "Issue: VMs not powering on/off"
        echo "  - Verify RBAC role assigned"
        echo "  - Check scaling plan is enabled"
        echo "  - Verify schedules are configured"
        echo "  - Wait 15-20 minutes for first cycle"
        echo "  - Review Azure Activity Log for errors"
        echo ""
        echo "Issue: Too many/few VMs running"
        echo "  - Adjust capacity thresholds"
        echo "  - Change minimum host percentages"
        echo "  - Review session load patterns"
        echo "  - Modify schedule times"
        echo ""
        echo "Issue: Users complaining about forced logoff"
        echo "  - Increase wait time (20→30 minutes)"
        echo "  - Adjust ramp-down start time"
        echo "  - Customize notification message"
        echo "  - Consider excluding certain users"
        echo ""
        if [[ $FAILED_CHECKS -gt 0 ]]; then
          echo "Action Required:"
          echo "  Review failed checks above and re-run autoscaling configuration operations"
          echo ""
        fi
      } > "artifacts/outputs/autoscaling-verification-complete.txt"

      if [[ $EXIT_CODE -eq 0 ]]; then
        echo "[SUCCESS] Autoscaling verification completed successfully"
        echo ""
        echo "Next Steps:"
        echo "  1. Configure scaling schedules in Azure Portal"
        echo "  2. Monitor autoscaling activity for 1 week"
        echo "  3. Adjust schedules based on usage patterns"
        echo "  4. Review cost savings in Azure Cost Management"
        echo ""
      else
        echo "[ERROR] Autoscaling verification failed - see report for details"
      fi

      exit $EXIT_CODE

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
