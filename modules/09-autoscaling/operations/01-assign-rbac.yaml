# ==============================================================================
# Operation: Assign Autoscaling RBAC Role
# ==============================================================================
operation:
  id: "autoscaling-assign-rbac"
  name: "Assign Autoscaling RBAC Role"
  description: "Assign Desktop Virtualization Power On Off Contributor role to Azure Virtual Desktop service principal"

  # Duration expectations
  duration:
    expected: 120   # 2 minutes
    timeout: 300    # 5 minutes (fail-fast if exceeds)
    type: "FAST"    # FAST (<5min) or WAIT (10+min)

  # Prerequisites (check state.json)
  requires:
    - operation: "session-host-deploy-vms"
      status: "completed"
      optional: true  # Session hosts may have been deployed previously

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          $subscriptionId = az account show --query id -o tsv
          $scope = "/subscriptions/$subscriptionId"

          # Get AVD service principal
          $avdSpId = az ad sp list --filter "displayName eq 'Azure Virtual Desktop'" --query "[0].id" -o tsv 2>$null

          if ([string]::IsNullOrEmpty($avdSpId) -or $avdSpId -eq "null") {
            Write-Host "[WARNING] Azure Virtual Desktop service principal not found"
            exit 0
          }

          # Check role assignment
          $roleAssignment = az role assignment list `
            --assignee $avdSpId `
            --scope $scope `
            --query "[?roleDefinitionName=='Desktop Virtualization Power On Off Contributor']" -o tsv 2>$null

          if ($roleAssignment -match "Desktop") {
            Write-Host "[VALIDATE] RBAC role assigned to AVD service principal"
            exit 0
          } else {
            Write-Host "[WARNING] RBAC role not found (may need manual assignment)"
            exit 0
          }
        description: "Verify RBAC role assigned"

  # Template command (executed via PowerShell)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/autoscaling-01-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] Autoscaling RBAC Assignment: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $autoscalingEnabled = "{{AUTOSCALING_ENABLED}}"

      # Step 1: Validate Azure authentication
      Write-Host "[PROGRESS] Step 1/5: Validating Azure authentication..."
      az account show --output none 2>$null
      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Not authenticated to Azure"
        exit 1
      }

      # Step 2: Check if autoscaling is enabled in config
      Write-Host "[PROGRESS] Step 2/5: Checking autoscaling configuration..."
      if ($autoscalingEnabled -ne "true") {
        Write-Host "[WARNING] Autoscaling is disabled in config.yaml (autoscaling.enabled: false)"
        Write-Host "[WARNING] Skipping RBAC assignment"

        $reportContent = @"
Autoscaling RBAC Assignment Skipped
====================================
Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

Autoscaling is disabled in configuration.
To enable autoscaling, set autoscaling.enabled: true in config.yaml

"@
        $reportContent | Out-File -FilePath "artifacts/outputs/autoscaling-assign-rbac.txt" -Encoding UTF8
        exit 0
      }

      # Step 3: Get subscription ID
      Write-Host "[PROGRESS] Step 3/5: Getting subscription ID..."
      $subscriptionId = az account show --query id -o tsv
      $subscriptionScope = "/subscriptions/$subscriptionId"

      Write-Host "[VALIDATE] Subscription ID: $subscriptionId"
      Write-Host "[VALIDATE] Scope: $subscriptionScope"

      # Step 4: Find Azure Virtual Desktop service principal
      Write-Host "[PROGRESS] Step 4/5: Finding Azure Virtual Desktop service principal..."

      $avdSpId = az ad sp list `
        --filter "displayName eq 'Azure Virtual Desktop'" `
        --query "[0].id" -o tsv 2>$null

      if ($LASTEXITCODE -ne 0) {
        $avdSpId = ""
      }

      if ([string]::IsNullOrEmpty($avdSpId) -or $avdSpId -eq "null") {
        Write-Host "[WARNING] Azure Virtual Desktop service principal not found"
        Write-Host "[WARNING] This service principal may not exist in your tenant"
        Write-Host "[WARNING] You may need to manually assign the role via Azure Portal"

        $reportContent = @"
Autoscaling RBAC Assignment - Manual Required
==============================================
Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

The Azure Virtual Desktop service principal was not found.

Manual Assignment Required:
  1. Navigate to Azure Portal → Subscriptions
  2. Select your subscription: $subscriptionId
  3. Go to Access Control (IAM)
  4. Click '+ Add' → 'Add role assignment'
  5. Role: 'Desktop Virtualization Power On Off Contributor'
  6. Assign to: 'Managed identity'
  7. Select: 'Azure Virtual Desktop' service principal
  8. Review + assign

Alternative: Use PowerShell
  Connect-AzAccount
  `$avdSp = Get-AzADServicePrincipal -DisplayName 'Azure Virtual Desktop'
  New-AzRoleAssignment -ObjectId `$avdSp.Id -RoleDefinitionName 'Desktop Virtualization Power On Off Contributor' -Scope '/subscriptions/$subscriptionId'

"@
        $reportContent | Out-File -FilePath "artifacts/outputs/autoscaling-assign-rbac.txt" -Encoding UTF8
        exit 0
      }

      Write-Host "[VALIDATE] Azure Virtual Desktop service principal found: $avdSpId"

      # Step 5: Assign role
      Write-Host "[PROGRESS] Step 5/5: Assigning RBAC role..."
      Write-Host "[PROGRESS] Role: Desktop Virtualization Power On Off Contributor"
      Write-Host "[PROGRESS] Assignee: Azure Virtual Desktop (service principal)"
      Write-Host "[PROGRESS] Scope: Subscription"

      az role assignment create `
        --assignee $avdSpId `
        --role "Desktop Virtualization Power On Off Contributor" `
        --scope $subscriptionScope `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] RBAC role assigned to AVD service principal"
      } else {
        # Check if already exists
        $existingAssignment = az role assignment list `
          --assignee $avdSpId `
          --scope $subscriptionScope `
          --query "[?roleDefinitionName=='Desktop Virtualization Power On Off Contributor']" -o tsv 2>$null

        if ($existingAssignment -match "Desktop") {
          Write-Host "[SUCCESS] RBAC role already assigned to AVD service principal"
        } else {
          Write-Host "[ERROR] Failed to assign RBAC role"
          Write-Host "[ERROR] You may need to manually assign the role via Azure Portal"
          exit 1
        }
      }

      # Verify assignment
      Write-Host "[VALIDATE] Verifying role assignment..."
      $roleAssignment = az role assignment list `
        --assignee $avdSpId `
        --scope $subscriptionScope `
        --query "[?roleDefinitionName=='Desktop Virtualization Power On Off Contributor'].roleDefinitionName" -o tsv

      Write-Host "[VALIDATE] Role assignment: $roleAssignment"

      # Save assignment details
      $reportContent = @"
Autoscaling RBAC Assignment
===========================
Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

Service Principal:
  Name: Azure Virtual Desktop
  ID: $avdSpId

Role Assignment:
  Role: Desktop Virtualization Power On Off Contributor
  Scope: Subscription ($subscriptionId)

What This Enables:
  - AVD service can power on/off session host VMs
  - Required for autoscaling functionality
  - Scaling plan can manage VM power states

Next Steps:
  1. Create scaling plan (next operation)
  2. Configure scaling schedules
  3. Assign scaling plan to host pool
  4. Monitor autoscaling activity

"@
      $reportContent | Out-File -FilePath "artifacts/outputs/autoscaling-assign-rbac.txt" -Encoding UTF8

      Write-Host "[SUCCESS] Autoscaling RBAC assignment completed"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/autoscaling-01-wrapper.ps1
      rm -f /tmp/autoscaling-01-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
