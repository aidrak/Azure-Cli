# ==============================================================================
# Operation: Create Network Security Groups
# ==============================================================================
operation:
  id: "networking-create-nsgs"
  name: "Create Network Security Groups"
  description: "Create NSGs for each subnet where enabled (auto-generate names)"

  # Duration expectations
  duration:
    expected: 120   # 2 minutes
    timeout: 240    # 4 minutes
    type: "FAST"

  # Prerequisites
  requires:
    - "networking-create-subnets"  # Subnets must exist first

  # Validation checks
  validation:
    enabled: true
    checks:
      - type: "nsg_count"
        min_count: 1
        description: "At least one NSG created"

  # Template command
  # NOTE: Uses bash heredoc to pass PowerShell script safely to pwsh
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/networking-03-create-nsgs-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] NSG creation: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $location = "{{AZURE_LOCATION}}"

      # Get subnet count
      $subnetCount = [int](yq e '.networking.subnets | length' config.yaml)
      $nsgCount = 0

      Write-Host "[PROGRESS] Processing $subnetCount subnet(s) for NSG creation..."

      # Iterate through subnets
      for ($i = 0; $i -lt $subnetCount; $i++) {
        # Check if NSG enabled for this subnet
        $nsgEnabled = (yq e ".networking.subnets[$i].nsg.enabled" config.yaml)

        if ($nsgEnabled -ne "true") {
          continue
        }

        # Get subnet name
        $subnetName = (yq e ".networking.subnets[$i].name" config.yaml)

        # Get or auto-generate NSG name
        $nsgName = (yq e ".networking.subnets[$i].nsg.name" config.yaml)

        # Auto-generate if empty
        if ([string]::IsNullOrEmpty($nsgName) -or $nsgName -eq "null") {
          $nsgName = "nsg-$subnetName"
        }

        Write-Host "[PROGRESS] Processing NSG for subnet: $subnetName"
        Write-Host "[PROGRESS]   NSG name: $nsgName"

        # Check if NSG already exists (idempotent)
        az network nsg show `
          --resource-group $resourceGroup `
          --name $nsgName `
          --output none 2>$null

        if ($LASTEXITCODE -eq 0) {
          Write-Host "[INFO] NSG already exists: $nsgName"
          $nsgCount++
          continue
        }

        # Create NSG
        Write-Host "[PROGRESS] Creating NSG: $nsgName"

        $outputFile = "artifacts/outputs/networking-create-nsg-$nsgName.json"
        az network nsg create `
          --resource-group $resourceGroup `
          --name $nsgName `
          --location $location `
          --output json > $outputFile

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Failed to create NSG: $nsgName"
          exit 1
        }

        Write-Host "[SUCCESS] NSG created: $nsgName"
        $nsgCount++
      }

      Write-Host "[SUCCESS] All NSGs created successfully"
      Write-Host "[SUCCESS]   Total NSGs: $nsgCount"

      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/networking-03-create-nsgs-wrapper.ps1
      rm -f /tmp/networking-03-create-nsgs-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
