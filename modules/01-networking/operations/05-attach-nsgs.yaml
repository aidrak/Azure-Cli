# ==============================================================================
# Operation: Attach NSGs to Subnets
# ==============================================================================
operation:
  id: "networking-attach-nsgs"
  name: "Attach NSGs to Subnets"
  description: "Associate NSGs with their respective subnets"

  # Duration expectations
  duration:
    expected: 60    # 1 minute
    timeout: 120    # 2 minutes
    type: "FAST"

  # Prerequisites
  requires:
    - "networking-configure-nsg-rules"  # NSG rules must be configured first

  # Validation checks
  validation:
    enabled: true
    checks:
      - type: "nsg_attached"
        description: "NSGs attached to subnets"

  # Template command
  # NOTE: Uses bash heredoc to pass PowerShell script safely to pwsh
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/networking-05-attach-nsgs-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] NSG attachment: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration
      $vnetName = "{{NETWORKING_VNET_NAME}}"
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"

      # Get subnet count
      $subnetCount = [int](yq e '.networking.subnets | length' config.yaml)
      $attachedCount = 0

      Write-Host "[PROGRESS] Attaching NSGs to $subnetCount subnet(s)..."

      # Iterate through subnets
      for ($i = 0; $i -lt $subnetCount; $i++) {
        # Check if NSG enabled
        $nsgEnabled = (yq e ".networking.subnets[$i].nsg.enabled" config.yaml)

        if ($nsgEnabled -ne "true") {
          continue
        }

        # Get subnet and NSG names
        $subnetName = (yq e ".networking.subnets[$i].name" config.yaml)
        $nsgName = (yq e ".networking.subnets[$i].nsg.name" config.yaml)

        # Auto-generate NSG name if empty
        if ([string]::IsNullOrEmpty($nsgName) -or $nsgName -eq "null") {
          $nsgName = "nsg-$subnetName"
        }

        Write-Host "[PROGRESS] Attaching NSG to subnet: $subnetName"
        Write-Host "[PROGRESS]   NSG: $nsgName"

        # Check if NSG is already attached
        $currentNsg = az network vnet subnet show `
          --resource-group $resourceGroup `
          --vnet-name $vnetName `
          --name $subnetName `
          --query "networkSecurityGroup.id" -o tsv 2>$null

        if (-not [string]::IsNullOrEmpty($currentNsg)) {
          Write-Host "[INFO] NSG already attached to subnet: $subnetName"
          $attachedCount++
          continue
        }

        # Attach NSG to subnet
        az network vnet subnet update `
          --resource-group $resourceGroup `
          --vnet-name $vnetName `
          --name $subnetName `
          --network-security-group $nsgName `
          --output none

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Failed to attach NSG to subnet: $subnetName"
          exit 1
        }

        Write-Host "[SUCCESS] NSG attached: $nsgName -> $subnetName"
        $attachedCount++
      }

      Write-Host "[SUCCESS] All NSGs attached successfully"
      Write-Host "[SUCCESS]   Total attachments: $attachedCount"

      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/networking-05-attach-nsgs-wrapper.ps1
      rm -f /tmp/networking-05-attach-nsgs-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
