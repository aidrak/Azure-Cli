# ==============================================================================
# Operation: Link DNS Zones to VNet
# ==============================================================================
operation:
  id: "networking-link-dns-zones"
  name: "Link DNS Zones to VNet"
  description: "Create VNet links for private DNS zones"

  duration:
    expected: 90
    timeout: 180
    type: "FAST"

  requires:
    - "networking-create-dns-zones"

  validation:
    enabled: true

  # NOTE: Uses bash heredoc to pass PowerShell script safely to pwsh
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/networking-08-link-dns-zones-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] DNS zone linking: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      $vnetName = "{{NETWORKING_VNET_NAME}}"
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"

      $dnsEnabled = (yq e '.networking.private_dns.enabled' config.yaml)

      if ($dnsEnabled -ne "true") {
        Write-Host "[INFO] Private DNS disabled - skipping"
        exit 0
      }

      $zoneCount = [int](yq e '.networking.private_dns.zones | length' config.yaml)
      Write-Host "[PROGRESS] Linking $zoneCount DNS zone(s) to VNet..."

      for ($i = 0; $i -lt $zoneCount; $i++) {
        $zoneName = (yq e ".networking.private_dns.zones[$i].name" config.yaml)
        $linkToVnet = (yq e ".networking.private_dns.zones[$i].link_to_vnet" config.yaml)

        if ($linkToVnet -ne "true") {
          Write-Host "[INFO] Skipping VNet link for zone: $zoneName"
          continue
        }

        $linkName = "$zoneName-vnet-link"

        Write-Host "[PROGRESS] Linking zone to VNet: $zoneName"

        az network private-dns link vnet show `
          --resource-group $resourceGroup `
          --zone-name $zoneName `
          --name $linkName `
          --output none 2>$null

        if ($LASTEXITCODE -eq 0) {
          Write-Host "[INFO] VNet link already exists: $linkName"
          continue
        }

        az network private-dns link vnet create `
          --resource-group $resourceGroup `
          --zone-name $zoneName `
          --name $linkName `
          --virtual-network $vnetName `
          --registration-enabled false `
          --output none

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Failed to link zone: $zoneName"
          exit 1
        }

        Write-Host "[SUCCESS] Zone linked: $zoneName"
      }

      Write-Host "[SUCCESS] All DNS zones linked to VNet"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/networking-08-link-dns-zones-wrapper.ps1
      rm -f /tmp/networking-08-link-dns-zones-wrapper.ps1

  fixes: []
