# ==============================================================================
# Operation: Configure Route Tables
# ==============================================================================
operation:
  id: "networking-configure-route-tables"
  name: "Configure Route Tables"
  description: "Create and associate route tables (if enabled)"

  duration:
    expected: 90
    timeout: 180
    type: "FAST"

  requires:
    - "networking-create-peering"

  validation:
    enabled: true

  # NOTE: Uses bash heredoc to pass PowerShell script safely to pwsh
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/networking-10-configure-route-tables-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] Route table configuration: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      $vnetName = "{{NETWORKING_VNET_NAME}}"
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $location = "{{AZURE_LOCATION}}"

      $rtEnabled = (yq e '.networking.route_tables.enabled' config.yaml)

      if ($rtEnabled -ne "true") {
        Write-Host "[INFO] Route tables disabled - skipping"
        exit 0
      }

      $rtCount = [int](yq e '.networking.route_tables.tables | length' config.yaml)
      Write-Host "[PROGRESS] Processing $rtCount route table(s)..."

      for ($i = 0; $i -lt $rtCount; $i++) {
        $rtName = (yq e ".networking.route_tables.tables[$i].name" config.yaml)

        Write-Host "[PROGRESS] Processing route table: $rtName"

        az network route-table show `
          --resource-group $resourceGroup `
          --name $rtName `
          --output none 2>$null

        if ($LASTEXITCODE -ne 0) {
          az network route-table create `
            --resource-group $resourceGroup `
            --name $rtName `
            --location $location `
            --output none

          Write-Host "[SUCCESS] Route table created: $rtName"
        } else {
          Write-Host "[INFO] Route table already exists: $rtName"
        }

        # Add routes
        $routeCount = [int](yq e ".networking.route_tables.tables[$i].routes | length" config.yaml)

        for ($j = 0; $j -lt $routeCount; $j++) {
          $routeName = (yq e ".networking.route_tables.tables[$i].routes[$j].name" config.yaml)
          $addrPrefix = (yq e ".networking.route_tables.tables[$i].routes[$j].address_prefix" config.yaml)
          $nextHopType = (yq e ".networking.route_tables.tables[$i].routes[$j].next_hop_type" config.yaml)
          $nextHopIp = (yq e ".networking.route_tables.tables[$i].routes[$j].next_hop_ip_address" config.yaml)

          az network route-table route show `
            --resource-group $resourceGroup `
            --route-table-name $rtName `
            --name $routeName `
            --output none 2>$null

          if ($LASTEXITCODE -eq 0) {
            continue
          }

          if ($nextHopType -eq "VirtualAppliance") {
            az network route-table route create `
              --resource-group $resourceGroup `
              --route-table-name $rtName `
              --name $routeName `
              --address-prefix $addrPrefix `
              --next-hop-type $nextHopType `
              --next-hop-ip-address $nextHopIp `
              --output none
          } else {
            az network route-table route create `
              --resource-group $resourceGroup `
              --route-table-name $rtName `
              --name $routeName `
              --address-prefix $addrPrefix `
              --next-hop-type $nextHopType `
              --output none
          }

          Write-Host "[SUCCESS] Route added: $routeName"
        }

        # Associate with subnets
        $assocCount = [int](yq e ".networking.route_tables.tables[$i].associated_subnets | length" config.yaml)

        for ($k = 0; $k -lt $assocCount; $k++) {
          $subnetName = (yq e ".networking.route_tables.tables[$i].associated_subnets[$k]" config.yaml)

          az network vnet subnet update `
            --resource-group $resourceGroup `
            --vnet-name $vnetName `
            --name $subnetName `
            --route-table $rtName `
            --output none

          Write-Host "[SUCCESS] Route table associated with subnet: $subnetName"
        }
      }

      Write-Host "[SUCCESS] All route tables configured"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/networking-10-configure-route-tables-wrapper.ps1
      rm -f /tmp/networking-10-configure-route-tables-wrapper.ps1

  fixes: []
