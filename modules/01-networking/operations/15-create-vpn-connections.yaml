# ==============================================================================
# Operation: Create VPN Connections
# ==============================================================================
operation:
  id: "networking-create-vpn-connections"
  name: "Create VPN Connections"
  description: "Create VPN connections between VPN Gateway and Local Network Gateways (if enabled)"

  duration:
    expected: 180
    timeout: 360
    type: "FAST"

  requires:
    - "networking-create-vpn-gateway"
    - "networking-create-local-network-gateways"

  validation:
    enabled: true

  template:
    type: "powershell-local"
    command: |
      cat > /tmp/networking-15-create-vpn-connections-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] VPN Connection creation: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $gatewayName = (yq e '.networking.vpn_gateway.name' config.yaml)

      # Check if VPN connections are enabled
      $vpnConnEnabled = (yq e '.networking.vpn_connections.enabled' config.yaml)

      if ($vpnConnEnabled -ne "true") {
        Write-Host "[INFO] VPN Connections disabled - skipping"
        exit 0
      }

      # Check if gateway exists first
      az network vnet-gateway show `
        --resource-group $resourceGroup `
        --name $gatewayName `
        --output none 2>$null

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] VPN Gateway does not exist: $gatewayName"
        Write-Host "[INFO] Please ensure VPN Gateway is created before creating connections"
        exit 1
      }

      $connectionCount = [int](yq e '.networking.vpn_connections.connections | length' config.yaml)
      Write-Host "[PROGRESS] Creating $connectionCount VPN connection(s)..."

      for ($i = 0; $i -lt $connectionCount; $i++) {
        $connName = (yq e ".networking.vpn_connections.connections[$i].name" config.yaml)
        $lngName = (yq e ".networking.vpn_connections.connections[$i].local_network_gateway_name" config.yaml)
        $connType = (yq e ".networking.vpn_connections.connections[$i].connection_type" config.yaml)
        $enableBgp = (yq e ".networking.vpn_connections.connections[$i].enable_bgp" config.yaml)
        $sharedKey = (yq e ".networking.vpn_connections.connections[$i].shared_key" config.yaml)

        Write-Host "[PROGRESS] Processing connection: $connName"

        # Check if connection already exists
        az network vpn-connection show `
          --resource-group $resourceGroup `
          --name $connName `
          --output none 2>$null

        if ($LASTEXITCODE -eq 0) {
          Write-Host "[INFO] VPN Connection already exists: $connName"
          continue
        }

        # Validate that local network gateway exists
        az network local-gateway show `
          --resource-group $resourceGroup `
          --name $lngName `
          --output none 2>$null

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Local Network Gateway does not exist: $lngName"
          exit 1
        }

        # Build create command
        $createCmd = "az network vpn-connection create " +
          "--name $connName " +
          "--resource-group $resourceGroup " +
          "--vnet-gateway1 $gatewayName " +
          "--local-gateway2 $lngName " +
          "--connection-type $connType"

        if ($sharedKey -and $sharedKey -ne "") {
          $createCmd += " --shared-key '$sharedKey'"
        } else {
          Write-Host "[WARN] No shared key configured for $connName - connection may fail"
        }

        if ($enableBgp -eq "true") {
          $createCmd += " --enable-bgp"
        }

        $createCmd += " --output none"

        Write-Host "[PROGRESS] Creating VPN connection: $connName"
        Invoke-Expression $createCmd

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Failed to create VPN connection: $connName"
          exit 1
        }

        Write-Host "[SUCCESS] VPN connection created: $connName"
      }

      Write-Host "[SUCCESS] All VPN connections created"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/networking-15-create-vpn-connections-wrapper.ps1
      rm -f /tmp/networking-15-create-vpn-connections-wrapper.ps1

  fixes: []
