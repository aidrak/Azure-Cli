# ==============================================================================
# Operation: Create VNet Peering
# ==============================================================================
operation:
  id: "networking-create-peering"
  name: "Create VNet Peering"
  description: "Establish VNet peering to hub (if configured)"

  duration:
    expected: 120
    timeout: 240
    type: "FAST"

  requires:
    - "networking-link-dns-zones"

  validation:
    enabled: true

  # NOTE: Uses bash heredoc to pass PowerShell script safely to pwsh
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/networking-09-create-peering-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] VNet peering creation: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      $vnetName = "{{NETWORKING_VNET_NAME}}"
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"

      $peeringEnabled = (yq e '.networking.peering.enabled' config.yaml)

      if ($peeringEnabled -ne "true") {
        Write-Host "[INFO] VNet peering disabled - skipping"
        exit 0
      }

      $hubVnetName = (yq e '.networking.peering.hub_vnet.name' config.yaml)
      $hubVnetRg = (yq e '.networking.peering.hub_vnet.resource_group' config.yaml)
      $hubSubscription = (yq e '.networking.peering.hub_vnet.subscription_id' config.yaml)
      $allowVnetAccess = (yq e '.networking.peering.allow_virtual_network_access' config.yaml)
      $allowForwarded = (yq e '.networking.peering.allow_forwarded_traffic' config.yaml)
      $allowGatewayTransit = (yq e '.networking.peering.allow_gateway_transit' config.yaml)
      $useRemoteGateways = (yq e '.networking.peering.use_remote_gateways' config.yaml)

      $remoteVnetId = "/subscriptions/$hubSubscription/resourceGroups/$hubVnetRg/providers/Microsoft.Network/virtualNetworks/$hubVnetName"
      $peeringName = "$vnetName-to-$hubVnetName"

      Write-Host "[PROGRESS] Creating peering: $peeringName"

      az network vnet peering show `
        --resource-group $resourceGroup `
        --vnet-name $vnetName `
        --name $peeringName `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[INFO] Peering already exists: $peeringName"
        exit 0
      }

      az network vnet peering create `
        --resource-group $resourceGroup `
        --vnet-name $vnetName `
        --name $peeringName `
        --remote-vnet $remoteVnetId `
        --allow-vnet-access $allowVnetAccess `
        --allow-forwarded-traffic $allowForwarded `
        --allow-gateway-transit $allowGatewayTransit `
        --use-remote-gateways $useRemoteGateways `
        --output json > artifacts/outputs/networking-peering.json

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Failed to create peering"
        exit 1
      }

      Write-Host "[SUCCESS] VNet peering created: $peeringName"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/networking-09-create-peering-wrapper.ps1
      rm -f /tmp/networking-09-create-peering-wrapper.ps1

  fixes: []
