# ==============================================================================
# Operation: Configure Service Endpoints
# ==============================================================================
operation:
  id: "networking-configure-service-endpoints"
  name: "Configure Service Endpoints"
  description: "Enable Azure service endpoints on subnets (if configured)"

  # Duration expectations
  duration:
    expected: 90    # 1.5 minutes
    timeout: 180    # 3 minutes
    type: "FAST"

  # Prerequisites
  requires:
    - "networking-attach-nsgs"  # NSGs should be attached first

  # Validation checks
  validation:
    enabled: true
    checks:
      - type: "service_endpoints_configured"
        description: "Service endpoints configured"

  # Template command
  # NOTE: Uses bash heredoc to pass PowerShell script safely to pwsh
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/networking-06-configure-service-endpoints-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] Service endpoint configuration: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration
      $vnetName = "{{NETWORKING_VNET_NAME}}"
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"

      # Get subnet count
      $subnetCount = [int](yq e '.networking.subnets | length' config.yaml)
      $configuredCount = 0

      Write-Host "[PROGRESS] Configuring service endpoints for $subnetCount subnet(s)..."

      # Iterate through subnets
      for ($i = 0; $i -lt $subnetCount; $i++) {
        $subnetName = (yq e ".networking.subnets[$i].name" config.yaml)

        # Get service endpoints count for this subnet
        $endpointCount = [int](yq e ".networking.subnets[$i].service_endpoints | length" config.yaml)

        # Skip if no service endpoints configured
        if ($endpointCount -eq 0) {
          Write-Host "[INFO] No service endpoints for subnet: $subnetName"
          continue
        }

        Write-Host "[PROGRESS] Configuring $endpointCount endpoint(s) for subnet: $subnetName"

        # Build service endpoint list
        $endpoints = @()
        for ($j = 0; $j -lt $endpointCount; $j++) {
          $endpoint = (yq e ".networking.subnets[$i].service_endpoints[$j]" config.yaml)
          $endpoints += $endpoint
        }

        Write-Host "[PROGRESS]   Endpoints: $($endpoints -join ' ')"

        # Update subnet with service endpoints
        az network vnet subnet update `
          --resource-group $resourceGroup `
          --vnet-name $vnetName `
          --name $subnetName `
          --service-endpoints @endpoints `
          --output none

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Failed to configure service endpoints for subnet: $subnetName"
          exit 1
        }

        Write-Host "[SUCCESS] Service endpoints configured: $subnetName"
        $configuredCount++
      }

      Write-Host "[SUCCESS] All service endpoints configured successfully"
      Write-Host "[SUCCESS]   Subnets configured: $configuredCount"

      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/networking-06-configure-service-endpoints-wrapper.ps1
      rm -f /tmp/networking-06-configure-service-endpoints-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
