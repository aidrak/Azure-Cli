operation:
  id: "storage-create-file-share"
  name: "Create FSLogix File Share"
  description: "Create Azure Premium file share for FSLogix profile containers with specified quota"

  duration:
    expected: 60       # 60 seconds (1 minute)
    timeout: 120       # 2 minutes
    type: "FAST"

  template:
    type: "powershell-local"
    command: |
      cat > /tmp/storage-03-wrapper.ps1 << 'PSWRAPPER'
      # Get storage account name (from previous operation or config)
      if (Test-Path /tmp/storage-account-name.txt) {
        $storageName = Get-Content /tmp/storage-account-name.txt
      } else {
        $storageName = "{{STORAGE_ACCOUNT_NAME}}"
      }

      $fileShareName = "{{STORAGE_FILE_SHARE_NAME}}"
      $quotaGb = "{{STORAGE_QUOTA_GB}}"

      Write-Host "[START] Creating file share at $(Get-Date -Format 'HH:mm:ss')"
      Write-Host "  Storage account: $storageName"
      Write-Host "  File share name: $fileShareName"
      Write-Host "  Quota: ${quotaGb}GB"

      # Check if file share already exists
      Write-Host "[PROGRESS] Checking if file share exists..."

      $existsOutput = az storage share exists `
        --account-name $storageName `
        --name $fileShareName `
        --query exists -o tsv 2>$null

      if ($existsOutput -eq "true") {
        Write-Host "[SUCCESS] File share already exists: $fileShareName"

        # Get current quota
        $currentQuota = az storage share show `
          --account-name $storageName `
          --name $fileShareName `
          --query quota -o tsv 2>$null

        Write-Host "  Current quota: ${currentQuota}GB"
        exit 0
      }

      Write-Host "[PROGRESS] Creating file share..."

      # Create file share
      $createOutput = az storage share create `
        --account-name $storageName `
        --name $fileShareName `
        --quota $quotaGb `
        --output json 2>&1

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Failed to create file share"
        Write-Host $createOutput
        exit 1
      }

      Write-Host "[VALIDATE] Verifying file share creation..."

      # Verify file share exists
      $verifyShare = @(az storage share show `
        --account-name $storageName `
        --name $fileShareName `
        --query "[0]" 2>$null | ConvertFrom-Json)

      if ($verifyShare.Count -eq 0) {
        Write-Host "[ERROR] File share creation verification failed"
        exit 1
      }

      $shareQuota = az storage share show `
        --account-name $storageName `
        --name $fileShareName `
        --query quota -o tsv

      Write-Host "[SUCCESS] File share created: $fileShareName"
      Write-Host "  Storage account: $storageName"
      Write-Host "  Provisioned capacity: ${shareQuota}GB"
      Write-Host "  Protocol: SMB 3.1.1"
      Write-Host "  UNC path: \\${storageName}.file.core.windows.net\${fileShareName}"
      Write-Host ""
      Write-Host "[INFO] FSLogix Configuration Value:"
      Write-Host "  VHDLocations: \\${storageName}.file.core.windows.net\${fileShareName}"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/storage-03-wrapper.ps1
      rm -f /tmp/storage-03-wrapper.ps1

  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "file_share"
        name: "{{STORAGE_FILE_SHARE_NAME}}"
      - type: "property_greater_than"
        property: "quota"
        expected: 0

  fixes:
    # Auto-populated by error handler on failures
