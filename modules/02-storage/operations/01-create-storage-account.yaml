operation:
  id: "storage-create-account"
  name: "Create Premium FileStorage Account"
  description: "Create Azure Premium Files storage account for FSLogix profile containers"

  duration:
    expected: 90       # 90 seconds (1.5 minutes)
    timeout: 180       # 3 minutes
    type: "NORMAL"

  template:
    type: "powershell-local"
    command: |
      cat > /tmp/storage-01-wrapper.ps1 << 'PSWRAPPER'
      # Generate unique storage account name if not provided
      if ([string]::IsNullOrEmpty("{{STORAGE_ACCOUNT_NAME}}")) {
        $storageName = "fslogix$(Get-Random -Minimum 0 -Maximum 99999)"
      } else {
        $storageName = "{{STORAGE_ACCOUNT_NAME}}"
      }

      Write-Host "[START] Creating storage account: $storageName at $(Get-Date -Format 'HH:mm:ss')"

      # Check if storage account already exists
      $existingAccount = @(az storage account show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $storageName `
        --query "[0]" 2>$null | ConvertFrom-Json)

      if ($existingAccount.Count -gt 0) {
        Write-Host "[SUCCESS] Storage account already exists: $storageName"
        exit 0
      }

      Write-Host "[PROGRESS] Creating Premium FileStorage account..."

      # Create storage account
      $createOutput = az storage account create `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $storageName `
        --location "{{AZURE_LOCATION}}" `
        --sku Premium_LRS `
        --kind FileStorage `
        --enable-large-file-share `
        --min-tls-version TLS1_2 `
        --allow-blob-public-access false `
        --https-only true `
        --output json 2>&1

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Failed to create storage account"
        Write-Host $createOutput
        exit 1
      }

      Write-Host "[VALIDATE] Verifying storage account creation..."

      # Verify storage account exists
      $verifyAccount = @(az storage account show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $storageName `
        --query "[0]" 2>$null | ConvertFrom-Json)

      if ($verifyAccount.Count -eq 0) {
        Write-Host "[ERROR] Storage account creation verification failed"
        exit 1
      }

      $storageId = az storage account show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $storageName `
        --query id -o tsv

      Write-Host "[SUCCESS] Storage account created: $storageName"
      Write-Host "  Resource ID: $storageId"
      Write-Host "  SKU: Premium_LRS"
      Write-Host "  Kind: FileStorage"
      Write-Host "  TLS: 1.2 minimum"
      Write-Host "  Public blob access: Disabled"
      Write-Host "  HTTPS only: Enabled"

      # Export storage account name for subsequent operations
      $storageName | Out-File -FilePath /tmp/storage-account-name.txt -NoNewline
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/storage-01-wrapper.ps1
      rm -f /tmp/storage-01-wrapper.ps1

  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "storage_account"
        name: "{{STORAGE_ACCOUNT_NAME}}"
      - type: "property_equals"
        property: "sku.name"
        expected: "Premium_LRS"
      - type: "property_equals"
        property: "kind"
        expected: "FileStorage"

  fixes:
    # Auto-populated by error handler on failures
