operation:
  id: "storage-create-account"
  name: "Create Premium FileStorage Account"
  description: "Create Azure Premium Files storage account for FSLogix profile containers"

  duration:
    expected: 90       # 90 seconds (1.5 minutes)
    timeout: 180       # 3 minutes
    type: "NORMAL"

  template:
    type: "az-cli"
    command: |
      # Generate unique storage account name if not provided
      if [ -z "{{STORAGE_ACCOUNT_NAME}}" ]; then
        STORAGE_NAME="fslogix$(printf '%05d' $((RANDOM % 99999)))"
      else
        STORAGE_NAME="{{STORAGE_ACCOUNT_NAME}}"
      fi

      echo "[START] Creating storage account: $STORAGE_NAME at $(date +%H:%M:%S)"

      # Check if storage account already exists
      if az storage account show \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "$STORAGE_NAME" &>/dev/null; then
        echo "[SUCCESS] Storage account already exists: $STORAGE_NAME"
        exit 0
      fi

      echo "[PROGRESS] Creating Premium FileStorage account..."

      # Create storage account
      if az storage account create \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "$STORAGE_NAME" \
        --location "{{AZURE_LOCATION}}" \
        --sku Premium_LRS \
        --kind FileStorage \
        --enable-large-file-share \
        --min-tls-version TLS1_2 \
        --allow-blob-public-access false \
        --https-only true \
        --output json > /tmp/storage-account.json; then

        echo "[VALIDATE] Verifying storage account creation..."

        # Verify storage account exists
        if az storage account show \
          --resource-group "{{AZURE_RESOURCE_GROUP}}" \
          --name "$STORAGE_NAME" &>/dev/null; then

          STORAGE_ID=$(az storage account show \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --name "$STORAGE_NAME" \
            --query id -o tsv)

          echo "[SUCCESS] Storage account created: $STORAGE_NAME"
          echo "  Resource ID: $STORAGE_ID"
          echo "  SKU: Premium_LRS"
          echo "  Kind: FileStorage"
          echo "  TLS: 1.2 minimum"
          echo "  Public blob access: Disabled"
          echo "  HTTPS only: Enabled"

          # Export storage account name for subsequent operations
          echo "$STORAGE_NAME" > /tmp/storage-account-name.txt
          exit 0
        else
          echo "[ERROR] Storage account creation verification failed"
          exit 1
        fi
      else
        echo "[ERROR] Failed to create storage account"
        cat /tmp/storage-account.json
        exit 1
      fi

  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "storage_account"
        name: "{{STORAGE_ACCOUNT_NAME}}"
      - type: "property_equals"
        property: "sku.name"
        expected: "Premium_LRS"
      - type: "property_equals"
        property: "kind"
        expected: "FileStorage"

  fixes:
    # Auto-populated by error handler on failures
