operation:
  id: "storage-create-private-dns"
  name: "Create Private DNS Zone for Azure Files"
  description: "Create and configure private DNS zone for Azure Files private endpoint resolution"

  duration:
    expected: 60       # 60 seconds (1 minute)
    timeout: 120       # 2 minutes
    type: "FAST"

  template:
    type: "powershell-local"
    command: |
      cat > /tmp/storage-05-wrapper.ps1 << 'PSWRAPPER'
      $dnsZoneName = "privatelink.file.core.windows.net"
      $vnetName = "{{NETWORKING_VNET_NAME}}"

      Write-Host "[START] Configuring private DNS zone at $(Get-Date -Format 'HH:mm:ss')"
      Write-Host "  DNS zone: $dnsZoneName"
      Write-Host "  VNet: $vnetName"

      # Check if private DNS zone exists
      Write-Host "[PROGRESS] Checking if private DNS zone exists..."

      $dnsZoneExists = @(az network private-dns zone show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $dnsZoneName `
        --query "[0]" 2>$null | ConvertFrom-Json)

      if ($dnsZoneExists.Count -eq 0) {
        Write-Host "[PROGRESS] Creating private DNS zone..."

        $createDnsOutput = az network private-dns zone create `
          --resource-group "{{AZURE_RESOURCE_GROUP}}" `
          --name $dnsZoneName `
          --output json 2>&1

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Failed to create private DNS zone"
          Write-Host $createDnsOutput
          exit 1
        }

        Write-Host "[SUCCESS] Private DNS zone created: $dnsZoneName"
      } else {
        Write-Host "[SUCCESS] Private DNS zone already exists: $dnsZoneName"
      }

      # Check if VNet link exists
      Write-Host "[PROGRESS] Checking VNet link..."

      $linkName = "${vnetName}-link"

      $vnetLinkExists = @(az network private-dns link vnet show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --zone-name $dnsZoneName `
        --name $linkName `
        --query "[0]" 2>$null | ConvertFrom-Json)

      if ($vnetLinkExists.Count -eq 0) {
        Write-Host "[PROGRESS] Creating VNet link..."

        # Get VNet ID
        $vnetId = az network vnet show `
          --resource-group "{{AZURE_RESOURCE_GROUP}}" `
          --name $vnetName `
          --query id -o tsv

        if ([string]::IsNullOrEmpty($vnetId)) {
          Write-Host "[ERROR] VNet not found: $vnetName"
          exit 1
        }

        # Create VNet link
        $createLinkOutput = az network private-dns link vnet create `
          --resource-group "{{AZURE_RESOURCE_GROUP}}" `
          --zone-name $dnsZoneName `
          --name $linkName `
          --virtual-network $vnetId `
          --registration-enabled false `
          --output json 2>&1

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Failed to create VNet link"
          Write-Host $createLinkOutput
          exit 1
        }

        Write-Host "[SUCCESS] VNet link created: $linkName"
      } else {
        Write-Host "[SUCCESS] VNet link already exists: $linkName"
      }

      Write-Host "[VALIDATE] Verifying DNS zone configuration..."

      # Verify DNS zone exists
      $dnsZoneId = az network private-dns zone show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $dnsZoneName `
        --query id -o tsv

      # Verify VNet link exists
      $linkState = az network private-dns link vnet show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --zone-name $dnsZoneName `
        --name $linkName `
        --query virtualNetworkLinkState -o tsv

      if ($linkState -eq "Completed") {
        Write-Host "[SUCCESS] Private DNS zone configured successfully"
        Write-Host "  DNS zone ID: $dnsZoneId"
        Write-Host "  VNet link: $linkName"
        Write-Host "  Link state: $linkState"
        Write-Host "  Auto-registration: Disabled"
        Write-Host ""
        Write-Host "[INFO] DNS Resolution:"
        Write-Host "  Storage accounts will resolve to private IPs within VNet"
        Write-Host "  Pattern: <storage-account>.file.core.windows.net -> <private-ip>"
        exit 0
      } else {
        Write-Host "[ERROR] VNet link state is not 'Completed': $linkState"
        exit 1
      }
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/storage-05-wrapper.ps1
      rm -f /tmp/storage-05-wrapper.ps1

  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "private_dns_zone"
        name: "privatelink.file.core.windows.net"
      - type: "vnet_link_exists"
        zone_name: "privatelink.file.core.windows.net"
        vnet_name: "{{NETWORKING_VNET_NAME}}"

  fixes:
    # Auto-populated by error handler on failures
