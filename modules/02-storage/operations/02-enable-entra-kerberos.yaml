operation:
  id: "storage-enable-kerberos"
  name: "Enable Entra Kerberos Authentication"
  description: "Enable Microsoft Entra Kerberos authentication for passwordless FSLogix access"

  duration:
    expected: 60       # 60 seconds (1 minute)
    timeout: 120       # 2 minutes
    type: "FAST"

  template:
    type: "powershell-local"
    command: |
      cat > /tmp/storage-02-wrapper.ps1 << 'PSWRAPPER'
      # Get storage account name (from previous operation or config)
      if (Test-Path /tmp/storage-account-name.txt) {
        $storageName = Get-Content /tmp/storage-account-name.txt
      } else {
        $storageName = "{{STORAGE_ACCOUNT_NAME}}"
      }

      Write-Host "[START] Enabling Entra Kerberos authentication at $(Get-Date -Format 'HH:mm:ss')"
      Write-Host "  Storage account: $storageName"

      # Check current Kerberos configuration
      Write-Host "[PROGRESS] Checking current authentication configuration..."

      $currentConfig = az storage account show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $storageName `
        --query "azureFilesIdentityBasedAuthentication.directoryServiceOptions" `
        -o tsv 2>$null

      if ($currentConfig -eq "AADKERB" -or $currentConfig -eq "AADDS") {
        Write-Host "[SUCCESS] Kerberos authentication already enabled: $currentConfig"
        exit 0
      }

      Write-Host "[PROGRESS] Enabling Microsoft Entra Kerberos (AADKERB)..."

      # Enable Entra Kerberos authentication
      $updateOutput = az storage account update `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $storageName `
        --enable-files-aadkerb true `
        --output json 2>&1

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Failed to enable Kerberos authentication"
        Write-Host $updateOutput
        exit 1
      }

      Write-Host "[VALIDATE] Verifying Kerberos configuration..."

      # Wait 5 seconds for configuration to propagate
      Start-Sleep -Seconds 5

      # Verify Kerberos is enabled
      $newConfig = az storage account show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $storageName `
        --query "azureFilesIdentityBasedAuthentication.directoryServiceOptions" `
        -o tsv

      if ($newConfig -eq "AADKERB") {
        Write-Host "[SUCCESS] Entra Kerberos authentication enabled"
        Write-Host "  Authentication method: $newConfig"
        Write-Host "  Domain name: Entra-only (no domain GUID required)"
        Write-Host "  Users can now mount shares with domain credentials"
        exit 0
      } else {
        Write-Host "[ERROR] Kerberos configuration verification failed"
        Write-Host "  Expected: AADKERB"
        Write-Host "  Got: $newConfig"
        exit 1
      }
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/storage-02-wrapper.ps1
      rm -f /tmp/storage-02-wrapper.ps1

  validation:
    enabled: true
    checks:
      - type: "property_equals"
        property: "azureFilesIdentityBasedAuthentication.directoryServiceOptions"
        expected: "AADKERB"

  fixes:
    # Auto-populated by error handler on failures
