# ==============================================================================
# Module: Golden Image Creation
# ==============================================================================
#
# EXECUTION MODEL (Updated 2025-12-06):
# - All operations use PowerShell (pwsh) as the orchestration layer
# - Operations 00-01: PowerShell runs locally on Ubuntu, calls Azure CLI (powershell-local)
# - Operations 02-10: PowerShell runs locally on Ubuntu, invokes remote PowerShell via
#                      az vm run-command on the Windows golden image VM (powershell-vm-command)
# - PowerShell content is embedded inline in YAML (no external .ps1 files)
#
# MIGRATION FROM BASH:
# - Previous architecture used bash wrappers to pass scripts to az vm run-command
# - Bash made complex script passing difficult (special character escaping, quoting)
# - PowerShell handles script injection natively with here-strings and encoding
# - Benefits:
#   * Simpler script passing (no bash quoting/escaping complexity)
#   * Native JSON handling with ConvertFrom-Json/ConvertTo-Json
#   * Consistent PowerShell syntax across local and remote operations
#   * Better error handling with try/catch blocks in PowerShell
#   * Temporary file cleanup handled by PowerShell finally blocks
#
# ==============================================================================
module:
  id: "05-golden-image"
  name: "Golden Image Creation"
  description: "Create and configure a golden image VM for Azure Virtual Desktop"

  # Module-level configuration
  config:
    temp_vm_prefix: "{{GOLDEN_IMAGE_TEMP_VM_NAME}}"
    resource_group: "{{AZURE_RESOURCE_GROUP}}"
    location: "{{AZURE_LOCATION}}"

  # Operations in this module (executed in order or parallel groups)
  # parallel_group: Operations with same group number run in parallel
  operations:
    - id: "golden-image-00-create-vm"
      name: "00: Create Temporary VM"
      description: "Create temporary Windows 11 VM for golden image preparation"
      duration: 420
      type: "WAIT"

    - id: "golden-image-01-validate-vm"
      name: "01: Validate VM Ready"
      description: "Wait for VM to be fully ready and VM agent to be running"
      duration: 180
      type: "WAIT"
      requires:
        - operation: "golden-image-00-create-vm"
          status: "completed"

    - id: "golden-image-02-system-prep"
      name: "02: System Preparation"
      description: "Disable BitLocker, create temp directory"
      duration: 60
      type: "FAST"
      requires:
        - operation: "golden-image-01-validate-vm"
          status: "completed"

    - id: "golden-image-03-install-apps"
      name: "03: Install Applications"
      description: "Install all selected simple applications in parallel with heartbeat monitoring"
      duration: 1200
      type: "HEARTBEAT"
      requires:
        - operation: "golden-image-02-system-prep"
          status: "completed"

    - id: "golden-image-04-install-office"
      name: "04: Install Office 365"
      description: "Download and install Office 365 using ODT"
      duration: 1800
      type: "WAIT"
      requires:
        - operation: "golden-image-03-install-apps"
          status: "completed"

    - id: "golden-image-05-configure-defaults"
      name: "05: Configure Default Applications"
      description: "Set default apps and create desktop shortcuts"
      duration: 120
      type: "FAST"
      requires:
        - operation: "golden-image-04-install-office"
          status: "completed"

    - id: "golden-image-06-run-vdot"
      name: "06: Run VDOT Optimizations"
      description: "Download and run Virtual Desktop Optimization Tool"
      duration: 300
      type: "FAST"
      requires:
        - operation: "golden-image-05-configure-defaults"
          status: "completed"

    - id: "golden-image-07-registry-avd"
      name: "07: Configure AVD Registry"
      description: "Configure RDP, FSLogix exclusions, OOBE settings"
      duration: 120
      type: "FAST"
      requires:
        - operation: "golden-image-06-run-vdot"
          status: "completed"

    - id: "golden-image-08-configure-default-profile"
      name: "08: Configure Default User Profile"
      description: "Configure default user profile for FSLogix"
      duration: 60
      type: "FAST"
      requires:
        - operation: "golden-image-07-registry-avd"
          status: "completed"

    - id: "golden-image-09-cleanup-temp"
      name: "09: Cleanup Temporary Files"
      description: "Remove temporary files and caches"
      duration: 60
      type: "FAST"
      requires:
        - operation: "golden-image-08-configure-default-profile"
          status: "completed"

    - id: "golden-image-10-validate-all"
      name: "10: Validate All Installations"
      description: "Validate all software installations and configurations"
      duration: 120
      type: "FAST"
      requires:
        - operation: "golden-image-09-cleanup-temp"
          status: "completed"

  # Module-level validation (run after all operations complete)
  validation:
    enabled: true
    checks:
      - type: "file_exists"
        path: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
        description: "Chrome installed"

      - type: "file_exists"
        path: "C:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\Acrobat.exe"
        description: "Adobe Reader installed"
        alternative_path: "C:\\Program Files (x86)\\Adobe\\Acrobat Reader DC\\Reader\\AcroRd32.exe"

      - type: "file_exists"
        path: "C:\\Program Files\\Microsoft Office\\root\\Office16\\WINWORD.EXE"
        description: "Office 365 installed"

      - type: "file_exists"
        path: "C:\\Program Files\\FSLogix\\Apps\\frx.exe"
        description: "FSLogix available (pre-installed on Win11 multi-session)"

      - type: "registry_key"
        path: "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server"
        description: "RDP registry configured"

  # Expected total duration (with optimized downloads)
  # Sequential: VM(7m) + Validate(3m) + Prep(1m) = 11m
  # Apps with parallel downloads: 6m (vs 8m sequential)
  # Office: 30m
  # Config: Defaults(2m) + VDOT(5m) + Registry(2m) + Profile(1m) + Cleanup(1m) + Validate(2m) = 13m
  # Total: 11 + 6 + 30 + 13 = 60 minutes (vs 62 minutes fully sequential)
  total_duration:
    expected: 3600  # 60 minutes (with parallel download optimization)
    timeout: 7200   # 120 minutes (2x expected)

  # Module state file
  state_file: "modules/05-golden-image/state.json"

  # Artifacts
  artifacts:
    logs: "artifacts/logs/"
    outputs: "artifacts/outputs/"
    scripts: "artifacts/scripts/"
