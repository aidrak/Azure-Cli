# ==============================================================================
# Module: Golden Image Creation
# ==============================================================================
module:
  id: "05-golden-image"
  name: "Golden Image Creation"
  description: "Create and configure a golden image VM for Azure Virtual Desktop"

  # Module-level configuration
  config:
    temp_vm_prefix: "{{GOLDEN_IMAGE_TEMP_VM_NAME}}"
    resource_group: "{{AZURE_RESOURCE_GROUP}}"
    location: "{{AZURE_LOCATION}}"

  # Operations in this module (executed in order or parallel groups)
  # parallel_group: Operations with same group number run in parallel
  operations:
    - id: "golden-image-create-vm"
      name: "Create Temporary VM"
      description: "Create temporary Windows 11 VM for golden image preparation"
      duration: 420  # 7 minutes
      type: "WAIT"

    - id: "golden-image-validate-vm"
      name: "Validate VM Ready"
      description: "Wait for VM agent to be ready"
      duration: 180  # 3 minutes
      type: "WAIT"

    - id: "golden-image-system-prep"
      name: "System Preparation"
      description: "Disable BitLocker, create temp directory"
      duration: 60  # 1 minute
      type: "FAST"

    # Install all simple applications selected in config.yaml using the app manifest
    - id: "golden-image-install-apps"
      name: "Install Applications"
      description: "Install all selected simple applications in parallel with heartbeat monitoring"
      duration: 1200 # 20 minutes
      type: "HEARTBEAT"

    # Office runs alone due to its complex ODT process
    - id: "golden-image-install-office"
      name: "Install Office 365"
      description: "Download and install Office 365 using ODT"
      duration: 1800  # 30 minutes
      type: "WAIT"
      requires:
        - operation: "golden-image-install-apps"
          status: "completed"

    # Sequential configuration steps
    - id: "golden-image-configure-defaults"
      name: "Configure Default Applications"
      description: "Set default apps and create desktop shortcuts"
      duration: 120  # 2 minutes
      type: "FAST"

    - id: "golden-image-run-vdot"
      name: "Run VDOT Optimizations"
      description: "Download and run Virtual Desktop Optimization Tool"
      duration: 300  # 5 minutes
      type: "FAST"

    # Sequential final configuration steps
    - id: "golden-image-registry-avd"
      name: "Configure AVD Registry"
      description: "Configure RDP, FSLogix exclusions, OOBE settings"
      duration: 120  # 2 minutes
      type: "FAST"

    - id: "golden-image-configure-default-profile"
      name: "Configure Default User Profile"
      description: "Configure default user profile for FSLogix"
      duration: 60  # 1 minute
      type: "FAST"

    - id: "golden-image-cleanup-temp"
      name: "Cleanup Temporary Files"
      description: "Remove temporary files and caches"
      duration: 60  # 1 minute
      type: "FAST"

    - id: "golden-image-validate-all"
      name: "Validate All Installations"
      description: "Validate all software installations and configurations"
      duration: 120  # 2 minutes
      type: "FAST"

  # Module-level validation (run after all operations complete)
  validation:
    enabled: true
    checks:
      - type: "file_exists"
        path: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
        description: "Chrome installed"

      - type: "file_exists"
        path: "C:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\Acrobat.exe"
        description: "Adobe Reader installed"
        alternative_path: "C:\\Program Files (x86)\\Adobe\\Acrobat Reader DC\\Reader\\AcroRd32.exe"

      - type: "file_exists"
        path: "C:\\Program Files\\Microsoft Office\\root\\Office16\\WINWORD.EXE"
        description: "Office 365 installed"

      - type: "file_exists"
        path: "C:\\Program Files\\FSLogix\\Apps\\frx.exe"
        description: "FSLogix available (pre-installed on Win11 multi-session)"

      - type: "registry_key"
        path: "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server"
        description: "RDP registry configured"

  # Expected total duration (with optimized downloads)
  # Sequential: VM(7m) + Validate(3m) + Prep(1m) = 11m
  # Apps with parallel downloads: 6m (vs 8m sequential)
  # Office: 30m
  # Config: Defaults(2m) + VDOT(5m) + Registry(2m) + Profile(1m) + Cleanup(1m) + Validate(2m) = 13m
  # Total: 11 + 6 + 30 + 13 = 60 minutes (vs 62 minutes fully sequential)
  total_duration:
    expected: 3600  # 60 minutes (with parallel download optimization)
    timeout: 7200   # 120 minutes (2x expected)

  # Module state file
  state_file: "modules/05-golden-image/state.json"

  # Artifacts
  artifacts:
    logs: "artifacts/logs/"
    outputs: "artifacts/outputs/"
    scripts: "artifacts/scripts/"
