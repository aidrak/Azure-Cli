# ==============================================================================
# Operation: Validate VM Ready
# ==============================================================================
operation:
  id: "golden-image-validate-vm"
  name: "Validate VM Ready"
  description: "Wait for VM to be fully ready and VM agent to be running"

  # Duration expectations
  duration:
    expected: 180   # 3 minutes
    timeout: 600    # 10 minutes (VM agent can take time to start)
    type: "WAIT"

  # Prerequisites
  requires:
    - "golden-image-create-vm"

  # Validation checks
  validation:
    enabled: true
    checks:
      - type: "vm_agent_ready"
        description: "VM agent is running"

  # Template command
  template:
    type: "az-cli"
    command: |
      echo "[INFO] Waiting for VM to be fully ready..."

      MAX_ATTEMPTS=20
      SLEEP_INTERVAL=30
      ATTEMPT=0

      while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
        ATTEMPT=$((ATTEMPT + 1))
        echo "[INFO] Attempt $ATTEMPT of $MAX_ATTEMPTS: Checking VM agent status..."

        # Check VM agent status
        VM_AGENT_STATUS=$(az vm get-instance-view \
          --resource-group "{{AZURE_RESOURCE_GROUP}}" \
          --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" \
          --query "instanceView.vmAgent.statuses[0].displayStatus" \
          --output tsv 2>/dev/null)

        echo "[INFO] VM Agent Status: $VM_AGENT_STATUS"

        if [[ "$VM_AGENT_STATUS" == "Ready" ]]; then
          echo "[SUCCESS] VM agent is ready"

          # Try a simple run-command to verify it's actually working
          echo "[INFO] Testing run-command capability..."
          if az vm run-command invoke \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" \
            --command-id RunPowerShellScript \
            --scripts "Write-Host 'VM is ready'" \
            --output json > artifacts/outputs/golden-image-validate-vm-test.json 2>&1; then
            echo "[SUCCESS] VM is fully ready and accepting run-commands"
            exit 0
          else
            echo "[WARNING] VM agent reports ready but run-command failed, waiting..."
          fi
        fi

        if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
          echo "[INFO] Waiting ${SLEEP_INTERVAL}s before next attempt..."
          sleep $SLEEP_INTERVAL
        fi
      done

      echo "[ERROR] VM failed to become ready after $((MAX_ATTEMPTS * SLEEP_INTERVAL)) seconds"
      exit 1

  # Self-healing fixes
  fixes:
    # Fixes will be added here automatically when errors occur
