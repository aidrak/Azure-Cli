# ==============================================================================
# Operation: Create Temporary VM
# ==============================================================================
operation:
  id: "golden-image-00-create-vm"
  name: "00: Create Temporary VM"
  description: "Create temporary Windows 11 VM for golden image preparation"

  # Duration expectations
  duration:
    expected: 420   # 7 minutes
    timeout: 900    # 15 minutes (VM creation can be slow)
    type: "WAIT"    # WAIT (10+min typical for VM creation)

  # Prerequisites (check state.json)
  requires: []  # First operation, no prerequisites

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "vm"
        resource_name: "{{GOLDEN_IMAGE_TEMP_VM_NAME}}"
        description: "VM created successfully"

  # Template command (variables substituted at runtime)
  # NOTE: Uses bash heredoc to pass PowerShell script safely to pwsh
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/golden-image-00-wrapper.ps1 << 'PSWRAPPER'
      # Check if VM already exists (idempotent)
      $vmExists = az vm show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[INFO] VM '{{GOLDEN_IMAGE_TEMP_VM_NAME}}' already exists. Skipping creation."
        exit 0
      }

      # Create VM with TrustedLaunch security
      az vm create `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" `
        --image "{{GOLDEN_IMAGE_IMAGE_PUBLISHER}}:{{GOLDEN_IMAGE_IMAGE_OFFER}}:{{GOLDEN_IMAGE_IMAGE_SKU}}:{{GOLDEN_IMAGE_IMAGE_VERSION}}" `
        --size "{{GOLDEN_IMAGE_VM_SIZE}}" `
        --admin-username "{{GOLDEN_IMAGE_ADMIN_USERNAME}}" `
        --admin-password "{{GOLDEN_IMAGE_ADMIN_PASSWORD}}" `
        --vnet-name "{{NETWORKING_VNET_NAME}}" `
        --subnet "{{NETWORKING_SESSION_HOST_SUBNET_NAME}}" `
        --public-ip-sku Standard `
        --security-type TrustedLaunch `
        --enable-secure-boot true `
        --enable-vtpm true `
        --location "{{AZURE_LOCATION}}" `
        --output json > artifacts/outputs/golden-image-create-vm.json

      # Get VM details
      $vmPublicIp = az vm show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" `
        --show-details `
        --query "publicIps" `
        --output tsv

      $vmPrivateIp = az vm show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" `
        --show-details `
        --query "privateIps" `
        --output tsv

      Write-Host "[SUCCESS] VM created successfully"
      Write-Host "[INFO] Public IP: $vmPublicIp"
      Write-Host "[INFO] Private IP: $vmPrivateIp"
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/golden-image-00-wrapper.ps1
      rm -f /tmp/golden-image-00-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
