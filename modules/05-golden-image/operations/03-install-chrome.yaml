# ==============================================================================
# Operation: Install Google Chrome
# ==============================================================================
operation:
  id: "golden-image-install-chrome"
  name: "Install Google Chrome"
  description: "Download and install Google Chrome Enterprise on the golden image VM"

  # Duration expectations
  duration:
    expected: 180  # 3 minutes
    timeout: 360   # 6 minutes (fail-fast if exceeds)
    type: "FAST"   # FAST (<5min) or WAIT (10+min)

  # Prerequisites (check state.json)
  requires:
    - operation: "golden-image-install-fslogix"
      status: "completed"

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "file_exists"
        path: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
        description: "Chrome executable installed"

  # Template command (variables substituted at runtime)
  template:
    type: "az-vm-run-command"
    command: |
      az vm run-command invoke \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" \
        --command-id RunPowerShellScript \
        --scripts "@modules/05-golden-image/operations/03-install-chrome.ps1" \
        --output json > artifacts/outputs/golden-image-install-chrome.json

  # PowerShell script (can be inline or external file)
  powershell:
    file: "03-install-chrome.ps1"
    content: |
      # ==============================================================================
      # Install Google Chrome on Golden Image VM
      # ==============================================================================

      Write-Host "[START] Chrome installation: $(Get-Date -Format 'HH:mm:ss')"

      # Configuration
      $chromeUrl = "https://dl.google.com/dl/chrome/install/googlechromestandaloneenterprise64.msi"
      $tempPath = "C:\Temp"
      $chromeMsi = "$tempPath\Chrome.msi"

      try {
          # Step 1: Check for cached installer
          Write-Host "[PROGRESS] Step 1/4: Checking for cached installer..."

          if (Test-Path $chromeMsi) {
              Write-Host "[PROGRESS] Chrome.msi already exists, using cached version"
          }
          else {
              # Step 2: Download Chrome
              Write-Host "[PROGRESS] Step 2/4: Downloading Chrome Enterprise..."
              Invoke-WebRequest -Uri $chromeUrl -OutFile $chromeMsi -UseBasicParsing -TimeoutSec 120 -ErrorAction Stop

              if (-not (Test-Path $chromeMsi)) {
                  Write-Host "[ERROR] Download failed: File not found"
                  exit 1
              }

              Write-Host "[PROGRESS] Download complete ($($(Get-Item $chromeMsi).Length / 1MB) MB)"
          }

          # Step 3: Install Chrome
          Write-Host "[PROGRESS] Step 3/4: Installing Chrome..."
          $process = Start-Process -FilePath "msiexec.exe" -ArgumentList "/i `"$chromeMsi`" /quiet /norestart" -Wait -PassThru -ErrorAction Stop

          if ($process.ExitCode -ne 0 -and $process.ExitCode -ne 3010) {
              Write-Host "[ERROR] Installation failed (exit code: $($process.ExitCode))"
              exit 1
          }

          Write-Host "[PROGRESS] Installation complete"

          # Step 4: Validate installation
          Write-Host "[PROGRESS] Step 4/4: Validating installation..."

          Write-Host "[VALIDATE] Checking Chrome executable..."
          if (-not (Test-Path "C:\Program Files\Google\Chrome\Application\chrome.exe")) {
              Write-Host "[ERROR] Chrome executable not found"
              exit 1
          }

          # Cleanup (optional - keep for cache)
          # Write-Host "[PROGRESS] Cleaning up installer..."
          # Remove-Item -Path $chromeMsi -Force -ErrorAction SilentlyContinue

          Write-Host "[SUCCESS] Google Chrome installed successfully"
          exit 0

      } catch {
          Write-Host "[ERROR] Exception occurred: $($_.Exception.Message)"
          Write-Host "[ERROR] Stack trace: $($_.ScriptStackTrace)"
          exit 1
      }

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
