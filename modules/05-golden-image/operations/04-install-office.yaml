# ==============================================================================
# Operation: Install Microsoft Office 365
# ==============================================================================
operation:
  id: "golden-image-04-install-office"
  name: "04: Install Office 365"
  description: "Download and install Microsoft Office 365 using ODT on the golden image VM"

  # Duration expectations
  duration:
    expected: 1800  # 30 minutes
    timeout: 3600   # 60 minutes (2x expected)
    type: "WAIT"    # FAST (<5min) or WAIT (10+min)

  # Prerequisites (check state.json)
  requires:
    - operation: "golden-image-03-install-apps"
      status: "completed"

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "file_exists"
        path: "C:\\Program Files\\Microsoft Office\\root\\Office16\\WINWORD.EXE"
        description: "Office 365 Word executable installed"

      - type: "file_exists"
        path: "C:\\Program Files\\Microsoft Office\\root\\Office16\\EXCEL.EXE"
        description: "Office 365 Excel executable installed"

      - type: "file_exists"
        path: "C:\\Program Files\\Microsoft Office\\root\\Office16\\OUTLOOK.EXE"
        description: "Office 365 Outlook executable installed"

  # Template command (variables substituted at runtime)
  # NOTE: Uses PowerShell (pwsh) instead of bash for simpler script handling
  template:
    type: "powershell-vm-command"
    command: |
      cat > /tmp/golden-image-04-wrapper.ps1 << 'PSWRAPPER'
      $scriptContent = @'
      {{POWERSHELL_CONTENT}}
      '@
      $tempScript = "/tmp/golden-image-04-install-office-$([guid]::NewGuid()).ps1"
      $scriptContent | Out-File -FilePath $tempScript -Encoding UTF8
      az vm run-command invoke --resource-group "{{AZURE_RESOURCE_GROUP}}" --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" --command-id RunPowerShellScript --scripts "@$tempScript" --output json > artifacts/outputs/golden-image-install-office.json
      if (Test-Path $tempScript) { Remove-Item -Path $tempScript -Force -ErrorAction SilentlyContinue }
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/golden-image-04-wrapper.ps1
      rm -f /tmp/golden-image-04-wrapper.ps1

  # PowerShell script (can be inline or external file)
  powershell:
    file: "04-install-office.ps1"
    content: |
      # ==============================================================================
      # Install Microsoft Office 365 on Golden Image VM
      # ==============================================================================

      Write-Host "[START] Office 365 installation: $(Get-Date -Format 'HH:mm:ss')"

      # Configuration
      $odtUrl = "https://download.microsoft.com/download/2/7/A/27AF1BE6-DD20-4CB4-B154-EBAB8A7D4A7E/officedeploymenttool_17328-20162.exe"
      $tempPath = "C:\Temp"
      $officePath = "$tempPath\Office"
      $odtExe = "$officePath\ODT.exe"

      try {
          # Step 1: Create Office directory
          Write-Host "[PROGRESS] Step 1/7: Creating Office directory..."

          if (!(Test-Path $officePath)) {
              New-Item -Path $officePath -ItemType Directory -Force | Out-Null
              Write-Host "[PROGRESS] Office directory created"
          }
          else {
              Write-Host "[PROGRESS] Office directory already exists"
          }

          # Step 2: Check for cached ODT
          Write-Host "[PROGRESS] Step 2/7: Checking for cached ODT installer..."

          if (Test-Path $odtExe) {
              Write-Host "[PROGRESS] ODT.exe already exists, using cached version"
          }
          else {
              # Step 3: Download Office Deployment Tool
              Write-Host "[PROGRESS] Step 3/7: Downloading Office Deployment Tool..."
              Invoke-WebRequest -Uri $odtUrl -OutFile $odtExe -UseBasicParsing -TimeoutSec 180 -ErrorAction Stop

              if (-not (Test-Path $odtExe)) {
                  Write-Host "[ERROR] Download failed: File not found"
                  exit 1
              }

              Write-Host "[PROGRESS] Download complete ($($(Get-Item $odtExe).Length / 1MB) MB)"
          }

          # Step 4: Extract ODT
          Write-Host "[PROGRESS] Step 4/7: Extracting Office Deployment Tool..."
          $process = Start-Process -FilePath $odtExe -ArgumentList "/quiet /extract:`"$officePath`"" -Wait -PassThru -ErrorAction Stop

          if ($process.ExitCode -ne 0) {
              Write-Host "[ERROR] Extraction failed (exit code: $($process.ExitCode))"
              exit 1
          }

          Write-Host "[PROGRESS] Extraction complete"

          # Step 5: Create Configuration XML
          Write-Host "[PROGRESS] Step 5/7: Creating Office configuration file..."

          $configXml = @"
      <Configuration ID="d473a46c-9126-4f5a-99d8-af03586a67bc">
        <Add OfficeClientEdition="64" Channel="Current">
          <Product ID="O365ProPlusEEANoTeamsRetail">
            <Language ID="en-us" />
            <ExcludeApp ID="Groove" />
            <ExcludeApp ID="Lync" />
            <ExcludeApp ID="OneDrive" />
            <ExcludeApp ID="OneNote" />
            <ExcludeApp ID="OutlookForWindows" />
          </Product>
        </Add>
        <Property Name="SharedComputerLicensing" Value="1" />
        <Property Name="FORCEAPPSHUTDOWN" Value="FALSE" />
        <Property Name="DeviceBasedLicensing" Value="0" />
        <Property Name="SCLCacheOverride" Value="0" />
        <Updates Enabled="FALSE" />
        <RemoveMSI />
        <Display Level="None" AcceptEULA="TRUE" />
      </Configuration>
      "@

          $configPath = "$officePath\Configuration.xml"
          $configXml | Out-File -FilePath $configPath -Encoding UTF8 -ErrorAction Stop

          Write-Host "[PROGRESS] Configuration file created"

          # Step 6: Install Office 365
          Write-Host "[PROGRESS] Step 6/7: Installing Office 365 (this may take 10-30 minutes)..."
          Write-Host "[PROGRESS] Please be patient, no additional output will be shown during installation..."

          $setupPath = "$officePath\setup.exe"
          if (-not (Test-Path $setupPath)) {
              Write-Host "[ERROR] setup.exe not found at: $setupPath"
              exit 1
          }

          $process = Start-Process -FilePath $setupPath -ArgumentList "/configure `"$configPath`"" -Wait -PassThru -WorkingDirectory $officePath -ErrorAction Stop

          if ($process.ExitCode -ne 0) {
              Write-Host "[ERROR] Installation failed (exit code: $($process.ExitCode))"
              exit 1
          }

          Write-Host "[PROGRESS] Installation complete"

          # Step 7: Validate installation
          Write-Host "[PROGRESS] Step 7/7: Validating installation..."

          Write-Host "[VALIDATE] Checking Word executable..."
          if (-not (Test-Path "C:\Program Files\Microsoft Office\root\Office16\WINWORD.EXE")) {
              Write-Host "[ERROR] Word executable not found"
              exit 1
          }

          Write-Host "[VALIDATE] Checking Excel executable..."
          if (-not (Test-Path "C:\Program Files\Microsoft Office\root\Office16\EXCEL.EXE")) {
              Write-Host "[ERROR] Excel executable not found"
              exit 1
          }

          Write-Host "[VALIDATE] Checking Outlook executable..."
          if (-not (Test-Path "C:\Program Files\Microsoft Office\root\Office16\OUTLOOK.EXE")) {
              Write-Host "[ERROR] Outlook executable not found"
              exit 1
          }

          # Cleanup (optional - keep for cache)
          # Write-Host "[PROGRESS] Cleaning up temporary files..."
          # Remove-Item -Path $officePath -Recurse -Force -ErrorAction SilentlyContinue

          Write-Host "[SUCCESS] Microsoft Office 365 installed successfully"
          Write-Host "[SUCCESS] Installed components: Word, Excel, Outlook, PowerPoint (with Shared Computer Licensing)"
          exit 0

      } catch {
          Write-Host "[ERROR] Exception occurred: $($_.Exception.Message)"
          Write-Host "[ERROR] Stack trace: $($_.ScriptStackTrace)"
          exit 1
      }

  # Self-healing: Previous fixes applied to this template
  fixes:
    # Fixes will be added here automatically when errors occur
