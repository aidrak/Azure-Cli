# ==============================================================================
# Operation: Create AVD Workspace
# ==============================================================================
operation:
  id: "hostpool-create-workspace"
  name: "Create AVD Workspace"
  description: "Create the AVD workspace and register the application group to it."

  duration:
    expected: 90
    timeout: 180
    type: "FAST"

  requires:
    - "hostpool-create-app-group"

  template:
    type: "powershell-local"
    command: |
      cat > /tmp/hostpool-04-wrapper.ps1 << 'PSWRAPPER'
      $ErrorActionPreference = 'Stop'

      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $location = "{{AZURE_LOCATION}}"
      $workspaceName = "{{WORKSPACE_NAME}}"
      $workspaceFriendlyName = "{{WORKSPACE_FRIENDLY_NAME}}"
      $workspaceDescription = "{{WORKSPACE_DESCRIPTION}}"
      $appGroupName = "{{APP_GROUP_NAME}}"
      $tags = "environment={{AZURE_ENVIRONMENT}} project=avd-deployment managed_by=azure-cli-automation"

      Write-Host "[START] Starting 'Create AVD Workspace' operation..."

      Write-Host "[PROGRESS] Checking if workspace '$workspaceName' already exists..."
      $workspaceExists = @(az desktopvirtualization workspace show --name $workspaceName --resource-group $resourceGroup --query "[0]" 2>$null | ConvertFrom-Json)

      if ($workspaceExists.Count -eq 0) {
        Write-Host "[PROGRESS] Workspace '$workspaceName' not found. Creating..."
        az desktopvirtualization workspace create `
          --name $workspaceName `
          --resource-group $resourceGroup `
          --location $location `
          --description $workspaceDescription `
          --friendly-name $workspaceFriendlyName `
          --tags $tags `
          --output none
        Write-Host "[SUCCESS] Successfully created workspace '$workspaceName'."
      } else {
        Write-Host "[INFO] Workspace '$workspaceName' already exists."
      }

      Write-Host "[PROGRESS] Ensuring application group '$appGroupName' is registered to the workspace..."
      $appGroupId = az desktopvirtualization applicationgroup show --name $appGroupName --resource-group $resourceGroup --query "id" -o tsv

      az desktopvirtualization workspace update `
        --name $workspaceName `
        --resource-group $resourceGroup `
        --application-group-references $appGroupId `
        --output none

      Write-Host "[SUCCESS] Application group '$appGroupName' is registered to workspace '$workspaceName'."
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/hostpool-04-wrapper.ps1
      rm -f /tmp/hostpool-04-wrapper.ps1
