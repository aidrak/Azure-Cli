# ==============================================================================
# Operation: Validate Host Pool and Workspace
# ==============================================================================
operation:
  id: "hostpool-validate-all"
  name: "Validate Host Pool and Workspace"
  description: "Validate the successful creation and configuration of all resources."

  duration:
    expected: 60
    timeout: 120
    type: "FAST"

  requires:
    - "hostpool-create-workspace"

  template:
    type: "powershell-local"
    command: |
      cat > /tmp/hostpool-05-wrapper.ps1 << 'PSWRAPPER'
      $ErrorActionPreference = 'Stop'

      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $hostPoolName = "{{HOST_POOL_NAME}}"
      $appGroupName = "{{APP_GROUP_NAME}}"
      $workspaceName = "{{WORKSPACE_NAME}}"

      Write-Host "[START] Starting 'Validate Host Pool and Workspace' operation..."

      $allValid = $true

      Write-Host "[VALIDATE] Validating host pool '$hostPoolName'..."
      $poolExists = @(az desktopvirtualization hostpool show --name $hostPoolName --resource-group $resourceGroup --query "[0]" 2>$null | ConvertFrom-Json)

      if ($poolExists.Count -gt 0) {
        Write-Host "[INFO] Host pool '$hostPoolName' exists."
      } else {
        Write-Host "[ERROR] Host pool '$hostPoolName' not found."
        $allValid = $false
      }

      Write-Host "[VALIDATE] Validating application group '$appGroupName'..."
      $appGroupExists = @(az desktopvirtualization applicationgroup show --name $appGroupName --resource-group $resourceGroup --query "[0]" 2>$null | ConvertFrom-Json)

      if ($appGroupExists.Count -gt 0) {
        Write-Host "[INFO] Application group '$appGroupName' exists."
      } else {
        Write-Host "[ERROR] Application group '$appGroupName' not found."
        $allValid = $false
      }

      Write-Host "[VALIDATE] Validating workspace '$workspaceName'..."
      $workspaceExists = @(az desktopvirtualization workspace show --name $workspaceName --resource-group $resourceGroup --query "[0]" 2>$null | ConvertFrom-Json)

      if ($workspaceExists.Count -gt 0) {
        Write-Host "[INFO] Workspace '$workspaceName' exists."
      } else {
        Write-Host "[ERROR] Workspace '$workspaceName' not found."
        $allValid = $false
      }

      if ($allValid) {
        Write-Host "[SUCCESS] All Host Pool and Workspace resources are correctly provisioned."
        exit 0
      } else {
        Write-Host "[ERROR] One or more Host Pool and Workspace resources are missing. Please check the logs."
        exit 1
      }
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/hostpool-05-wrapper.ps1
      rm -f /tmp/hostpool-05-wrapper.ps1
