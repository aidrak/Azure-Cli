# ============================================================================== 
# Operation: Create Desktop Application Group
# ============================================================================== 
operation:
  id: "hostpool-create-app-group"
  name: "Create Desktop Application Group"
  description: "Create a desktop application group and associate it with the host pool."

  duration:
    expected: 90
    timeout: 180
    type: "FAST"

  requires:
    - "hostpool-create-pool"

  template:
    type: "powershell-local"
    command: |
      cat > /tmp/hostpool-03-wrapper.ps1 << 'PSWRAPPER'
      $ErrorActionPreference = 'Stop'

      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $location = "{{AZURE_LOCATION}}"
      $hostPoolName = "{{HOST_POOL_NAME}}"
      $appGroupName = "{{APP_GROUP_NAME}}"
      $appGroupFriendlyName = "{{APP_GROUP_FRIENDLY_NAME}}"
      $tags = "environment={{AZURE_ENVIRONMENT}} project=avd-deployment managed_by=azure-cli-automation"

      Write-Host "[START] Starting 'Create Desktop Application Group' operation..."

      Write-Host "[PROGRESS] Checking if application group '$appGroupName' already exists..."
      $appGroupExists = @(az desktopvirtualization applicationgroup show --name $appGroupName --resource-group $resourceGroup --query "[0]" 2>$null | ConvertFrom-Json)

      if ($appGroupExists.Count -gt 0) {
        Write-Host "[SUCCESS] Application group '$appGroupName' already exists."
        exit 0
      }

      Write-Host "[PROGRESS] Application group '$appGroupName' not found. Creating..."
      $hostPoolId = az desktopvirtualization hostpool show --name $hostPoolName --resource-group $resourceGroup --query "id" -o tsv

      az desktopvirtualization applicationgroup create `
        --name $appGroupName `
        --resource-group $resourceGroup `
        --location $location `
        --application-group-type "Desktop" `
        --host-pool-arm-path $hostPoolId `
        --friendly-name $appGroupFriendlyName `
        --tags $tags `
        --output none

      Write-Host "[SUCCESS] Successfully created application group '$appGroupName'."
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/hostpool-03-wrapper.ps1
      rm -f /tmp/hostpool-03-wrapper.ps1