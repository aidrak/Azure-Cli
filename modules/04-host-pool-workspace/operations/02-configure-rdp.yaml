# ==============================================================================
# Operation: Configure Host Pool RDP Properties
# ==============================================================================
operation:
  id: "hostpool-configure-rdp"
  name: "Configure Host Pool RDP Properties"
  description: "Set custom RDP properties on the host pool for SSO and device redirection."

  duration:
    expected: 60
    timeout: 120
    type: "FAST"

  requires:
    - "hostpool-create-pool"

  template:
    type: "powershell-local"
    command: |
      cat > /tmp/hostpool-02-wrapper.ps1 << 'PSWRAPPER'
      $ErrorActionPreference = 'Stop'

      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $hostPoolName = "{{HOST_POOL_NAME}}"

      Write-Host "[START] Starting 'Configure Host Pool RDP Properties' operation..."

      $rdpProperties = "audiocapturemode:i:0;audiomode:i:0;camerastoredirect:s:*;clipboardredirect:i:1;drivestoredirect:s:;usbdevicestoredirect:s:*;use multimon:i:1;promptcredentialonce:i:0;promptfordestinationcert:i:1;devicestoredirect:s:*"

      Write-Host "[PROGRESS] Applying RDP properties to host pool '$hostPoolName'..."

      az desktopvirtualization hostpool update `
        --name $hostPoolName `
        --resource-group $resourceGroup `
        --custom-rdp-property $rdpProperties `
        --output none

      Write-Host "[SUCCESS] Successfully configured RDP properties on host pool '$hostPoolName'."
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/hostpool-02-wrapper.ps1
      rm -f /tmp/hostpool-02-wrapper.ps1