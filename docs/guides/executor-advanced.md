4. **Saves Script**: Creates manual rollback script in `artifacts/rollback/`
5. **Updates State**: Marks operation as failed in database

### Rollback Execution Order

```yaml
rollback:
  - name: "Step 1"  # Executed THIRD
  - name: "Step 2"  # Executed SECOND
  - name: "Step 3"  # Executed FIRST
```

Rollback steps run in **LIFO** (Last In, First Out) order.

### Manual Rollback Scripts

If automatic rollback fails or you need to re-run rollback later:

```bash
# Automatic rollback creates a script
./artifacts/rollback/rollback_<operation-exec-id>.sh
```

Example script:

```bash
#!/bin/bash
# ==============================================================================
# Rollback Script
# ==============================================================================
# Generated by executor.sh
# Operation: Create Azure Storage Account
# Execution ID: create-storage-account_20251206_143022_Ab3X
# Generated: Fri Dec  6 14:30:45 UTC 2025
# ==============================================================================

# Step: Delete storage account
echo '[*] Executing: Delete storage account'
az storage account delete --name teststorage --resource-group test-rg --yes

echo '[v] Rollback completed'
```

### Best Practices for Rollback

1. **Always Define Rollback**: Even for read-only operations (for consistency)
2. **Test Rollback**: Use dry-run to verify rollback commands are correct
3. **Idempotent Commands**: Use `--yes` flags, check existence before delete
4. **Order Matters**: List rollback steps in logical dependency order

---

## State Tracking

### Operation Records

Every execution creates a record in the `operations` table:

```sql
CREATE TABLE operations (
    id INTEGER PRIMARY KEY,
    operation_id TEXT NOT NULL,
    capability TEXT,
    operation_name TEXT,
    operation_type TEXT,
    resource_id TEXT,
    status TEXT,
    started_at INTEGER,
    completed_at INTEGER,
    duration INTEGER,
    current_step INTEGER,
    total_steps INTEGER,
    step_description TEXT,
    error_message TEXT
);
```

### Operation Lifecycle

```
pending → running → completed (success)
                 ↘ failed (error with rollback)
```

### Querying Operation History

```bash
# Via state-manager.sh
sqlite3 state.db "SELECT operation_id, operation_name, status, duration FROM operations ORDER BY started_at DESC LIMIT 10"
```

### Resource State Updates

After successful execution, if `resource_type` and `resource_name` are defined:

1. Query Azure for latest resource state
2. Store in `resources` table with full JSON
3. Cache for 5 minutes (configurable)
4. Used for prerequisite validation in future operations

---

## Variable Substitution

### Supported Syntax

```bash
${VARIABLE_NAME}    # Bash-style (recommended)
$VARIABLE_NAME      # Also supported
```

### Variable Sources

Variables are loaded from `config.yaml` by `config-manager.sh`:

```yaml
# config.yaml
azure:
  subscription_id: "xxxxx"
  resource_group: "my-rg"

storage:
  account_name: "mystorageacct"
```

Becomes:

```bash
AZURE_SUBSCRIPTION_ID="xxxxx"
AZURE_RESOURCE_GROUP="my-rg"
STORAGE_ACCOUNT_NAME="mystorageacct"
```

### Usage in Operations

```yaml
steps:
  - name: "Create storage account"
    command: "az storage account create --name ${STORAGE_ACCOUNT_NAME} --resource-group ${AZURE_RESOURCE_GROUP} --location ${AZURE_LOCATION}"
```

Resolves to:

```bash
az storage account create --name mystorageacct --resource-group my-rg --location eastus
```

### Environment Variable Override

Runtime variables override config:

```bash
export STORAGE_ACCOUNT_NAME="override-storage"
./core/executor.sh execute operations/create-storage.yaml
# Uses "override-storage" instead of config value
```

---

## Error Handling

### Error Types

| Error Type | Behavior | Example |
|------------|----------|---------|
| **Parse Error** | Operation fails immediately | Invalid YAML syntax |
| **Prerequisite Failure** | Operation fails before execution | Required VNET not found |
| **Step Failure** | Rollback initiated (unless `continue_on_error: true`) | Azure CLI command fails |
| **Rollback Failure** | Logged as warning, manual script saved | Permission denied during delete |

### Exit Codes

```bash
0   # Success
1   # Failure (any error)
```

### Error Logging

All errors are logged to:

1. **Console**: Real-time output
2. **Structured Logs**: `artifacts/logs/deployment_YYYYMMDD.jsonl`
3. **Step Logs**: `artifacts/logs/step_<operation-exec-id>_<step-index>.log`
4. **Database**: `operations` table with error message

### Debugging Failed Operations

```bash
# 1. Check recent operation status
sqlite3 state.db "SELECT operation_id, status, error_message FROM operations WHERE status='failed' ORDER BY started_at DESC LIMIT 5"

# 2. View step logs
cat artifacts/logs/step_create-vm_20251206_143022_Ab3X_2.log

# 3. Check structured logs
cat artifacts/logs/deployment_20251206.jsonl | jq 'select(.level=="ERROR")'

# 4. Run manual rollback if needed
./artifacts/rollback/rollback_create-vm_20251206_143022_Ab3X.sh
```

---

## Examples

### Example 1: Create Virtual Network

```yaml
operation:
  id: "create-vnet"
  name: "Create Virtual Network"
  type: "create"
  resource_type: "Microsoft.Network/virtualNetworks"
  resource_name: "${NETWORKING_VNET_NAME}"

prerequisites: []

steps:
  - name: "Create virtual network"
    command: "az network vnet create --name ${NETWORKING_VNET_NAME} --resource-group ${AZURE_RESOURCE_GROUP} --address-prefixes 10.0.0.0/16"

  - name: "Create subnet"
    command: "az network vnet subnet create --vnet-name ${NETWORKING_VNET_NAME} --name default --resource-group ${AZURE_RESOURCE_GROUP} --address-prefix 10.0.1.0/24"

rollback:
  - name: "Delete virtual network"
    command: "az network vnet delete --name ${NETWORKING_VNET_NAME} --resource-group ${AZURE_RESOURCE_GROUP} --yes"
```

### Example 2: Create VM with Prerequisites

```yaml
operation:
  id: "create-vm"
  name: "Create Virtual Machine"
  type: "create"
  resource_type: "Microsoft.Compute/virtualMachines"
  resource_name: "test-vm-01"

prerequisites:
  - resource_type: "Microsoft.Network/virtualNetworks"
    name_from_config: "NETWORKING_VNET_NAME"

  - resource_type: "Microsoft.Network/networkInterfaces"
    name: "test-vm-01-nic"

steps:
  - name: "Create virtual machine"
    command: "az vm create --name test-vm-01 --resource-group ${AZURE_RESOURCE_GROUP} --nics test-vm-01-nic --image Ubuntu2204 --admin-username azureuser --generate-ssh-keys"

rollback:
  - name: "Delete virtual machine"
    command: "az vm delete --name test-vm-01 --resource-group ${AZURE_RESOURCE_GROUP} --yes"
```

### Example 3: Multi-Step Configuration

```yaml
operation:
  id: "configure-storage-advanced"
  name: "Configure Storage Account - Advanced"
  type: "configure"
  resource_type: "Microsoft.Storage/storageAccounts"
  resource_name: "${STORAGE_ACCOUNT_NAME}"

prerequisites:
  - resource_type: "Microsoft.Storage/storageAccounts"
    name_from_config: "STORAGE_ACCOUNT_NAME"

steps:
  - name: "Enable blob versioning"
    command: "az storage account blob-service-properties update --account-name ${STORAGE_ACCOUNT_NAME} --resource-group ${AZURE_RESOURCE_GROUP} --enable-versioning true"

  - name: "Enable change feed"
    command: "az storage account blob-service-properties update --account-name ${STORAGE_ACCOUNT_NAME} --resource-group ${AZURE_RESOURCE_GROUP} --enable-change-feed true"
    continue_on_error: true

  - name: "Configure default encryption"
    command: "az storage account update --name ${STORAGE_ACCOUNT_NAME} --resource-group ${AZURE_RESOURCE_GROUP} --encryption-key-source Microsoft.Storage"

  - name: "Set minimum TLS version"
    command: "az storage account update --name ${STORAGE_ACCOUNT_NAME} --resource-group ${AZURE_RESOURCE_GROUP} --min-tls-version TLS1_2"

rollback:
  - name: "Disable blob versioning"
    command: "az storage account blob-service-properties update --account-name ${STORAGE_ACCOUNT_NAME} --resource-group ${AZURE_RESOURCE_GROUP} --enable-versioning false"

  - name: "Disable change feed"
    command: "az storage account blob-service-properties update --account-name ${STORAGE_ACCOUNT_NAME} --resource-group ${AZURE_RESOURCE_GROUP} --enable-change-feed false"
```

### Example 4: Delete Operation

```yaml
operation:
  id: "delete-storage"
  name: "Delete Storage Account"
  type: "delete"
  resource_type: "Microsoft.Storage/storageAccounts"
