#!/bin/bash

# ============================================================================
# Golden Image Configuration
# ============================================================================
# This file contains configuration specific to golden image creation.
# It sources the centralized AVD configuration first, then adds/overrides
# golden-image-specific values.
#
# Configuration Priority:
# 1. Environment variables (highest)
# 2. Values set in this file
# 3. Centralized config values (../config/avd-config.sh)
# 4. Script defaults (lowest)
#

# ============================================================================
# Source Centralized Configuration
# ============================================================================
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CENTRAL_CONFIG="${SCRIPT_DIR}/../config/avd-config.sh"

if [ -f "$CENTRAL_CONFIG" ]; then
    echo "Loading centralized config from: $CENTRAL_CONFIG"
    source "$CENTRAL_CONFIG"
fi

# ============================================================================
# Azure Environment (Global/Overridable)
# ============================================================================
export SUBSCRIPTION_ID="${SUBSCRIPTION_ID:-$(az account show --query id -o tsv 2>/dev/null)}"
export RESOURCE_GROUP_NAME="${RESOURCE_GROUP_NAME:-${AVD_RESOURCE_GROUP:-RG-Azure-VDI-01}}"
export LOCATION="${LOCATION:-${AVD_LOCATION:-centralus}}"

# ============================================================================
# Golden Image VM Configuration
# ============================================================================
export TEMP_VM_NAME="${TEMP_VM_NAME:-${AVD_IMAGE_VM_NAME:-gm-temp-vm}}"
export VM_SIZE="${VM_SIZE:-${AVD_VM_SIZE:-Standard_D4s_v6}}"

# Windows Image - IMPORTANT: Update based on your region and requirements
# Common options:
#   - MicrosoftWindowsDesktop:windows-11:win11-25h2-avd:latest
#   - MicrosoftWindowsDesktop:windows-11:win11-23h2-avd:latest
export WINDOWS_IMAGE_SKU="${WINDOWS_IMAGE_SKU:-MicrosoftWindowsDesktop:windows-11:win11-25h2-avd:latest}"

# ============================================================================
# Networking
# ============================================================================
export VNET_NAME="${VNET_NAME:-${AVD_VNET_NAME:-avd-vnet}}"
export SUBNET_NAME="${SUBNET_NAME:-${AVD_SUBNET_SESSION_HOSTS:-avd-subnet}}"

# ============================================================================
# VM Credentials
# ============================================================================
# IMPORTANT: These should come from environment variables, not hardcoded
# Set in your shell before running: export ADMIN_USERNAME="..." export ADMIN_PASSWORD="..."
export ADMIN_USERNAME="${ADMIN_USERNAME:-localadmin}"
export ADMIN_PASSWORD="${ADMIN_PASSWORD:-}"

# Validate credentials are provided
if [ -z "$ADMIN_PASSWORD" ]; then
    echo "WARNING: ADMIN_PASSWORD not set. Set it before running: export ADMIN_PASSWORD=\"...\""
fi

# ============================================================================
# Azure Compute Gallery Configuration
# ============================================================================
export IMAGE_GALLERY_NAME="${IMAGE_GALLERY_NAME:-${AVD_IMAGE_GALLERY_NAME:-avd_gallery}}"
export IMAGE_DEFINITION_NAME="${IMAGE_DEFINITION_NAME:-windows11-golden-image}"
export IMAGE_PUBLISHER="${IMAGE_PUBLISHER:-YourCompany}"
export IMAGE_OFFER="${IMAGE_OFFER:-AVD}"
export IMAGE_SKU_NAME="${IMAGE_SKU_NAME:-Win11-Pooled-FSLogix}"

# ============================================================================
# Software Versions (Pin for reproducibility)
# ============================================================================
export FSLOGIX_VERSION="${FSLOGIX_VERSION:-2.9.8653.48899}"
export VDOT_VERSION="${VDOT_VERSION:-3.8}"

# ============================================================================
# Logging Configuration
# ============================================================================
export LOG_DIR="${LOG_DIR:-${SCRIPT_DIR}/artifacts}"
export LOG_FILE="${LOG_DIR}/deployment-log-$(date +'%Y%m%d_%H%M%S').txt"

# Create log directory if it doesn't exist
mkdir -p "$LOG_DIR"

# ============================================================================
# Optional: Tag Configuration
# ============================================================================
export TAGS="${TAGS:-source=golden-image-script environment=production}"
