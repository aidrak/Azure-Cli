# ==============================================================================
# Error Patterns Database - Self-Healing Fix Registry
# ==============================================================================
#
# Purpose: Known error patterns and their automatic fixes for Claude self-healing
#
# Usage:
#   When an Azure operation fails, Claude reads this file to find a matching
#   pattern and applies the fix_action automatically (if auto_fix: true).
#
# Pattern Format:
#   - id: Unique identifier for the pattern
#   - regex: Regular expression to match error output
#   - description: Human-readable description
#   - auto_fix: Whether Claude should fix automatically (true/false)
#   - fix_action: Instructions for Claude on how to fix
#
# ==============================================================================

patterns:

  # ===========================================================================
  # Template/Variable Errors
  # ===========================================================================

  - id: "template-var-unresolved"
    regex: "\\{\\{[A-Z_]+\\}\\}"
    description: "Template variable not substituted before execution"
    auto_fix: true
    fix_action: |
      The YAML file has unresolved {{VARIABLE}} placeholders in the output.
      Steps to fix:
      1. Identify which variable(s) are unresolved from the error output
      2. Check if the variable exists in standards.yaml under .defaults.*
      3. If missing, add the variable to standards.yaml with appropriate default
      4. If exists but wrong path, update core/value-resolver.sh map_var_to_yaml_path()
      5. Retry the operation

  - id: "config-not-loaded"
    regex: "AZURE_RESOURCE_GROUP.*unbound|AZURE_SUBSCRIPTION_ID.*unbound"
    description: "Configuration not loaded before operation"
    auto_fix: true
    fix_action: |
      The operation was run without loading configuration first.
      Fix: Run the command with config loading prefix:
        source core/config-manager.sh && load_config && ./core/engine.sh run <operation>

  # ===========================================================================
  # Azure CLI Errors
  # ===========================================================================

  - id: "az-cli-arg-unknown"
    regex: "unrecognized arguments: --yes"
    description: "Azure CLI version incompatibility with --yes flag"
    auto_fix: true
    fix_action: |
      The --yes flag is not supported by this az command version.
      Steps to fix:
      1. Find the YAML operation file that contains this az command
      2. Remove the --yes flag from the command
      3. Modern az commands auto-confirm in non-interactive mode
      4. Retry the operation

  - id: "az-cli-extension-missing"
    regex: "extension.*not found|install.*extension"
    description: "Azure CLI extension not installed"
    auto_fix: true
    fix_action: |
      An Azure CLI extension is required but not installed.
      Steps to fix:
      1. Extract the extension name from the error message
      2. Run: az extension add --name <extension-name>
      3. Retry the operation

  - id: "az-cli-not-logged-in"
    regex: "Please run 'az login'|AADSTS|authentication.*failed"
    description: "Not authenticated to Azure"
    auto_fix: false
    fix_action: |
      Cannot auto-fix authentication issues.
      Inform user:
      1. Run: az login
      2. Select the correct subscription: az account set -s <subscription-id>
      3. Verify: az account show
      4. Retry the operation

  # ===========================================================================
  # Azure Resource Errors
  # ===========================================================================

  - id: "resource-not-found"
    regex: "ResourceNotFound|not found in resource group|does not exist"
    description: "Prerequisite resource doesn't exist"
    auto_fix: false
    fix_action: |
      The operation requires a resource that doesn't exist.
      Cannot auto-fix - inform user:
      1. Identify which resource is missing from the error
      2. List available prerequisite operations: ./core/engine.sh list
      3. Run the prerequisite operation first
      4. Then retry this operation

  - id: "resource-conflict"
    regex: "Conflict|already exists|duplicate"
    description: "Resource already exists (idempotency check needed)"
    auto_fix: true
    fix_action: |
      The resource already exists. This may be safe to ignore if idempotent.
      Steps:
      1. Check if the operation is designed to be idempotent
      2. If yes, mark as success and continue
      3. If no, inform user the resource exists

  - id: "quota-exceeded"
    regex: "QuotaExceeded|quota.*limit|exceeded.*quota"
    description: "Azure subscription quota exceeded"
    auto_fix: false
    fix_action: |
      Cannot auto-fix quota issues.
      Inform user:
      1. Check quota: az vm list-usage -l <location> -o table
      2. Request quota increase via Azure portal
      3. Or use a different VM size/region

  # ===========================================================================
  # Permission Errors
  # ===========================================================================

  - id: "auth-failed"
    regex: "AuthorizationFailed|Forbidden|does not have authorization|access.*denied"
    description: "Insufficient Azure permissions"
    auto_fix: false
    fix_action: |
      Cannot auto-fix permission issues.
      Inform user:
      1. Check current role: az role assignment list --assignee <user> -o table
      2. Required roles depend on operation (typically Contributor + User Access Admin)
      3. Contact Azure administrator to grant permissions

  # ===========================================================================
  # VM Run-Command Errors
  # ===========================================================================

  - id: "vm-run-command-busy"
    regex: "Run command extension execution is in progress"
    description: "VM busy with another run-command"
    auto_fix: true
    fix_action: |
      The VM is still processing a previous run-command.
      Do NOT modify any YAML files.
      Steps:
      1. Wait 30 seconds
      2. Retry the exact same operation
      Note: This is transient - the operation should succeed after waiting.

  - id: "vm-not-running"
    regex: "VM.*not running|PowerState.*deallocated|VM.*stopped"
    description: "VM is not in running state"
    auto_fix: true
    fix_action: |
      The target VM is not running.
      Steps:
      1. Start the VM: az vm start -g {{AZURE_RESOURCE_GROUP}} -n <vm-name>
      2. Wait for VM to be ready (60 seconds)
      3. Retry the operation

  - id: "vm-extension-failed"
    regex: "VMExtension.*failed|extension.*provisioning.*failed"
    description: "VM extension installation failed"
    auto_fix: true
    fix_action: |
      A VM extension failed to install.
      Steps:
      1. Check the VM extension status in Azure portal
      2. Delete the failed extension if stuck
      3. Retry the operation

  # ===========================================================================
  # PowerShell Errors
  # ===========================================================================

  - id: "ps-cmdlet-not-found"
    regex: "is not recognized as.*cmdlet|CommandNotFoundException"
    description: "PowerShell cmdlet not available"
    auto_fix: true
    fix_action: |
      The PowerShell script uses a cmdlet not available in the environment.
      Steps:
      1. Identify which cmdlet is missing from the error
      2. Common replacements:
         - Get-AzContext → az account show
         - Get-AzVM → az vm show
         - Get-AzStorageAccount → az storage account show
      3. Edit the YAML operation to use az CLI equivalent
      4. Retry the operation

  - id: "ps-module-not-found"
    regex: "module.*not.*loaded|Import-Module.*failed"
    description: "PowerShell module not available"
    auto_fix: true
    fix_action: |
      The PowerShell script requires a module that isn't installed.
      Steps:
      1. If using Az module, switch to az CLI commands instead
      2. az CLI is more reliable in run-command scenarios
      3. Edit the YAML operation to remove module dependency
      4. Retry the operation

  # ===========================================================================
  # Identity/Entra ID Errors
  # ===========================================================================

  - id: "dynamic-rule-syntax"
    regex: "DynamicGroupQueryParseError|Invalid.*membership.*rule"
    description: "Invalid characters in dynamic group membership rule"
    auto_fix: true
    fix_action: |
      The dynamic membership rule has syntax errors (usually escaping issues).
      Steps:
      1. Find the PowerShell code that sets the membership rule
      2. Fix escaping - use single quotes in PowerShell:
         WRONG: $rule = "(device.displayName -startsWith ""$prefix"")"
         RIGHT: $rule = '(device.displayName -startsWith "' + $prefix + '")'
      3. Edit the YAML operation with corrected escaping
      4. Retry the operation

  - id: "service-principal-not-found"
    regex: "service principal.*not found|application.*not found"
    description: "Service principal or app registration not found"
    auto_fix: false
    fix_action: |
      The required service principal doesn't exist.
      Inform user:
      1. Check if the app registration exists in Entra ID
      2. May need to create the service principal first
      3. Run prerequisite identity operations

  # ===========================================================================
  # Network Errors
  # ===========================================================================

  - id: "subnet-not-found"
    regex: "subnet.*not found|SubnetNotFound"
    description: "Subnet doesn't exist in the VNet"
    auto_fix: false
    fix_action: |
      The specified subnet doesn't exist.
      Inform user:
      1. Check VNet configuration: az network vnet subnet list -g <rg> --vnet-name <vnet>
      2. Verify subnet name in config.yaml matches actual subnet
      3. Create subnet if missing: ./core/engine.sh run networking/subnet-create

  - id: "private-endpoint-conflict"
    regex: "private.*endpoint.*already.*configured|PrivateEndpointCannotBeCreated"
    description: "Private endpoint configuration conflict"
    auto_fix: true
    fix_action: |
      A private endpoint already exists or conflicts.
      Steps:
      1. This is often safe to ignore if the endpoint exists
      2. Verify the existing endpoint is correct
      3. Mark operation as success if endpoint serves the purpose

  # ===========================================================================
  # Storage Errors
  # ===========================================================================

  - id: "storage-key-failed"
    regex: "storage.*key.*failed|SAS.*invalid|storage.*auth"
    description: "Storage account authentication failed"
    auto_fix: false
    fix_action: |
      Cannot auto-fix storage authentication.
      Inform user:
      1. Check storage account exists and is accessible
      2. Verify RBAC permissions on storage account
      3. May need to regenerate storage keys

  # ===========================================================================
  # Generic/Fallback Errors
  # ===========================================================================

  - id: "timeout"
    regex: "timeout|timed out|deadline exceeded"
    description: "Operation timed out"
    auto_fix: true
    fix_action: |
      The operation timed out.
      Steps:
      1. Check if the operation has a timeout setting in the YAML
      2. If timeout is too short, increase it in duration.timeout
      3. Retry the operation (may succeed on retry)

  - id: "json-parse-error"
    regex: "JSON.*parse|invalid.*json|unexpected.*token"
    description: "JSON parsing error in output"
    auto_fix: true
    fix_action: |
      The command output contains invalid JSON.
      Steps:
      1. Add -o json flag to az commands to ensure JSON output
      2. Check for Write-Host statements polluting JSON output
      3. Edit YAML to fix output handling
      4. Retry the operation
