#!/bin/bash

################################################################################
# Entra ID & Group Configuration for AVD Deployment
#
# This file configures Entra ID (Azure AD) security groups, service principals,
# and related configurations for AVD deployments.
################################################################################

# Load centralized configuration first
CENTRALIZED_CONFIG="${CENTRALIZED_CONFIG:-../config/avd-config.sh}"
if [[ -f "$CENTRALIZED_CONFIG" ]]; then
    source "$CENTRALIZED_CONFIG"
fi

# ============================================================================
# AZURE ENVIRONMENT
# ============================================================================

export SUBSCRIPTION_ID="${SUBSCRIPTION_ID:-}"
export TENANT_ID="${TENANT_ID:-}"
export RESOURCE_GROUP_NAME="${RESOURCE_GROUP_NAME:-RG-Azure-VDI-01}"

# ============================================================================
# ENTRA ID SECURITY GROUPS
# ============================================================================

# AVD Users Group
export AVD_USERS_GROUP_NAME="${AVD_USERS_GROUP_NAME:-AVD-Users}"
export AVD_USERS_GROUP_DESCRIPTION="${AVD_USERS_GROUP_DESCRIPTION:-Users with access to AVD deployments}"

# AVD Admins Group
export AVD_ADMINS_GROUP_NAME="${AVD_ADMINS_GROUP_NAME:-AVD-Admins}"
export AVD_ADMINS_GROUP_DESCRIPTION="${AVD_ADMINS_GROUP_DESCRIPTION:-Administrators for AVD deployments}"

# ============================================================================
# SERVICE PRINCIPALS
# ============================================================================

# Automation Service Principal (for unattended deployments)
export AUTOMATION_SP_NAME="${AUTOMATION_SP_NAME:-avd-automation}"
export AUTOMATION_SP_DESCRIPTION="${AUTOMATION_SP_DESCRIPTION:-Service principal for AVD automation}"

# ============================================================================
# ROLE ASSIGNMENTS
# ============================================================================

# Role for session hosts subscription
export SESSION_HOSTS_ROLE="${SESSION_HOSTS_ROLE:-Virtual Machine Contributor}"

# Role for storage account (if using service principal)
export STORAGE_ROLE="${STORAGE_ROLE:-Storage File Data SMB Share Contributor}"

# ============================================================================
# CONDITIONAL ACCESS (OPTIONAL)
# ============================================================================

# Enable Conditional Access policies
export ENABLE_CONDITIONAL_ACCESS="${ENABLE_CONDITIONAL_ACCESS:-false}"

# Require MFA for AVD users
export REQUIRE_MFA="${REQUIRE_MFA:-true}"

# ============================================================================
# TAGS
# ============================================================================

export TAGS="${TAGS:-environment=production owner=infrastructure service=entra-id}"

# ============================================================================
# LOGGING & ARTIFACTS
# ============================================================================

export LOG_LEVEL="${LOG_LEVEL:-INFO}"
export ENABLE_LOGGING="${ENABLE_LOGGING:-1}"
export ARTIFACTS_DIR="${ARTIFACTS_DIR:-artifacts}"

# ============================================================================
# TIMEOUTS
# ============================================================================

export OPERATION_TIMEOUT="${OPERATION_TIMEOUT:-300}"
export POLLING_INTERVAL="${POLLING_INTERVAL:-10}"
