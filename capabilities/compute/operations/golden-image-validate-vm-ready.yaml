# ==============================================================================
# Capability Operation: Validate Golden Image VM Ready
# Migrated from: modules/05-golden-image/operations/01-validate-vm.yaml
# ==============================================================================

operation:
  id: "golden-image-validate-vm-ready"
  name: "Validate Golden Image VM Ready"
  description: "Wait for VM to be fully ready and VM agent to be running for golden image preparation"

  capability: "compute"
  operation_mode: "validate"
  resource_type: "Microsoft.Compute/virtualMachines"

  # Duration expectations
  duration:
    expected: 180   # 3 minutes
    timeout: 600    # 10 minutes (VM agent can take time to start)
    type: "WAIT"

  # Parameters extracted from old operation
  parameters:
    required:
      - name: "vm_name"
        type: "string"
        description: "Name of the virtual machine to validate"
        default: "{{GOLDEN_IMAGE_TEMP_VM_NAME}}"
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
    optional:
      - name: "max_attempts"
        type: "integer"
        description: "Maximum validation attempts"
        default: 20
      - name: "sleep_interval"
        type: "integer"
        description: "Sleep interval between attempts in seconds"
        default: 30

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "vm_agent_ready"
        description: "VM agent is running and responding"

      - type: "run_command_available"
        description: "VM accepts run-command invocations"

  # Idempotency: Check current state
  idempotency:
    enabled: true
    check_command: |
      az vm get-instance-view \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" \
        --query "instanceView.vmAgent.statuses[0].displayStatus" \
        --output tsv 2>/dev/null | grep -q "Ready"
    skip_if_exists: true

  # Template command
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/golden-image-validate-vm-ready-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[INFO] Waiting for VM to be fully ready..."

      $maxAttempts = 20
      $sleepInterval = 30
      $attempt = 0

      while ($attempt -lt $maxAttempts) {
        $attempt++
        Write-Host "[INFO] Attempt $attempt of $maxAttempts`: Checking VM agent status..."

        # Check VM agent status
        $vmAgentStatus = az vm get-instance-view `
          --resource-group "{{AZURE_RESOURCE_GROUP}}" `
          --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" `
          --query "instanceView.vmAgent.statuses[0].displayStatus" `
          --output tsv 2>$null

        Write-Host "[INFO] VM Agent Status: $vmAgentStatus"

        if ($vmAgentStatus -eq "Ready") {
          Write-Host "[SUCCESS] VM agent is ready"

          # Try a simple run-command to verify it's actually working
          Write-Host "[INFO] Testing run-command capability..."
          if (az vm run-command invoke `
            --resource-group "{{AZURE_RESOURCE_GROUP}}" `
            --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" `
            --command-id RunPowerShellScript `
            --scripts "Write-Host 'VM is ready'" `
            --output json > artifacts/outputs/golden-image-validate-vm-ready-test.json 2>&1) {
            Write-Host "[SUCCESS] VM is fully ready and accepting run-commands"
            exit 0
          } else {
            Write-Host "[WARNING] VM agent reports ready but run-command failed, waiting..."
          }
        }

        if ($attempt -lt $maxAttempts) {
          Write-Host "[INFO] Waiting $($sleepInterval)s before next attempt..."
          Start-Sleep -Seconds $sleepInterval
        }
      }

      Write-Host "[ERROR] VM failed to become ready after $($maxAttempts * $sleepInterval) seconds"
      exit 1
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/golden-image-validate-vm-ready-wrapper.ps1
      rm -f /tmp/golden-image-validate-vm-ready-wrapper.ps1

  # Rollback: N/A for validation operations
  rollback:
    enabled: false
    steps: []

  # Self-healing: Previous fixes applied to this template
  fixes: []
