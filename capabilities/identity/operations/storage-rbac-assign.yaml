# ==============================================================================
# Capability Operation: Assign Storage RBAC Permissions for FSLogix
# Migrated from: modules/07-rbac/operations/01-storage-permissions.yaml
# ==============================================================================

operation:
  id: "storage-rbac-assign"
  name: "Assign Storage RBAC Permissions"
  description: "Assign FSLogix file share permissions to standard and admin user groups"

  capability: "identity"
  operation_mode: "create"
  resource_type: "Microsoft.Authorization/roleAssignments"

  # Duration expectations
  duration:
    expected: 120   # 2 minutes
    timeout: 300    # 5 minutes (fail-fast if exceeds)
    type: "FAST"    # FAST (<5min) or WAIT (10+min)

  # Parameters extracted from old operation
  parameters:
    required:
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
      - name: "subscription_id"
        type: "string"
        description: "Azure subscription ID"
        default: "{{AZURE_SUBSCRIPTION_ID}}"
      - name: "storage_file_share_name"
        type: "string"
        description: "Name of the FSLogix file share"
        default: "{{STORAGE_FILE_SHARE_NAME}}"
    optional:
      - name: "std_group_name"
        type: "string"
        description: "Standard users group name"
        default: "{{ENTRA_GROUP_USERS_STANDARD}}"
      - name: "admin_group_name"
        type: "string"
        description: "Admin users group name"
        default: "{{ENTRA_GROUP_USERS_ADMINS}}"

  # Prerequisites (check state.json)
  requires:
    - operation: "account-create"
      status: "completed"
      optional: true  # Storage may have been created previously (operation in storage capability)

    # Note: Removed 'entra-create-groups' dependency as it doesn't exist.
    # This operation will fail if required groups don't exist, which is sufficient validation.

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          $ErrorActionPreference = 'Stop'

          $storageAccount = Get-AzStorageAccount -ResourceGroupName "{{AZURE_RESOURCE_GROUP}}" | Where-Object { $_.StorageAccountName -like 'fslogix*' -or $_.StorageAccountName -eq '{{STORAGE_ACCOUNT_NAME}}' } | Select-Object -First 1

          if (-not $storageAccount) {
            Write-Host "[ERROR] Storage account not found"
            exit 1
          }

          $fileShareId = "/subscriptions/{{AZURE_SUBSCRIPTION_ID}}/resourceGroups/{{AZURE_RESOURCE_GROUP}}/providers/Microsoft.Storage/storageAccounts/$($storageAccount.StorageAccountName)/fileServices/default/fileshares/{{STORAGE_FILE_SHARE_NAME}}"

          $stdGroup = Get-AzADGroup -DisplayName "{{ENTRA_GROUP_USERS_STANDARD}}"

          # Check standard user assignment
          $assignment = Get-AzRoleAssignment -ObjectId $stdGroup.Id -Scope $fileShareId | Where-Object { $_.RoleDefinitionName -eq 'Storage File Data SMB Share Contributor' }

          if ($assignment) {
            Write-Host "[VALIDATE] Standard users have storage permissions"
            exit 0
          } else {
            Write-Host "[ERROR] Standard users storage permissions not found"
            exit 1
          }
        description: "Verify storage permissions are assigned"

  # Idempotency: Check for existing role assignments
  idempotency:
    enabled: true
    check_command: |
      az role assignment list \
        --role "Storage File Data SMB Share Contributor" \
        --output none 2>/dev/null
    skip_if_exists: false  # Check but don't skip (may need to assign)

  # Template command (executed via PowerShell)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/rbac-storage-assign-wrapper.ps1 << 'PSWRAPPER'
      $ErrorActionPreference = 'Stop'

      Write-Host "[START] Storage Permissions Assignment: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $subscriptionId = "{{AZURE_SUBSCRIPTION_ID}}"
      $fileShareName = "{{STORAGE_FILE_SHARE_NAME}}"
      $stdGroupName = "{{ENTRA_GROUP_USERS_STANDARD}}"
      $adminGroupName = "{{ENTRA_GROUP_USERS_ADMINS}}"

      try {
        # Step 1: Validate Azure authentication
        Write-Host "[PROGRESS] Step 1/6: Validating Azure authentication..."
        $context = Get-AzContext
        if (-not $context) {
          Write-Host "[ERROR] Not authenticated to Azure"
          exit 1
        }

        # Step 2: Find storage account (auto-generated name starts with 'fslogix' or explicit name)
        Write-Host "[PROGRESS] Step 2/6: Finding FSLogix storage account..."
        $storageAccount = Get-AzStorageAccount -ResourceGroupName $resourceGroup | Where-Object { $_.StorageAccountName -like 'fslogix*' } | Select-Object -First 1

        if (-not $storageAccount) {
          Write-Host "[ERROR] FSLogix storage account not found in resource group: $resourceGroup"
          Write-Host "[ERROR] Please ensure storage account was created (Module 02)"
          exit 1
        }

        Write-Host "[VALIDATE] Found storage account: $($storageAccount.StorageAccountName)"

        # Get storage account resource ID
        $storageId = $storageAccount.Id

        # Construct file share resource ID
        $fileShareId = "$storageId/fileServices/default/fileshares/$fileShareName"

        Write-Host "[VALIDATE] File share resource ID: $fileShareId"

        # Step 3: Get user group IDs
        Write-Host "[PROGRESS] Step 3/6: Getting user group IDs..."

        $stdGroup = Get-AzADGroup -DisplayName $stdGroupName

        if (-not $stdGroup) {
          Write-Host "[ERROR] Standard users group not found: $stdGroupName"
          Write-Host "[ERROR] Please ensure Entra ID groups were created (Module 03)"
          exit 1
        }

        Write-Host "[VALIDATE] Standard users group ID: $($stdGroup.Id)"

        $adminGroup = Get-AzADGroup -DisplayName $adminGroupName

        if (-not $adminGroup) {
          Write-Host "[ERROR] Admin users group not found: $adminGroupName"
          Write-Host "[ERROR] Please ensure Entra ID groups were created (Module 03)"
          exit 1
        }

        Write-Host "[VALIDATE] Admin users group ID: $($adminGroup.Id)"

        # Step 4: Assign storage permissions to standard users
        Write-Host "[PROGRESS] Step 4/6: Assigning storage permissions to standard users..."
        Write-Host "[PROGRESS] Role: Storage File Data SMB Share Contributor"
        Write-Host "[PROGRESS] Group: $stdGroupName"

        try {
          $null = New-AzRoleAssignment -ObjectId $stdGroup.Id -RoleDefinitionName "Storage File Data SMB Share Contributor" -Scope $fileShareId -ErrorAction Stop
          Write-Host "[SUCCESS] Storage permissions assigned to standard users"
        }
        catch {
          # Check if already exists
          $existing = Get-AzRoleAssignment -ObjectId $stdGroup.Id -Scope $fileShareId | Where-Object { $_.RoleDefinitionName -eq 'Storage File Data SMB Share Contributor' }
          if ($existing) {
            Write-Host "[SUCCESS] Storage permissions already assigned to standard users"
          }
          else {
            Write-Host "[ERROR] Failed to assign storage permissions to standard users"
            Write-Host "[ERROR] $($_.Exception.Message)"
            exit 1
          }
        }

        # Step 5: Assign elevated storage permissions to admin users
        Write-Host "[PROGRESS] Step 5/6: Assigning elevated storage permissions to admin users..."
        Write-Host "[PROGRESS] Role: Storage File Data SMB Share Elevated Contributor"
        Write-Host "[PROGRESS] Group: $adminGroupName"

        try {
          $null = New-AzRoleAssignment -ObjectId $adminGroup.Id -RoleDefinitionName "Storage File Data SMB Share Elevated Contributor" -Scope $fileShareId -ErrorAction Stop
          Write-Host "[SUCCESS] Elevated storage permissions assigned to admin users"
        }
        catch {
          # Check if already exists
          $existing = Get-AzRoleAssignment -ObjectId $adminGroup.Id -Scope $fileShareId | Where-Object { $_.RoleDefinitionName -eq 'Storage File Data SMB Share Elevated Contributor' }
          if ($existing) {
            Write-Host "[SUCCESS] Elevated storage permissions already assigned to admin users"
          }
          else {
            Write-Host "[ERROR] Failed to assign elevated storage permissions to admin users"
            Write-Host "[ERROR] $($_.Exception.Message)"
            exit 1
          }
        }

        # Step 6: Verify assignments
        Write-Host "[PROGRESS] Step 6/6: Verifying role assignments..."

        $stdAssignments = Get-AzRoleAssignment -ObjectId $stdGroup.Id -Scope $fileShareId | Select-Object -ExpandProperty RoleDefinitionName

        $adminAssignments = Get-AzRoleAssignment -ObjectId $adminGroup.Id -Scope $fileShareId | Select-Object -ExpandProperty RoleDefinitionName

        Write-Host "[VALIDATE] Standard users roles: $($stdAssignments -join ', ')"
        Write-Host "[VALIDATE] Admin users roles: $($adminAssignments -join ', ')"

        # Save assignment details
        $reportContent = "\n" + [Environment]::NewLine + "Storage RBAC Assignment Details" + [Environment]::NewLine + "================================" + [Environment]::NewLine + "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "Storage Account:" + [Environment]::NewLine + "  Name: $($storageAccount.StorageAccountName)" + [Environment]::NewLine + "  Resource Group: $resourceGroup" + [Environment]::NewLine + "  File Share: $fileShareName" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "Standard Users ($stdGroupName):" + [Environment]::NewLine + "  Group ID: $($stdGroup.Id)" + [Environment]::NewLine + "  Role: Storage File Data SMB Share Contributor" + [Environment]::NewLine + "  Scope: File Share ($fileShareName)" + [Environment]::NewLine + "  Permissions: Read/Write own FSLogix profile" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "Admin Users ($adminGroupName):" + [Environment]::NewLine + "  Group ID: $($adminGroup.Id)" + [Environment]::NewLine + "  Role: Storage File Data SMB Share Elevated Contributor" + [Environment]::NewLine + "  Scope: File Share ($fileShareName)" + [Environment]::NewLine + "  Permissions: Manage all FSLogix profiles (elevated)" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "Next Steps:" + [Environment]::NewLine + "  1. Assign VM login permissions (next operation)" + [Environment]::NewLine + "  2. Assign application group permissions" + [Environment]::NewLine + "  3. Test user access to FSLogix profiles" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "\n"
        $reportContent | Out-File -FilePath "artifacts/outputs/storage-rbac-assign.txt" -Encoding UTF8

        Write-Host "[SUCCESS] Storage permissions assignment completed"
        exit 0

      } catch {
        Write-Host "[ERROR] Exception occurred: $($_.Exception.Message)"
        Write-Host "[ERROR] Stack trace: $($_.ScriptStackTrace)"
        exit 1
      }
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/rbac-storage-assign-wrapper.ps1
      rm -f /tmp/rbac-storage-assign-wrapper.ps1

  # Rollback: Reverse of creation
  rollback:
    enabled: true
    steps:
      - name: "Remove Storage RBAC Assignments"
        description: "Revoke storage file share role assignments from user groups"
        command: |
          RESOURCE_GROUP="{{AZURE_RESOURCE_GROUP}}"
          STORAGE_ACCOUNT=$(az storage account list --resource-group "$RESOURCE_GROUP" --query "[?starts_with(name, 'fslogix')].name" -o tsv | head -1)

          if [ -n "$STORAGE_ACCOUNT" ]; then
            STORAGE_ID=$(az storage account show --resource-group "$RESOURCE_GROUP" --name "$STORAGE_ACCOUNT" --query id -o tsv)
            FILE_SHARE_ID="$STORAGE_ID/fileServices/default/fileshares/{{STORAGE_FILE_SHARE_NAME}}"

            # Get and remove standard users assignment
            STD_GROUP_ID=$(az ad group list --filter "displayName eq '{{ENTRA_GROUP_USERS_STANDARD}}'" --query "[0].id" -o tsv 2>/dev/null)
            if [ -n "$STD_GROUP_ID" ]; then
              az role assignment delete --assignee "$STD_GROUP_ID" --role "Storage File Data SMB Share Contributor" --scope "$FILE_SHARE_ID" 2>/dev/null || true
            fi

            # Get and remove admin users assignment
            ADMIN_GROUP_ID=$(az ad group list --filter "displayName eq '{{ENTRA_GROUP_USERS_ADMINS}}'" --query "[0].id" -o tsv 2>/dev/null)
            if [ -n "$ADMIN_GROUP_ID" ]; then
              az role assignment delete --assignee "$ADMIN_GROUP_ID" --role "Storage File Data SMB Share Elevated Contributor" --scope "$FILE_SHARE_ID" 2>/dev/null || true
            fi
          fi
        continue_on_error: true

  # Self-healing: Previous fixes applied to this template
  fixes: []
