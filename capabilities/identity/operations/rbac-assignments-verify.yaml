# ==============================================================================
# Capability Operation: Verify RBAC Assignments
# Migrated from: modules/07-rbac/operations/04-verify-assignments.yaml
# ==============================================================================

operation:
  id: "rbac-assignments-verify"
  name: "Verify RBAC Assignments"
  description: "Verify all RBAC role assignments are correctly configured"

  capability: "identity"
  operation_mode: "verify"
  resource_type: "Microsoft.Authorization/roleAssignments"

  # Duration expectations
  duration:
    expected: 60    # 1 minute
    timeout: 180    # 3 minutes (fail-fast if exceeds)
    type: "FAST"    # FAST (<5min) or WAIT (10+min)

  # Parameters extracted from old operation
  parameters:
    required:
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
      - name: "subscription_id"
        type: "string"
        description: "Azure subscription ID"
        default: "{{AZURE_SUBSCRIPTION_ID}}"
    optional:
      - name: "std_group_name"
        type: "string"
        description: "Standard users group name"
        default: "{{ENTRA_GROUP_USERS_STANDARD}}"
      - name: "admin_group_name"
        type: "string"
        description: "Admin users group name"
        default: "{{ENTRA_GROUP_USERS_ADMINS}}"
      - name: "storage_file_share_name"
        type: "string"
        description: "FSLogix file share name"
        default: "{{STORAGE_FILE_SHARE_NAME}}"

  # Prerequisites (check state.json)
  requires:
    - operation: "appgroup-rbac-assign"
      status: "completed"

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          # Final validation that verification file was created
          if (Test-Path "artifacts/outputs/rbac-verification-complete.txt") {
            Write-Host "[VALIDATE] RBAC verification completed"
            exit 0
          } else {
            Write-Host "[ERROR] RBAC verification file not found"
            exit 1
          }
        description: "Verify RBAC verification completed"

  # Template command (executed via PowerShell)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/rbac-verify-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] RBAC Verification: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $subscriptionId = "{{AZURE_SUBSCRIPTION_ID}}"
      $stdGroupName = "{{ENTRA_GROUP_USERS_STANDARD}}"
      $adminGroupName = "{{ENTRA_GROUP_USERS_ADMINS}}"

      # Counters
      $totalChecks = 0
      $passedChecks = 0
      $failedChecks = 0
      $warningChecks = 0

      # Step 1: Validate Azure authentication
      Write-Host "[PROGRESS] Step 1/7: Validating Azure authentication..."
      az account show --output none 2>$null
      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Not authenticated to Azure"
        exit 1
      }

      # Step 2: Get group IDs
      Write-Host "[PROGRESS] Step 2/7: Getting user group IDs..."

      $stdGroupId = az ad group list `
        --filter "displayName eq '$stdGroupName'" `
        --query "[0].id" `
        --output tsv

      $adminGroupId = az ad group list `
        --filter "displayName eq '$adminGroupName'" `
        --query "[0].id" `
        --output tsv

      if ([string]::IsNullOrEmpty($stdGroupId) -or [string]::IsNullOrEmpty($adminGroupId)) {
        Write-Host "[ERROR] Failed to get user group IDs"
        exit 1
      }

      Write-Host "[VALIDATE] Standard users group ID: $stdGroupId"
      Write-Host "[VALIDATE] Admin users group ID: $adminGroupId"

      # Step 3: Get resource IDs
      Write-Host "[PROGRESS] Step 3/7: Getting resource IDs..."

      $rgId = az group show --name $resourceGroup --query id --output tsv

      # Find storage account
      $storageAccount = az storage account list `
        --resource-group $resourceGroup `
        --query "[?starts_with(name, 'fslogix')] | [0].name" `
        --output tsv

      if (-not [string]::IsNullOrEmpty($storageAccount) -and $storageAccount -ne "null") {
        $storageId = az storage account show `
          --resource-group $resourceGroup `
          --name $storageAccount `
          --query id `
          --output tsv
        $fileShareId = "$storageId/fileServices/default/fileshares/{{STORAGE_FILE_SHARE_NAME}}"
      } else {
        Write-Host "[WARNING] Storage account not found - skipping storage checks"
        $fileShareId = ""
      }

      # Find application group
      $appGroupId = az desktopvirtualization applicationgroup list `
        --resource-group $resourceGroup `
        --query "[0].id" `
        --output tsv 2>$null

      if ($LASTEXITCODE -ne 0) {
        $appGroupId = ""
      }

      if ([string]::IsNullOrEmpty($appGroupId) -or $appGroupId -eq "null") {
        Write-Host "[WARNING] Application group not found - skipping app group checks"
        $appGroupId = ""
      }

      # Step 4: Verify storage permissions
      Write-Host "[PROGRESS] Step 4/7: Verifying storage permissions..."

      if (-not [string]::IsNullOrEmpty($fileShareId)) {
        # Standard users - Storage File Data SMB Share Contributor
        $totalChecks++
        $assignment = az role assignment list `
          --assignee $stdGroupId `
          --scope $fileShareId `
          --query "[?roleDefinitionName=='Storage File Data SMB Share Contributor']" `
          --output tsv 2>$null

        if ($LASTEXITCODE -eq 0) {
          $assignment = $assignment.Trim()
        }

        if (-not [string]::IsNullOrEmpty($assignment)) {
          Write-Host "[SUCCESS] [OK] Standard users: Storage File Data SMB Share Contributor"
          $passedChecks++
        } else {
          Write-Host "[WARNING] [WAIT] Standard users: Storage File Data SMB Share Contributor (assignment in progress)"
          $warningChecks++
        }

        # Admin users - Storage File Data SMB Share Elevated Contributor
        $totalChecks++
        $assignment = az role assignment list `
          --assignee $adminGroupId `
          --scope $fileShareId `
          --query "[?roleDefinitionName=='Storage File Data SMB Share Elevated Contributor']" `
          --output tsv 2>$null

        if ($LASTEXITCODE -eq 0) {
          $assignment = $assignment.Trim()
        }

        if (-not [string]::IsNullOrEmpty($assignment)) {
          Write-Host "[SUCCESS] [OK] Admin users: Storage File Data SMB Share Elevated Contributor"
          $passedChecks++
        } else {
          Write-Host "[WARNING] [WAIT] Admin users: Storage File Data SMB Share Elevated Contributor (assignment in progress)"
          $warningChecks++
        }
      } else {
        Write-Host "[WARNING] [SKIP] Storage checks skipped (no storage account found)"
      }

      # Step 5: Verify VM login permissions
      Write-Host "[PROGRESS] Step 5/7: Verifying VM login permissions..."

      # Standard users - Virtual Machine User Login
      $totalChecks++
      $assignment = az role assignment list `
        --assignee $stdGroupId `
        --scope $rgId `
        --query "[?roleDefinitionName=='Virtual Machine User Login']" `
        --output tsv 2>$null

      if ($LASTEXITCODE -eq 0) {
        $assignment = $assignment.Trim()
      }

      if (-not [string]::IsNullOrEmpty($assignment)) {
        Write-Host "[SUCCESS] [OK] Standard users: Virtual Machine User Login"
        $passedChecks++
      } else {
        Write-Host "[WARNING] [WAIT] Standard users: Virtual Machine User Login (assignment in progress)"
        $warningChecks++
      }

      # Admin users - Virtual Machine Administrator Login
      $totalChecks++
      $assignment = az role assignment list `
        --assignee $adminGroupId `
        --scope $rgId `
        --query "[?roleDefinitionName=='Virtual Machine Administrator Login']" `
        --output tsv 2>$null

      if ($LASTEXITCODE -eq 0) {
        $assignment = $assignment.Trim()
      }

      if (-not [string]::IsNullOrEmpty($assignment)) {
        Write-Host "[SUCCESS] [OK] Admin users: Virtual Machine Administrator Login"
        $passedChecks++
      } else {
        Write-Host "[WARNING] [WAIT] Admin users: Virtual Machine Administrator Login (assignment in progress)"
        $warningChecks++
      }

      # Admin users - Desktop Virtualization Power On Off Contributor (optional)
      $totalChecks++
      $assignment = az role assignment list `
        --assignee $adminGroupId `
        --scope $rgId `
        --query "[?roleDefinitionName=='Desktop Virtualization Power On Off Contributor']" `
        --output tsv 2>$null

      if ($LASTEXITCODE -eq 0) {
        $assignment = $assignment.Trim()
      }

      if (-not [string]::IsNullOrEmpty($assignment)) {
        Write-Host "[SUCCESS] [OK] Admin users: Desktop Virtualization Power On Off Contributor"
        $passedChecks++
      } else {
        Write-Host "[WARNING] [WAIT] Admin users: Desktop Virtualization Power On Off Contributor (optional)"
        $warningChecks++
      }

      # Step 6: Verify application group permissions
      Write-Host "[PROGRESS] Step 6/7: Verifying application group permissions..."

      if (-not [string]::IsNullOrEmpty($appGroupId)) {
        # Standard users - Desktop Virtualization User
        $totalChecks++
        $assignment = az role assignment list `
          --assignee $stdGroupId `
          --scope $appGroupId `
          --query "[?roleDefinitionName=='Desktop Virtualization User']" `
          --output tsv 2>$null

        if ($LASTEXITCODE -eq 0) {
          $assignment = $assignment.Trim()
        }

        if (-not [string]::IsNullOrEmpty($assignment)) {
          Write-Host "[SUCCESS] [OK] Standard users: Desktop Virtualization User"
          $passedChecks++
        } else {
          Write-Host "[WARNING] [WAIT] Standard users: Desktop Virtualization User (assignment in progress)"
          $warningChecks++
        }

        # Admin users - Desktop Virtualization User
        $totalChecks++
        $assignment = az role assignment list `
          --assignee $adminGroupId `
          --scope $appGroupId `
          --query "[?roleDefinitionName=='Desktop Virtualization User']" `
          --output tsv 2>$null

        if ($LASTEXITCODE -eq 0) {
          $assignment = $assignment.Trim()
        }

        if (-not [string]::IsNullOrEmpty($assignment)) {
          Write-Host "[SUCCESS] [OK] Admin users: Desktop Virtualization User"
          $passedChecks++
        } else {
          Write-Host "[WARNING] [WAIT] Admin users: Desktop Virtualization User (assignment in progress)"
          $warningChecks++
        }
      } else {
        Write-Host "[WARNING] [SKIP] Application group checks skipped (no app group found)"
      }

      # Step 7: Summary
      Write-Host "[PROGRESS] Step 7/7: Generating summary..."
      Write-Host ""
      Write-Host "=========================================="
      Write-Host "RBAC VERIFICATION SUMMARY"
      Write-Host "=========================================="
      Write-Host "Total Checks: $totalChecks"
      Write-Host "Passed: $passedChecks"
      Write-Host "Failed: $failedChecks"
      Write-Host "Warnings: $warningChecks"
      Write-Host "=========================================="

      # Determine overall status
      if ($failedChecks -eq 0) {
        Write-Host "[SUCCESS] All RBAC assignments verified successfully!"
        $verificationStatus = "PASSED"
        $exitCode = 0
      } else {
        Write-Host "[ERROR] Some RBAC assignments are missing or incorrect"
        Write-Host "[ERROR] Please review the failed checks above"
        $verificationStatus = "FAILED"
        $exitCode = 1
      }

      # Save detailed verification report
      $reportContent = "RBAC Verification Report" + [Environment]::NewLine + "========================" + [Environment]::NewLine + "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" + [Environment]::NewLine + [Environment]::NewLine + "Overall Status: $verificationStatus" + [Environment]::NewLine + [Environment]::NewLine + "Summary:" + [Environment]::NewLine + "  Total Checks: $totalChecks" + [Environment]::NewLine + "  Passed: $passedChecks" + [Environment]::NewLine + "  Failed: $failedChecks" + [Environment]::NewLine + "  Warnings: $warningChecks" + [Environment]::NewLine + [Environment]::NewLine + "Resource Group: $resourceGroup ($rgId)" + [Environment]::NewLine + [Environment]::NewLine + "Standard Users Group:" + [Environment]::NewLine + "  Name: $stdGroupName" + [Environment]::NewLine + "  ID: $stdGroupId" + [Environment]::NewLine + [Environment]::NewLine + "Admin Users Group:" + [Environment]::NewLine + "  Name: $adminGroupName" + [Environment]::NewLine + "  ID: $adminGroupId" + [Environment]::NewLine + [Environment]::NewLine + "Required Permissions (Standard Users):" + [Environment]::NewLine + "  - Storage File Data SMB Share Contributor (file share scope)" + [Environment]::NewLine + "  - Virtual Machine User Login (resource group scope)" + [Environment]::NewLine + "  - Desktop Virtualization User (application group scope)" + [Environment]::NewLine + [Environment]::NewLine + "Required Permissions (Admin Users):" + [Environment]::NewLine + "  - Storage File Data SMB Share Elevated Contributor (file share scope)" + [Environment]::NewLine + "  - Virtual Machine Administrator Login (resource group scope)" + [Environment]::NewLine + "  - Desktop Virtualization User (application group scope)" + [Environment]::NewLine + "  - Desktop Virtualization Power On Off Contributor (optional)" + [Environment]::NewLine + [Environment]::NewLine

      if ($failedChecks -gt 0) {
        $reportContent += "Action Required:" + [Environment]::NewLine + "  Review failed checks above and re-run RBAC assignment operations" + [Environment]::NewLine + [Environment]::NewLine
      } else {
        $reportContent += "Next Steps:" + [Environment]::NewLine + "  1. Add users to appropriate security groups in Entra ID" + [Environment]::NewLine + "  2. Test user access to AVD desktops" + [Environment]::NewLine + "  3. Verify FSLogix profile creation" + [Environment]::NewLine + "  4. Confirm admin users have elevated access" + [Environment]::NewLine + [Environment]::NewLine
      }

      $reportContent += "Troubleshooting:" + [Environment]::NewLine + "  - RBAC changes can take 5-10 minutes to propagate" + [Environment]::NewLine + "  - Users may need to sign out and back in" + [Environment]::NewLine + "  - Check Azure Portal IAM for role assignments" + [Environment]::NewLine + [Environment]::NewLine

      # Report content generated (redirect removed per requirements)

      if ($exitCode -eq 0) {
        Write-Host "[SUCCESS] RBAC verification completed successfully"
      } else {
        Write-Host "[ERROR] RBAC verification failed - see report for details"
      }

      exit $exitCode
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/rbac-verify-wrapper.ps1
      rm -f /tmp/rbac-verify-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes: []
