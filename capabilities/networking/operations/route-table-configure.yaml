# ==============================================================================
# Capability Operation: Configure Route Tables
# Migrated from: modules/01-networking/operations/10-configure-route-tables.yaml
# ==============================================================================

operation:
  id: "route-table-configure"
  name: "Configure Route Tables"
  description: "Create and associate route tables with subnets (if enabled)"
  capability: "networking"
  operation_mode: "create"
  resource_type: "Microsoft.Network/routeTables"
  # Duration expectations
  duration:
    expected: 90 # 1.5 minutes
    timeout: 180 # 3 minutes
    type: "FAST"
  # Prerequisites
  requires:
    - "vnet-peering-create" # VNet peering should be created first
  # Parameters extracted from old operation
  parameters:
    required:
      - name: "vnet_name"
        type: "string"
        description: "Virtual network name containing subnets"
        default: "{{NETWORKING_VNET_NAME}}"
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
      - name: "location"
        type: "string"
        description: "Azure region for the resource"
        default: "{{AZURE_LOCATION}}"
    optional:
      - name: "route_tables_config"
        type: "array"
        description: "Route tables configuration array from config.yaml"
        default: ".networking.route_tables.tables"
      - name: "rt_enabled"
        type: "boolean"
        description: "Whether route tables are enabled"
        default: "{{NETWORKING_ROUTE_TABLES_ENABLED|false}}"
  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "resource_count"
        resource_type: "Microsoft.Network/routeTables"
        min_count: 1
        description: "At least one route table created"
      - type: "provisioning_state"
        expected: "Succeeded"
        description: "Route tables provisioned successfully"
  # Idempotency: Check for existing route tables
  idempotency:
    enabled: true
    check_command: |
      az network route-table list \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --query "length(@)" -o tsv
    skip_if_exists: false # Check count but continue with missing route tables
  # Template command (variables substituted at runtime)
  template:
    type: "powershell-direct"
  # Rollback: Remove route table associations and delete route tables
  rollback:
    enabled: true
    steps:
      - name: "Disassociate Route Tables from Subnets"
        description: "Remove route table associations from subnets"
        command: |
          for subnet in $(az network vnet subnet list \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --vnet-name "{{NETWORKING_VNET_NAME}}" \
            --query "[?routeTable != null].name" -o tsv); do
            az network vnet subnet update \
              --resource-group "{{AZURE_RESOURCE_GROUP}}" \
              --vnet-name "{{NETWORKING_VNET_NAME}}" \
              --name "$subnet" \
              --route-table null \
              --yes 2>/dev/null || true
          done
        continue_on_error: true
      - name: "Delete Route Tables"
        description: "Remove created route tables"
        command: |
          for rt in $(az network route-table list \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --query "[].name" -o tsv); do
            az network route-table delete \
              --resource-group "{{AZURE_RESOURCE_GROUP}}" \
              --name "$rt" \
              --yes 2>/dev/null || true
          done
        continue_on_error: true
  # Self-healing: Previous fixes applied to this template
  fixes: []
  powershell:
    content: |
      Write-Host "[START] Route table configuration: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      $vnetName = "{{NETWORKING_VNET_NAME}}"
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $location = "{{AZURE_LOCATION}}"

      $rtEnabled = (yq e '.networking.route_tables.enabled' config.yaml)

      if ($rtEnabled -ne "true") {
        Write-Host "[INFO] Route tables disabled - skipping"
        exit 0
      }

      $rtCount = [int](yq e '.networking.route_tables.tables | length' config.yaml)
      Write-Host "[PROGRESS] Processing $rtCount route table(s)..."

      for ($i = 0; $i -lt $rtCount; $i++) {
        $rtName = (yq e ".networking.route_tables.tables[$i].name" config.yaml)

        Write-Host "[PROGRESS] Processing route table: $rtName"

        az network route-table show `
          --resource-group $resourceGroup `
          --name $rtName `
          --output none 2>$null

        if ($LASTEXITCODE -ne 0) {
          az network route-table create `
            --resource-group $resourceGroup `
            --name $rtName `
            --location $location `
            --output none

          Write-Host "[SUCCESS] Route table created: $rtName"
        } else {
          Write-Host "[INFO] Route table already exists: $rtName"
        }

        # Add routes
        $routeCount = [int](yq e ".networking.route_tables.tables[$i].routes | length" config.yaml)

        for ($j = 0; $j -lt $routeCount; $j++) {
          $routeName = (yq e ".networking.route_tables.tables[$i].routes[$j].name" config.yaml)
          $addrPrefix = (yq e ".networking.route_tables.tables[$i].routes[$j].address_prefix" config.yaml)
          $nextHopType = (yq e ".networking.route_tables.tables[$i].routes[$j].next_hop_type" config.yaml)
          $nextHopIp = (yq e ".networking.route_tables.tables[$i].routes[$j].next_hop_ip_address" config.yaml)

          az network route-table route show `
            --resource-group $resourceGroup `
            --route-table-name $rtName `
            --name $routeName `
            --output none 2>$null

          if ($LASTEXITCODE -eq 0) {
            continue
          }

          if ($nextHopType -eq "VirtualAppliance") {
            az network route-table route create `
              --resource-group $resourceGroup `
              --route-table-name $rtName `
              --name $routeName `
              --address-prefix $addrPrefix `
              --next-hop-type $nextHopType `
              --next-hop-ip-address $nextHopIp `
              --output none
          } else {
            az network route-table route create `
              --resource-group $resourceGroup `
              --route-table-name $rtName `
              --name $routeName `
              --address-prefix $addrPrefix `
              --next-hop-type $nextHopType `
              --output none
          }

          Write-Host "[SUCCESS] Route added: $routeName"
        }

        # Associate with subnets
        $assocCount = [int](yq e ".networking.route_tables.tables[$i].associated_subnets | length" config.yaml)

        for ($k = 0; $k -lt $assocCount; $k++) {
          $subnetName = (yq e ".networking.route_tables.tables[$i].associated_subnets[$k]" config.yaml)

          az network vnet subnet update `
            --resource-group $resourceGroup `
            --vnet-name $vnetName `
            --name $subnetName `
            --route-table $rtName `
            --output none

          Write-Host "[SUCCESS] Route table associated with subnet: $subnetName"
        }
      }

      Write-Host "[SUCCESS] All route tables configured"
      exit 0
