# ==============================================================================
# Capability Operation: Adopt Existing Virtual Network
# ==============================================================================

operation:
  id: "vnet-adopt"
  name: "Adopt Existing Virtual Network"
  description: "Import existing VNet into toolkit management by tagging and importing to state database"

  capability: "networking"
  operation_mode: "adopt"
  resource_type: "Microsoft.Network/virtualNetworks"

  # Duration expectations
  duration:
    expected: 45        # 45 seconds
    timeout: 120        # 2 minutes
    type: "NORMAL"

  # Parameters for adoption
  parameters:
    required:
      - name: "vnet_name"
        type: "string"
        description: "Name of the existing virtual network to adopt"
        validation: "^[a-zA-Z0-9-]{1,64}$"
      - name: "resource_group"
        type: "string"
        description: "Azure resource group containing the VNet"
        default: "{{AZURE_RESOURCE_GROUP}}"
    optional:
      - name: "tags"
        type: "string"
        description: "Additional tags to apply during adoption (key=value pairs)"
        default: "environment={{AZURE_ENVIRONMENT}}"

  # Validation checks (pre-checks for adopt operations)
  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "Microsoft.Network/virtualNetworks"
        resource_name: "{{vnet_name}}"
        description: "VNet exists and is accessible"

      - type: "provisioning_state"
        expected: "Succeeded"
        description: "VNet is in ready state"

  # Idempotency: Check if already adopted
  idempotency:
    enabled: true
    check_command: |
      az network vnet show \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "{{vnet_name}}" \
        --query "tags.\"managed-by-toolkit\"" \
        --output tsv 2>/dev/null | grep -q "true"
    skip_if_exists: true

  # Template command (tag and import to state db)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/networking-vnet-adopt-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] VNet adoption: {{vnet_name}} at $(Get-Date -Format 'HH:mm:ss')"

      $vnetName = "{{vnet_name}}"
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"

      # Check if VNet exists
      $vnetInfo = az network vnet show `
        --resource-group $resourceGroup `
        --name $vnetName `
        --output json 2>$null

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] VNet not found: $vnetName"
        exit 1
      }

      $vnet = $vnetInfo | ConvertFrom-Json
      $vnetId = $vnet.id
      $location = $vnet.location
      $addressSpace = $vnet.addressSpace.addressPrefixes -join ","

      Write-Host "[PROGRESS] VNet ID: $vnetId"
      Write-Host "[PROGRESS] Location: $location"
      Write-Host "[PROGRESS] Address Space: $addressSpace"

      # Check if already adopted
      $existingTag = az network vnet show `
        --resource-group $resourceGroup `
        --name $vnetName `
        --query "tags.\"managed-by-toolkit\"" `
        --output tsv 2>$null

      if ($existingTag -eq "true") {
        Write-Host "[INFO] VNet already adopted into toolkit management"
        exit 0
      }

      # Tag the VNet with adoption marker
      Write-Host "[PROGRESS] Tagging VNet for toolkit management..."

      az network vnet update `
        --resource-group $resourceGroup `
        --name $vnetName `
        --set tags."managed-by-toolkit"="true" tags."adoption-date"="$(Get-Date -Format 'yyyy-MM-dd')" tags."adoption-timestamp"="$(Get-Date -Format 'o')" `
        --output none 2>&1

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Failed to tag VNet"
        exit 1
      }

      # Verify tagging
      Write-Host "[VALIDATE] Verifying adoption tags..."
      $verifyVnet = az network vnet show `
        --resource-group $resourceGroup `
        --name $vnetName `
        --output json 2>$null

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Failed to verify VNet after tagging"
        exit 1
      }

      $verified = $verifyVnet | ConvertFrom-Json
      $managedTag = $verified.tags."managed-by-toolkit"

      if ($managedTag -ne "true") {
        Write-Host "[ERROR] Adoption tag verification failed"
        exit 1
      }

      # Export adoption information for state database
      if (-not (Test-Path "artifacts/state")) {
        New-Item -ItemType Directory -Path "artifacts/state" -Force | Out-Null
      }

      $adoptionRecord = @{
        resource_id = $vnetId
        resource_name = $vnetName
        resource_group = $resourceGroup
        capability = "networking"
        operation = "vnet-adopt"
        adopted_at = Get-Date -Format "o"
        address_space = $addressSpace
        location = $location
      } | ConvertTo-Json

      $adoptionRecord | Out-File -FilePath "artifacts/state/vnet-adopt-$($vnetName).json" -Encoding UTF8

      Write-Host "[SUCCESS] VNet adopted into toolkit management"
      Write-Host "[INFO] Resource ID: $vnetId"
      Write-Host "[INFO] Address Space: $addressSpace"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/networking-vnet-adopt-wrapper.ps1
      rm -f /tmp/networking-vnet-adopt-wrapper.ps1

  # Rollback: Remove adoption tag and state record
  rollback:
    enabled: true
    steps:
      - name: "Remove Adoption Tag"
        description: "Remove the managed-by-toolkit tag from VNet"
        command: |
          az network vnet update \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --name "{{vnet_name}}" \
            --remove tags."managed-by-toolkit" tags."adoption-date" tags."adoption-timestamp" \
            --output none
        continue_on_error: false

      - name: "Remove State Records"
        description: "Remove adoption record from state database"
        command: |
          rm -f artifacts/state/vnet-adopt-{{vnet_name}}.json
        continue_on_error: true

  # Self-healing: Previous fixes applied to this template
  fixes: []
