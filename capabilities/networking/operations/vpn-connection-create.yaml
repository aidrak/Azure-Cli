# ==============================================================================
# Capability Operation: Create VPN Connections
# Migrated from: modules/01-networking/operations/15-create-vpn-connections.yaml
# ==============================================================================

operation:
  id: "vpn-connection-create"
  name: "Create VPN Connections"
  description: "Create VPN connections between VPN Gateway and Local Network Gateways (if enabled)"

  capability: "networking"
  operation_mode: "create"
  resource_type: "Microsoft.Network/connections"

  # Duration expectations
  duration:
    expected: 180     # 3 minutes
    timeout: 360      # 6 minutes
    type: "FAST"

  # Dependencies
  requires:
    - "vpn-gateway-create"
    - "local-network-gateway-create"

  # Parameters extracted from old operation
  parameters:
    required:
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
    optional:
      - name: "vpn_connections_config"
        type: "array"
        description: "VPN connections configuration from config.yaml"
        default: ".networking.vpn_connections"

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "resource_count"
        resource_type: "Microsoft.Network/connections"
        min_count: 1
        description: "At least one VPN connection created"

      - type: "provisioning_state"
        expected: "Succeeded"
        description: "VPN connections provisioned successfully"

  # Idempotency: Check for existing resources
  idempotency:
    enabled: true
    check_command: |
      az network vpn-connection show \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "$(yq e '.networking.vpn_connections.connections[0].name' config.yaml)" \
        --output none 2>/dev/null
    skip_if_exists: false  # Check but continue if missing

  # Template command (variables substituted at runtime)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/networking-vpn-connection-create-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] VPN Connection creation: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $gatewayName = (yq e '.networking.vpn_gateway.name' config.yaml)

      # Check if VPN connections are enabled
      $vpnConnEnabled = (yq e '.networking.vpn_connections.enabled' config.yaml)

      if ($vpnConnEnabled -ne "true") {
        Write-Host "[INFO] VPN Connections disabled - skipping"
        exit 0
      }

      # Check if gateway exists first
      az network vnet-gateway show `
        --resource-group $resourceGroup `
        --name $gatewayName `
        --output none 2>$null

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] VPN Gateway does not exist: $gatewayName"
        Write-Host "[INFO] Please ensure VPN Gateway is created before creating connections"
        exit 1
      }

      $connectionCount = [int](yq e '.networking.vpn_connections.connections | length' config.yaml)
      Write-Host "[PROGRESS] Creating $connectionCount VPN connection(s)..."

      for ($i = 0; $i -lt $connectionCount; $i++) {
        $connName = (yq e ".networking.vpn_connections.connections[$i].name" config.yaml)
        $lngName = (yq e ".networking.vpn_connections.connections[$i].local_network_gateway_name" config.yaml)
        $connType = (yq e ".networking.vpn_connections.connections[$i].connection_type" config.yaml)
        $enableBgp = (yq e ".networking.vpn_connections.connections[$i].enable_bgp" config.yaml)
        $sharedKey = (yq e ".networking.vpn_connections.connections[$i].shared_key" config.yaml)

        Write-Host "[PROGRESS] Processing connection: $connName"

        # Check if connection already exists
        az network vpn-connection show `
          --resource-group $resourceGroup `
          --name $connName `
          --output none 2>$null

        if ($LASTEXITCODE -eq 0) {
          Write-Host "[INFO] VPN Connection already exists: $connName"
          continue
        }

        # Validate that local network gateway exists
        az network local-gateway show `
          --resource-group $resourceGroup `
          --name $lngName `
          --output none 2>$null

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Local Network Gateway does not exist: $lngName"
          exit 1
        }

        # Build create command
        $createCmd = "az network vpn-connection create " +
          "--name $connName " +
          "--resource-group $resourceGroup " +
          "--vnet-gateway1 $gatewayName " +
          "--local-gateway2 $lngName"

        if ($sharedKey -and $sharedKey -ne "") {
          $createCmd += " --shared-key '$sharedKey'"
        } else {
          Write-Host "[WARN] No shared key configured for $connName - connection may fail"
        }

        if ($enableBgp -eq "true") {
          $createCmd += " --enable-bgp"
        }

        $createCmd += " --output none"

        Write-Host "[PROGRESS] Creating VPN connection: $connName"
        Invoke-Expression $createCmd

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Failed to create VPN connection: $connName"
          exit 1
        }

        Write-Host "[SUCCESS] VPN connection created: $connName"
      }

      Write-Host "[SUCCESS] All VPN connections created"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/networking-vpn-connection-create-wrapper.ps1
      rm -f /tmp/networking-vpn-connection-create-wrapper.ps1

  # Rollback: Reverse of creation
  rollback:
    enabled: true
    steps:
      - name: "Delete VPN Connections"
        description: "Remove created VPN connections"
        command: |
          for conn in $(az network vpn-connection list \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --query "[].name" -o tsv); do
            az network vpn-connection delete \
              --resource-group "{{AZURE_RESOURCE_GROUP}}" \
              --name "$conn" \
              --yes
          done
        continue_on_error: false

  # Self-healing: Previous fixes applied to this template
  fixes: []
