# ==============================================================================
# Capability Operation: Create Virtual Network
# Migrated from: modules/01-networking/operations/01-create-vnet.yaml
# ==============================================================================

operation:
  id: "vnet-create"
  name: "Create Virtual Network"
  description: "Create Azure VNet with configured address space"
  capability: "networking"
  operation_mode: "create"
  resource_type: "Microsoft.Network/virtualNetworks"
  # Duration expectations
  duration:
    expected: 60 # 1 minute
    timeout: 120 # 2 minutes (fail-fast if exceeds)
    type: "FAST" # FAST (<5min), NORMAL (5-10min), or WAIT (10+min)
  # Parameters extracted from old operation
  parameters:
    required:
      - name: "vnet_name"
        type: "string"
        description: "Name of the virtual network"
        default: "{{NETWORKING_VNET_NAME}}"
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
      - name: "location"
        type: "string"
        description: "Azure region for the resource"
        default: "{{AZURE_LOCATION}}"
    optional:
      - name: "address_space"
        type: "string"
        description: "Address space for the VNet"
        default: "{{NETWORKING_VNET_ADDRESS_SPACE}}"
      - name: "dns_servers"
        type: "string"
        description: "Custom DNS servers (space-separated)"
        default: "{{NETWORKING_DNS_SERVERS}}"
  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "Microsoft.Network/virtualNetworks"
        resource_name: "{{NETWORKING_VNET_NAME}}"
        description: "VNet exists"
      - type: "provisioning_state"
        expected: "Succeeded"
        description: "VNet provisioned successfully"
  # Idempotency: Check for existing resource
  idempotency:
    enabled: true
    check_command: |
      az network vnet show \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "{{NETWORKING_VNET_NAME}}" \
        --output none 2>/dev/null
    skip_if_exists: true
  # Template command (variables substituted at runtime)
  template:
    type: "powershell-direct"
  # Rollback: Reverse of creation
  rollback:
    enabled: true
    steps:
      - name: "Delete Virtual Network"
        description: "Remove the VNet and associated resources"
        command: |
          az network vnet delete \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --name "{{NETWORKING_VNET_NAME}}" \
            --yes
        continue_on_error: false
  # Self-healing: Previous fixes applied to this template
  fixes: []
  powershell:
    content: |
      Write-Host "[START] VNet creation: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $vnetName = "{{NETWORKING_VNET_NAME}}"
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $location = "{{AZURE_LOCATION}}"

      # Parse address space from config.yaml
      $addressSpace = (yq e '.networking.vnet.address_space | join(" ")' config.yaml)

      # Parse custom DNS servers (if configured)
      $dnsServersCount = [int](yq e '.networking.vnet.dns_servers | length' config.yaml)
      $dnsServers = ""

      if ($dnsServersCount -gt 0) {
        $dnsServers = (yq e '.networking.vnet.dns_servers | join(" ")' config.yaml)
      }

      # Check if VNet already exists (idempotent)
      Write-Host "[PROGRESS] Checking if VNet exists..."
      az network vnet show `
        --resource-group $resourceGroup `
        --name $vnetName `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[INFO] VNet already exists: $vnetName"
        Write-Host "[SUCCESS] VNet creation complete (already exists)"
        exit 0
      }

      # Create VNet
      Write-Host "[PROGRESS] Creating VNet: $vnetName"
      Write-Host "[PROGRESS]   Address space: $addressSpace"
      Write-Host "[PROGRESS]   Location: $location"

      if (-not [string]::IsNullOrEmpty($dnsServers)) {
        Write-Host "[PROGRESS]   Custom DNS servers: $dnsServers"

        $addressPrefixArray = $addressSpace -split ' '
        $dnsServerArray = $dnsServers -split ' '

        az network vnet create `
          --resource-group $resourceGroup `
          --name $vnetName `
          --address-prefixes @addressPrefixArray `
          --location $location `
          --dns-servers @dnsServerArray `
          --output json
      } else {
        $addressPrefixArray = $addressSpace -split ' '

        az network vnet create `
          --resource-group $resourceGroup `
          --name $vnetName `
          --address-prefixes @addressPrefixArray `
          --location $location `
          --output json
      }

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Failed to create VNet"
        exit 1
      }

      # Validate creation
      Write-Host "[VALIDATE] Checking VNet provisioning state..."
      $provisioningState = az network vnet show `
        --resource-group $resourceGroup `
        --name $vnetName `
        --query "provisioningState" -o tsv

      if ($provisioningState -ne "Succeeded") {
        Write-Host "[ERROR] VNet provisioning failed: $provisioningState"
        exit 1
      }

      # Get VNet ID for reference
      $vnetId = az network vnet show `
        --resource-group $resourceGroup `
        --name $vnetName `
        --query "id" -o tsv

      Write-Host "[SUCCESS] VNet created successfully"
      Write-Host "[SUCCESS]   Name: $vnetName"
      Write-Host "[SUCCESS]   ID: $vnetId"
      Write-Host "[SUCCESS]   State: $provisioningState"
      exit 0
