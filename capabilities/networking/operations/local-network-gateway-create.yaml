# ==============================================================================
# Capability Operation: Create Local Network Gateways
# Migrated from: modules/01-networking/operations/13-create-local-network-gateways.yaml
# ==============================================================================

operation:
  id: "local-network-gateway-create"
  name: "Create Local Network Gateways"
  description: "Create local network gateways for on-premises or remote sites (if enabled)"
  capability: "networking"
  operation_mode: "create"
  resource_type: "Microsoft.Network/localNetworkGateways"
  # Duration expectations
  duration:
    expected: 120 # 2 minutes
    timeout: 240 # 4 minutes
    type: "FAST"
  # Dependencies
  requires:
    - "gateway-subnet-create"
  # Parameters extracted from old operation
  parameters:
    required:
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
    optional:
      - name: "lngs_config"
        type: "array"
        description: "Local network gateways configuration from config.yaml"
        default: ".networking.local_network_gateways"
  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "resource_count"
        resource_type: "Microsoft.Network/localNetworkGateways"
        min_count: 1
        description: "At least one local network gateway created"
      - type: "provisioning_state"
        expected: "Succeeded"
        description: "Local network gateways provisioned successfully"
  # Idempotency: Check for existing resources
  idempotency:
    enabled: true
    check_command: |
      az network local-gateway show \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "$(yq e '.networking.local_network_gateways.gateways[0].name' config.yaml)" \
        --output none 2>/dev/null
    skip_if_exists: false # Check but continue if missing
  # Template command (variables substituted at runtime)
  template:
    type: "powershell-direct"
  # Rollback: Reverse of creation
  rollback:
    enabled: true
    steps:
      - name: "Delete Local Network Gateways"
        description: "Remove created local network gateways"
        command: |
          for gateway in $(az network local-gateway list \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --query "[].name" -o tsv); do
            az network local-gateway delete \
              --resource-group "{{AZURE_RESOURCE_GROUP}}" \
              --name "$gateway" \
              --yes
          done
        continue_on_error: false
  # Self-healing: Previous fixes applied to this template
  fixes: []
  powershell:
    content: |
      Write-Host "[START] Local Network Gateway creation: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"

      # Check if local network gateways are enabled
      $lngEnabled = (yq e '.networking.local_network_gateways.enabled' config.yaml)

      if ($lngEnabled -ne "true") {
        Write-Host "[INFO] Local Network Gateways disabled - skipping"
        exit 0
      }

      $gatewayCount = [int](yq e '.networking.local_network_gateways.gateways | length' config.yaml)
      Write-Host "[PROGRESS] Creating $gatewayCount local network gateway(s)..."

      for ($i = 0; $i -lt $gatewayCount; $i++) {
        $lngName = (yq e ".networking.local_network_gateways.gateways[$i].name" config.yaml)
        $gatewayAddress = (yq e ".networking.local_network_gateways.gateways[$i].gateway_address" config.yaml)

        Write-Host "[PROGRESS] Processing local network gateway: $lngName"

        # Check if gateway already exists
        az network local-gateway show `
          --resource-group $resourceGroup `
          --name $lngName `
          --output none 2>$null

        if ($LASTEXITCODE -eq 0) {
          Write-Host "[INFO] Local network gateway already exists: $lngName"
          continue
        }

        # Build address spaces string
        $addressSpaceCount = [int](yq e ".networking.local_network_gateways.gateways[$i].address_spaces | length" config.yaml)
        $addressSpaces = @()
        for ($j = 0; $j -lt $addressSpaceCount; $j++) {
          $prefix = (yq e ".networking.local_network_gateways.gateways[$i].address_spaces[$j]" config.yaml)
          $addressSpaces += $prefix
        }

        $addressSpacesStr = $addressSpaces -join " "

        # Check if BGP is enabled for this gateway
        $bgpEnabled = (yq e ".networking.local_network_gateways.gateways[$i].bgp_settings.enabled" config.yaml)

        $createCmd = "az network local-gateway create " +
          "--resource-group $resourceGroup " +
          "--name $lngName " +
          "--gateway-ip-address $gatewayAddress " +
          "--local-address-prefixes $addressSpacesStr"

        if ($bgpEnabled -eq "true") {
          $bgpAsn = (yq e ".networking.local_network_gateways.gateways[$i].bgp_settings.asn" config.yaml)
          $createCmd += " --asn $bgpAsn --bgp-peering-address 192.168.1.1"
        }

        $createCmd += " --output none"

        Write-Host "[PROGRESS] Creating gateway with command: $createCmd"
        Invoke-Expression $createCmd

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Failed to create local network gateway: $lngName"
          exit 1
        }

        Write-Host "[SUCCESS] Local network gateway created: $lngName"
      }

      Write-Host "[SUCCESS] All local network gateways created"
      exit 0
