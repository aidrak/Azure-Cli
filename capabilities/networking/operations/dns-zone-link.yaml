# ==============================================================================
# Capability Operation: Link Private DNS Zones to VNet
# Migrated from: modules/01-networking/operations/08-link-dns-zones.yaml
# ==============================================================================

operation:
  id: "dns-zone-link"
  name: "Link Private DNS Zones to VNet"
  description: "Create VNet links for private DNS zones"
  capability: "networking"
  operation_mode: "update"
  resource_type: "Microsoft.Network/privateDnsZones/virtualNetworkLinks"
  # Duration expectations
  duration:
    expected: 90 # 1.5 minutes
    timeout: 180 # 3 minutes
    type: "FAST"
  # Prerequisites
  requires:
    - "dns-zone-create" # DNS zones must be created first
  # Parameters extracted from old operation
  parameters:
    required:
      - name: "vnet_name"
        type: "string"
        description: "Virtual network name to link to DNS zones"
        default: "{{NETWORKING_VNET_NAME}}"
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
    optional:
      - name: "dns_zones_config"
        type: "array"
        description: "Private DNS zones configuration array from config.yaml"
        default: ".networking.private_dns.zones"
      - name: "dns_enabled"
        type: "boolean"
        description: "Whether private DNS is enabled"
        default: "{{NETWORKING_PRIVATE_DNS_ENABLED|false}}"
  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "Microsoft.Network/privateDnsZones/virtualNetworkLinks"
        description: "VNet links exist for DNS zones"
      - type: "provisioning_state"
        expected: "Succeeded"
        description: "VNet link updates completed successfully"
  # Idempotency: Check for existing VNet links
  idempotency:
    enabled: true
    check_command: |
      az network private-dns link vnet list \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --zone-name "test" \
        --query "length(@)" -o tsv 2>/dev/null || echo "0"
    skip_if_exists: false # Check but continue with unlinked zones
  # Template command (variables substituted at runtime)
  template:
    type: "powershell-direct"
  # Rollback: Remove VNet links from DNS zones
  rollback:
    enabled: true
    steps:
      - name: "Remove VNet Links from DNS Zones"
        description: "Delete VNet links from private DNS zones"
        command: |
          for zone in $(az network private-dns zone list \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --query "[].name" -o tsv); do
            for link in $(az network private-dns link vnet list \
              --resource-group "{{AZURE_RESOURCE_GROUP}}" \
              --zone-name "$zone" \
              --query "[].name" -o tsv); do
              az network private-dns link vnet delete \
                --resource-group "{{AZURE_RESOURCE_GROUP}}" \
                --zone-name "$zone" \
                --name "$link" \
                --yes 2>/dev/null || true
            done
          done
        continue_on_error: true
  # Self-healing: Previous fixes applied to this template
  fixes: []
  powershell:
    content: |
      Write-Host "[START] DNS zone linking: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      $vnetName = "{{NETWORKING_VNET_NAME}}"
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"

      $dnsEnabled = (yq e '.networking.private_dns.enabled' config.yaml)

      if ($dnsEnabled -ne "true") {
        Write-Host "[INFO] Private DNS disabled - skipping"
        exit 0
      }

      $zoneCount = [int](yq e '.networking.private_dns.zones | length' config.yaml)
      Write-Host "[PROGRESS] Linking $zoneCount DNS zone(s) to VNet..."

      for ($i = 0; $i -lt $zoneCount; $i++) {
        $zoneName = (yq e ".networking.private_dns.zones[$i].name" config.yaml)
        $linkToVnet = (yq e ".networking.private_dns.zones[$i].link_to_vnet" config.yaml)

        if ($linkToVnet -ne "true") {
          Write-Host "[INFO] Skipping VNet link for zone: $zoneName"
          continue
        }

        $linkName = "$zoneName-vnet-link"

        Write-Host "[PROGRESS] Linking zone to VNet: $zoneName"

        az network private-dns link vnet show `
          --resource-group $resourceGroup `
          --zone-name $zoneName `
          --name $linkName `
          --output none 2>$null

        if ($LASTEXITCODE -eq 0) {
          Write-Host "[INFO] VNet link already exists: $linkName"
          continue
        }

        az network private-dns link vnet create `
          --resource-group $resourceGroup `
          --zone-name $zoneName `
          --name $linkName `
          --virtual-network $vnetName `
          --registration-enabled false `
          --output none

        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Failed to link zone: $zoneName"
          exit 1
        }

        Write-Host "[SUCCESS] Zone linked: $zoneName"
      }

      Write-Host "[SUCCESS] All DNS zones linked to VNet"
      exit 0
