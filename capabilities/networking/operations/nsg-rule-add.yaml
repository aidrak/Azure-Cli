# ==============================================================================
# Capability Operation: Add NSG Rule to Network Security Group
# Operation ID: 34
# ==============================================================================

operation:
  id: "nsg-rule-add"
  name: "Add Rule to Network Security Group"
  description: "Add a new security rule to an existing NSG for inbound or outbound traffic control"

  capability: "networking"
  operation_mode: "modify"
  resource_type: "Microsoft.Network/networkSecurityGroups/securityRules"

  # Duration expectations
  duration:
    expected: 30
    timeout: 120
    type: "WAIT"

  # Parameters
  parameters:
    required:
      - name: "nsg_name"
        type: "string"
        description: "Name of the network security group"
        validation: "^[a-zA-Z0-9][a-zA-Z0-9-]{0,79}$"
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
      - name: "rule_name"
        type: "string"
        description: "Name of the security rule"
        validation: "^[a-zA-Z0-9][a-zA-Z0-9-]{0,79}$"
      - name: "direction"
        type: "string"
        description: "Traffic direction (Inbound or Outbound)"
        allowed_values: ["Inbound", "Outbound"]
      - name: "priority"
        type: "integer"
        description: "Priority of the rule (100-4096, lower = higher priority)"
        validation: "^(10[0-9]|[1-9][0-9]{2}|[1-3][0-9]{3}|40[0-9]{2}|409[0-5])$"
      - name: "access"
        type: "string"
        description: "Action to take (Allow or Deny)"
        allowed_values: ["Allow", "Deny"]
    optional:
      - name: "protocol"
        type: "string"
        description: "Network protocol (Tcp, Udp, Icmp, Esp, or *)"
        allowed_values: ["Tcp", "Udp", "Icmp", "Esp", "*"]
        default: "Tcp"
      - name: "source_address_prefix"
        type: "string"
        description: "Source IP address/range (CIDR format or * for any)"
        default: "*"
      - name: "source_port_range"
        type: "string"
        description: "Source port range (* for any)"
        default: "*"
      - name: "destination_address_prefix"
        type: "string"
        description: "Destination IP address/range (CIDR format or * for any)"
        default: "*"
      - name: "destination_port_range"
        type: "string"
        description: "Destination port or range (e.g., 80, 443, 80-443, *)"
        default: "*"
      - name: "description"
        type: "string"
        description: "Description of the security rule"

  # Validation checks
  validation:
    pre_checks:
      - type: "resource_exists"
        resource_type: "Microsoft.Network/networkSecurityGroups"
        resource_name: "{{nsg_name}}"
        error_message: "Network security group '{{nsg_name}}' not found"

    post_checks:
      - type: "provisioning_state"
        expected: "Succeeded"
        timeout: 120

  # Idempotency
  idempotency:
    enabled: true
    detection_method: "azure_check"
    check_command: |
      az network nsg rule show \
        --nsg-name "{{nsg_name}}" \
        --name "{{rule_name}}" \
        --resource-group "{{resource_group}}" \
        --output none 2>/dev/null

  # Template command
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/nsg-rule-add-wrapper.ps1 << 'PSWRAPPER'
      $ErrorActionPreference = 'Stop'

      $nsgName = "{{nsg_name}}"
      $resourceGroup = "{{resource_group}}"
      $ruleName = "{{rule_name}}"
      $direction = "{{direction}}"
      $priority = [int]"{{priority}}"
      $access = "{{access}}"
      $protocol = "{{protocol}}"
      $sourceAddressPrefix = "{{source_address_prefix}}"
      $sourcePortRange = "{{source_port_range}}"
      $destinationAddressPrefix = "{{destination_address_prefix}}"
      $destinationPortRange = "{{destination_port_range}}"
      $description = "{{description}}"

      Write-Host "[START] Starting 'Add NSG Rule' operation..."

      Write-Host "[PROGRESS] Verifying NSG '$nsgName' exists..."
      $nsg = az network nsg show `
        --name $nsgName `
        --resource-group $resourceGroup `
        --output none 2>&1

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Network security group '$nsgName' not found"
        exit 1
      }

      Write-Host "[PROGRESS] Checking if rule '$ruleName' already exists..."
      $existingRule = az network nsg rule show `
        --nsg-name $nsgName `
        --name $ruleName `
        --resource-group $resourceGroup `
        --output none 2>&1

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] Rule '$ruleName' already exists in NSG '$nsgName'"
        exit 0
      }

      Write-Host "[PROGRESS] Validating priority $priority is unique..."
      $conflictingRules = @(az network nsg rule list `
        --nsg-name $nsgName `
        --resource-group $resourceGroup `
        --query "[?priority=='$priority']" `
        --output json | ConvertFrom-Json)

      if ($conflictingRules.Count -gt 0) {
        Write-Host "[ERROR] Priority $priority is already in use by rule '$($conflictingRules[0].name)'"
        exit 1
      }

      Write-Host "[PROGRESS] Creating NSG rule '$ruleName'..."
      $createParams = @(
        "--nsg-name", $nsgName,
        "--name", $ruleName,
        "--resource-group", $resourceGroup,
        "--direction", $direction,
        "--priority", $priority.ToString(),
        "--access", $access,
        "--protocol", $protocol,
        "--source-address-prefixes", $sourceAddressPrefix,
        "--source-port-ranges", $sourcePortRange,
        "--destination-address-prefixes", $destinationAddressPrefix,
        "--destination-port-ranges", $destinationPortRange
      )

      if ($description) {
        $createParams += "--description"
        $createParams += $description
      }

      az network nsg rule create @createParams --output none

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[PROGRESS] Verifying rule creation..."
        Start-Sleep -Seconds 5

        $newRule = az network nsg rule show `
          --nsg-name $nsgName `
          --name $ruleName `
          --resource-group $resourceGroup `
          --output json | ConvertFrom-Json

        Write-Host "[SUCCESS] Successfully added rule '$ruleName' to NSG '$nsgName'"
        Write-Host "[SUCCESS] - Direction: $($newRule.direction)"
        Write-Host "[SUCCESS] - Priority: $($newRule.priority)"
        Write-Host "[SUCCESS] - Access: $($newRule.access)"
        Write-Host "[SUCCESS] - Protocol: $($newRule.protocol)"
        exit 0
      } else {
        Write-Host "[ERROR] Failed to create NSG rule"
        exit 1
      }
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/nsg-rule-add-wrapper.ps1
      rm -f /tmp/nsg-rule-add-wrapper.ps1

  # Rollback
  rollback:
    enabled: true
    steps:
      - name: "Remove NSG Rule"
        description: "Delete the security rule from NSG"
        command: |
          az network nsg rule delete \
            --nsg-name "{{nsg_name}}" \
            --name "{{rule_name}}" \
            --resource-group "{{resource_group}}" \
            --yes
        continue_on_error: true

  # Self-healing
  fixes: []
