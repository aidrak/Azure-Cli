# ==============================================================================
# Capability Operation: Create Network Interface Card
# Migrated from: Standard Azure NIC creation patterns
# ==============================================================================

operation:
  id: "nic-create"
  name: "Create Network Interface Card"
  description: "Create a network interface card (NIC) for VM network connectivity"
  capability: "networking"
  operation_mode: "create"
  resource_type: "Microsoft.Network/networkInterfaces"
  # Duration expectations
  duration:
    expected: 45
    timeout: 90
    type: "FAST"
  # Parameters extracted from standard NIC creation
  parameters:
    required:
      - name: "nic_name"
        type: "string"
        description: "Name of the network interface card"
        default: "{{NIC_NAME}}"
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
      - name: "location"
        type: "string"
        description: "Azure region for the resource"
        default: "{{AZURE_LOCATION}}"
      - name: "subnet_id"
        type: "string"
        description: "Subnet resource ID for the NIC"
        default: "{{SUBNET_ID}}"
    optional:
      - name: "vnet_name"
        type: "string"
        description: "Virtual network name"
        default: "{{NETWORKING_VNET_NAME}}"
      - name: "subnet_name"
        type: "string"
        description: "Subnet name"
        default: "{{NETWORKING_SESSION_HOST_SUBNET_NAME}}"
      - name: "nsg_id"
        type: "string"
        description: "Network security group resource ID"
        default: "{{NSG_ID}}"
      - name: "private_ip_allocation"
        type: "string"
        description: "Private IP allocation method (Static or Dynamic)"
        default: "Dynamic"
      - name: "enable_accelerated_networking"
        type: "boolean"
        description: "Enable accelerated networking"
        default: false
      - name: "enable_ip_forwarding"
        type: "boolean"
        description: "Enable IP forwarding"
        default: false
      - name: "environment"
        type: "string"
        description: "Environment tag"
        default: "{{AZURE_ENVIRONMENT}}"
  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "Microsoft.Network/networkInterfaces"
        resource_name: "{{NIC_NAME}}"
        description: "Network interface card created successfully"
      - type: "property_equals"
        property: "ipConfigurations[0].subnet.id"
        expected: "{{SUBNET_ID}}"
        description: "NIC is attached to correct subnet"
      - type: "provisioning_state"
        expected: "Succeeded"
        description: "NIC provisioning completed successfully"
  # Idempotency: Check for existing resource
  idempotency:
    enabled: true
    check_command: |
      az network nic show \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "{{NIC_NAME}}" \
        --output none 2>/dev/null
    skip_if_exists: true
  # Template command (variables substituted at runtime)
  template:
    type: "powershell-direct"
  # Rollback: Reverse of creation
  rollback:
    enabled: true
    steps:
      - name: "Delete Network Interface Card"
        description: "Remove the network interface card"
        command: |
          az network nic delete \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --name "{{NIC_NAME}}" \
            --yes
        continue_on_error: false
  # Self-healing: Previous fixes applied to this template
  fixes: []
  powershell:
    content: |
      $ErrorActionPreference = 'Stop'

      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $location = "{{AZURE_LOCATION}}"
      $nicName = "{{NIC_NAME}}"
      $vnetName = "{{NETWORKING_VNET_NAME}}"
      $subnetName = "{{NETWORKING_SESSION_HOST_SUBNET_NAME}}"
      $tags = "environment={{AZURE_ENVIRONMENT}} project=avd-deployment managed_by=azure-cli-automation"

      Write-Host "[START] Starting 'Create Network Interface Card' operation..."

      Write-Host "[PROGRESS] Checking if NIC '$nicName' already exists..."
      $nicExists = @(az network nic show --resource-group $resourceGroup --name $nicName --output none 2>$null)

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] NIC '$nicName' already exists."
        exit 0
      }

      Write-Host "[PROGRESS] Validating VNet and subnet..."
      $subnetId = az network vnet subnet show `
        --resource-group $resourceGroup `
        --vnet-name $vnetName `
        --name $subnetName `
        --query id -o tsv 2>$null

      if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrEmpty($subnetId)) {
        Write-Host "[ERROR] Subnet not found: $subnetName in VNet $vnetName"
        exit 1
      }

      Write-Host "[PROGRESS] Creating network interface card '$nicName'..."

      # Create the network interface
      az network nic create `
        --resource-group $resourceGroup `
        --name $nicName `
        --vnet-name $vnetName `
        --subnet $subnetName `
        --location $location `
        --tags $tags `
        --output json

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Failed to create NIC '$nicName'"
        exit 1
      }

      Write-Host "[VALIDATE] Verifying NIC creation..."

      # Verify NIC was created
      $nicInfo = az network nic show `
        --resource-group $resourceGroup `
        --name $nicName `
        --query "{id:id, provisioningState:provisioningState, subnetId:ipConfigurations[0].subnet.id, privateIp:ipConfigurations[0].privateIPAddress}" `
        --output json | ConvertFrom-Json

      if (-not $nicInfo) {
        Write-Host "[ERROR] Failed to verify NIC creation"
        exit 1
      }

      Write-Host "[SUCCESS] Successfully created NIC '$nicName'"
      Write-Host "  Resource ID: $($nicInfo.id)"
      Write-Host "  Private IP: $($nicInfo.privateIp)"
      Write-Host "  Subnet: $($nicInfo.subnetId)"
      Write-Host "  State: $($nicInfo.provisioningState)"

      exit 0
