# ==============================================================================
# Capability Operation: Create FSLogix File Share
# Migrated from: modules/02-storage/operations/03-create-file-share.yaml
# ==============================================================================

operation:
  id: "fileshare-create"
  name: "Create FSLogix File Share"
  description: "Create Azure Premium file share for FSLogix profile containers with specified quota"
  capability: "storage"
  operation_mode: "create"
  resource_type: "Microsoft.Storage/storageAccounts/fileServices/shares"
  # Duration expectations
  duration:
    expected: 60 # 60 seconds (1 minute)
    timeout: 120 # 2 minutes
    type: "FAST"
  # Parameters extracted from old operation
  parameters:
    required:
      - name: "storage_account_name"
        type: "string"
        description: "Premium FileStorage account name"
        default: "{{STORAGE_ACCOUNT_NAME}}"
      - name: "file_share_name"
        type: "string"
        description: "Name of the file share"
        default: "{{STORAGE_FILE_SHARE_NAME}}"
      - name: "quota_gb"
        type: "integer"
        description: "Quota in GB for the file share"
        default: "{{STORAGE_QUOTA_GB}}"
    optional:
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name (for reference)"
        default: "{{AZURE_RESOURCE_GROUP}}"
  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "Microsoft.Storage/storageAccounts/fileServices/shares"
        resource_name: "{{STORAGE_FILE_SHARE_NAME}}"
        description: "File share exists"
      - type: "property_greater_than"
        property: "quota"
        expected: 0
        description: "File share has quota configured"
  # Idempotency: Check for existing file share
  idempotency:
    enabled: true
    check_command: |
      az storage share exists \
        --account-name "{{STORAGE_ACCOUNT_NAME}}" \
        --name "{{STORAGE_FILE_SHARE_NAME}}" \
        --query exists -o tsv 2>/dev/null
    skip_if_exists: true
  # Template command (variables substituted at runtime)
  template:
    type: "powershell-direct"
  # Rollback: Reverse of creation
  rollback:
    enabled: true
    steps:
      - name: "Delete File Share"
        description: "Remove the file share and all data"
        command: |
          az storage share delete \
            --account-name "{{STORAGE_ACCOUNT_NAME}}" \
            --name "{{STORAGE_FILE_SHARE_NAME}}" \
            --yes
        continue_on_error: false
  # Self-healing: Previous fixes applied to this template
  fixes: []

  # Dependencies: Requires storage account to exist
  dependencies:
    operations:
      - id: "account-create"
        status: "completed"
        optional: true
        description: "Storage account should be created first (may be pre-existing)"

  powershell:
    content: |
      # Get storage account name from template variable
      # The STORAGE_ACCOUNT_NAME is resolved by the engine from:
      # 1. Environment variable (if set)
      # 2. state.db (from account-create operation output)
      # 3. config.yaml
      $storageName = "{{STORAGE_ACCOUNT_NAME}}"

      $fileShareName = "{{STORAGE_FILE_SHARE_NAME}}"
      $quotaGb = "{{STORAGE_QUOTA_GB}}"

      Write-Host "[START] Creating file share at $(Get-Date -Format 'HH:mm:ss')"
      Write-Host "  Storage account: $storageName"
      Write-Host "  File share name: $fileShareName"
      Write-Host "  Quota: ${quotaGb}GB"

      # Check if file share already exists
      Write-Host "[PROGRESS] Checking if file share exists..."

      $existsOutput = az storage share exists `
        --account-name $storageName `
        --name $fileShareName `
        --query exists -o tsv 2>$null

      if ($existsOutput -eq "true") {
        Write-Host "[SUCCESS] File share already exists: $fileShareName"

        # Get current quota
        $currentQuota = az storage share show `
          --account-name $storageName `
          --name $fileShareName `
          --query quota -o tsv 2>$null

        Write-Host "  Current quota: ${currentQuota}GB"
        exit 0
      }

      Write-Host "[PROGRESS] Creating file share..."

      # Create file share
      $createOutput = az storage share create `
        --account-name $storageName `
        --name $fileShareName `
        --quota $quotaGb `
        --output json 2>&1

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Failed to create file share"
        Write-Host $createOutput
        exit 1
      }

      Write-Host "[VALIDATE] Verifying file share creation..."

      # Verify file share exists
      $verifyShare = @(az storage share show `
        --account-name $storageName `
        --name $fileShareName `
        --query "[0]" 2>$null | ConvertFrom-Json)

      if ($verifyShare.Count -eq 0) {
        Write-Host "[ERROR] File share creation verification failed"
        exit 1
      }

      $shareQuota = az storage share show `
        --account-name $storageName `
        --name $fileShareName `
        --query quota -o tsv

      Write-Host "[SUCCESS] File share created: $fileShareName"
      Write-Host "  Storage account: $storageName"
      Write-Host "  Provisioned capacity: ${shareQuota}GB"
      Write-Host "  Protocol: SMB 3.1.1"
      Write-Host "  UNC path: \\${storageName}.file.core.windows.net\${fileShareName}"
      Write-Host ""
      Write-Host "[INFO] FSLogix Configuration Value:"
      Write-Host "  VHDLocations: \\${storageName}.file.core.windows.net\${fileShareName}"
      exit 0
