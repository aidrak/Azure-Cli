# ==============================================================================
# Capability Operation: Create Private Endpoint for Storage
# Migrated from: modules/02-storage/operations/06-create-private-endpoint.yaml
# ==============================================================================

operation:
  id: "private-endpoint-create"
  name: "Create Private Endpoint for Storage"
  description: "Create private endpoint for secure, non-internet-routable access to FSLogix storage"
  capability: "storage"
  operation_mode: "create"
  resource_type: "Microsoft.Network/privateEndpoints"
  # Duration expectations
  duration:
    expected: 120 # 120 seconds (2 minutes)
    timeout: 240 # 4 minutes
    type: "NORMAL"
  # Dependencies: Prerequisites that must be completed before this operation
  dependencies:
    operations:
      - id: "storage-account-create"
        status: "completed"
        description: "Storage account must exist for private endpoint"
      - id: "subnet-create"
        status: "completed"
        optional: true
        description: "Private endpoint subnet should exist"
    resources:
      - type: "Microsoft.Storage/storageAccounts"
        name: "{{STORAGE_ACCOUNT_NAME}}"
        must_exist: true
  # Parameters extracted from old operation
  parameters:
    required:
      - name: "storage_account_name"
        type: "string"
        description: "Premium FileStorage account name"
        default: "{{STORAGE_ACCOUNT_NAME}}"
      - name: "vnet_name"
        type: "string"
        description: "Virtual network name"
        default: "{{NETWORKING_VNET_NAME}}"
      - name: "subnet_name"
        type: "string"
        description: "Subnet for private endpoint"
        default: "{{NETWORKING_PRIVATE_ENDPOINT_SUBNET_NAME}}"
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
      - name: "location"
        type: "string"
        description: "Azure region for the resource"
        default: "{{AZURE_LOCATION}}"
    optional:
      - name: "private_endpoint_name"
        type: "string"
        description: "Name of the private endpoint (auto-generated if not provided)"
        default: "{{STORAGE_ACCOUNT_NAME}}-file-pe"
  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "Microsoft.Network/privateEndpoints"
        resource_name: "{{STORAGE_ACCOUNT_NAME}}-file-pe"
        description: "Private endpoint exists"
      - type: "property_equals"
        property: "privateLinkServiceConnections[0].privateLinkServiceConnectionState.status"
        expected: "Approved"
        description: "Private endpoint connection approved"
  # Idempotency: Check for existing private endpoint
  idempotency:
    enabled: true
    check_command: |
      az network private-endpoint show \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "{{STORAGE_ACCOUNT_NAME}}-file-pe" \
        --output none 2>/dev/null
    skip_if_exists: true
  # Template command (variables substituted at runtime)
  template:
    type: "powershell-direct"
  # Rollback: Reverse of creation
  rollback:
    enabled: true
    steps:
      - name: "Delete Private Endpoint"
        description: "Remove the private endpoint"
        command: |
          az network private-endpoint delete \
            --resource-group "{{AZURE_RESOURCE_GROUP}}" \
            --name "{{STORAGE_ACCOUNT_NAME}}-file-pe" \
            --yes
        continue_on_error: false
  # Self-healing: Previous fixes applied to this template
  fixes: []
  powershell:
    content: |
      # Get storage account name (from previous operation or config)
      if (Test-Path /tmp/storage-account-name.txt) {
        $storageName = Get-Content /tmp/storage-account-name.txt
      } else {
        $storageName = "{{STORAGE_ACCOUNT_NAME}}"
      }

      $vnetName = "{{NETWORKING_VNET_NAME}}"
      $subnetName = "{{NETWORKING_PRIVATE_ENDPOINT_SUBNET_NAME}}"
      $peName = "${storageName}-file-pe"
      $dnsZoneName = "privatelink.file.core.windows.net"

      Write-Host "[START] Creating private endpoint at $(Get-Date -Format 'HH:mm:ss')"
      Write-Host "  Storage account: $storageName"
      Write-Host "  VNet: $vnetName"
      Write-Host "  Subnet: $subnetName"
      Write-Host "  Private endpoint: $peName"

      # Check if private endpoint already exists
      Write-Host "[PROGRESS] Checking if private endpoint exists..."

      $peExists = @(az network private-endpoint show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $peName `
        --query "[0]" 2>$null | ConvertFrom-Json)

      if ($peExists.Count -gt 0) {
        Write-Host "[SUCCESS] Private endpoint already exists: $peName"

        # Get private IP
        $nicId = az network private-endpoint show `
          --resource-group "{{AZURE_RESOURCE_GROUP}}" `
          --name $peName `
          --query "networkInterfaces[0].id" -o tsv

        $privateIp = az network nic show `
          --ids $nicId `
          --query "ipConfigurations[0].privateIpAddress" -o tsv

        Write-Host "  Private IP: $privateIp"
        exit 0
      }

      # Get storage account resource ID
      Write-Host "[PROGRESS] Getting storage account resource ID..."

      $storageId = az storage account show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $storageName `
        --query id -o tsv

      if ([string]::IsNullOrEmpty($storageId)) {
        Write-Host "[ERROR] Storage account not found: $storageName"
        exit 1
      }

      # Get subnet ID
      Write-Host "[PROGRESS] Getting subnet ID..."

      $subnetId = az network vnet subnet show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --vnet-name $vnetName `
        --name $subnetName `
        --query id -o tsv

      if ([string]::IsNullOrEmpty($subnetId)) {
        Write-Host "[ERROR] Subnet not found: $subnetName"
        exit 1
      }

      # Create private endpoint
      Write-Host "[PROGRESS] Creating private endpoint for Azure Files..."

      $createPeOutput = az network private-endpoint create `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $peName `
        --vnet-name $vnetName `
        --subnet $subnetName `
        --private-connection-resource-id $storageId `
        --group-ids file `
        --connection-name "${storageName}-file-connection" `
        --location "{{AZURE_LOCATION}}" `
        --output json 2>&1

      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Failed to create private endpoint"
        Write-Host $createPeOutput
        exit 1
      }

      Write-Host "[SUCCESS] Private endpoint created: $peName"

      # Wait for private endpoint to be fully provisioned
      Write-Host "[PROGRESS] Waiting for private endpoint provisioning..."
      Start-Sleep -Seconds 10

      # Get private endpoint details
      Write-Host "[VALIDATE] Retrieving private endpoint details..."

      $peId = az network private-endpoint show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $peName `
        --query id -o tsv

      $nicId = az network private-endpoint show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $peName `
        --query "networkInterfaces[0].id" -o tsv

      $privateIp = az network nic show `
        --ids $nicId `
        --query "ipConfigurations[0].privateIpAddress" -o tsv

      # Create DNS zone group (integrates private endpoint with DNS zone)
      Write-Host "[PROGRESS] Integrating private endpoint with DNS zone..."

      $createDnsGroupOutput = az network private-endpoint dns-zone-group create `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --endpoint-name $peName `
        --name "default" `
        --private-dns-zone $dnsZoneName `
        --zone-name "file" `
        --output json 2>&1

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] DNS zone integration complete"
      } else {
        Write-Host "[WARNING] DNS zone group creation had issues (may already exist)"
        # This is non-critical, continue
      }

      # Verify private endpoint connection
      Write-Host "[VALIDATE] Verifying private endpoint connection..."

      $connectionState = az network private-endpoint show `
        --resource-group "{{AZURE_RESOURCE_GROUP}}" `
        --name $peName `
        --query "privateLinkServiceConnections[0].privateLinkServiceConnectionState.status" -o tsv

      if ($connectionState -eq "Approved") {
        Write-Host "[SUCCESS] Private endpoint configured successfully"
        Write-Host ""
        Write-Host "=== Private Endpoint Details ==="
        Write-Host "  Name: $peName"
        Write-Host "  Resource ID: $peId"
        Write-Host "  Private IP: $privateIp"
        Write-Host "  Connection state: $connectionState"
        Write-Host "  Subnet: $subnetName"
        Write-Host "  DNS zone: $dnsZoneName"
        Write-Host ""
        Write-Host "=== FSLogix Access ==="
        Write-Host "  UNC path: \\${storageName}.file.core.windows.net\{{STORAGE_FILE_SHARE_NAME}}"
        Write-Host "  Resolves to: $privateIp (private)"
        Write-Host "  Access: VNet only (no public internet)"
        Write-Host "  Authentication: Entra Kerberos"
        Write-Host ""
        Write-Host "[INFO] Storage account is now accessible only via private endpoint"
        Write-Host "[INFO] Session hosts in the VNet can mount file shares using domain credentials"
        exit 0
      } else {
        Write-Host "[ERROR] Private endpoint connection state is not 'Approved': $connectionState"
        exit 1
      }
