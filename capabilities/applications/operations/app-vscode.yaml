# ==============================================================================
# Application Operation: Visual Studio Code
# ==============================================================================

operation:
  id: "app-vscode"
  name: "Install Visual Studio Code"
  description: "Download and install Visual Studio Code system-wide installer"

  capability: "applications"
  operation_mode: "configure"
  resource_type: "Microsoft.Compute/virtualMachines"

  duration:
    expected: 180
    timeout: 360
    type: "NORMAL"

  parameters:
    required:
      - name: "vm_name"
        type: "string"
        description: "Name of the target VM"
        default: "{{GOLDEN_IMAGE_TEMP_VM_NAME}}"
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
    optional: []

  idempotency:
    enabled: true
    check_command: |
      az vm run-command invoke \
        --resource-group "{{AZURE_RESOURCE_GROUP}}" \
        --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" \
        --command-id RunPowerShellScript \
        --scripts "if (Test-Path 'C:\Program Files\Microsoft VS Code\Code.exe') { exit 0 } else { exit 1 }" \
        --output none 2>/dev/null
    skip_if_exists: true

  validation:
    enabled: true
    checks:
      - type: "file_exists"
        path: "C:\\Program Files\\Microsoft VS Code\\Code.exe"
        description: "VS Code executable installed"

  template:
    type: "powershell-vm-command"
    command: |
      cat > /tmp/app-vscode-wrapper.ps1 << 'PSWRAPPER'
      $scriptContent = @'
      {{POWERSHELL_CONTENT}}
      '@
      $tempScript = "/tmp/app-vscode-$([guid]::NewGuid()).ps1"
      $scriptContent | Out-File -FilePath $tempScript -Encoding UTF8
      az vm run-command invoke --resource-group "{{AZURE_RESOURCE_GROUP}}" --name "{{GOLDEN_IMAGE_TEMP_VM_NAME}}" --command-id RunPowerShellScript --scripts "@$tempScript" --output json
      if (Test-Path $tempScript) { Remove-Item -Path $tempScript -Force -ErrorAction SilentlyContinue }
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/app-vscode-wrapper.ps1
      rm -f /tmp/app-vscode-wrapper.ps1

  powershell:
    file: "app-vscode.ps1"
    content: |
      # ==============================================================================
      # Install Visual Studio Code (System Installer)
      # ==============================================================================

      Write-Host "[START] Installing Visual Studio Code: $(Get-Date -Format 'HH:mm:ss')"

      $tempDir = "C:\Temp"
      $installer = "$tempDir\VSCodeSetup.exe"
      # Official permalink for latest stable system installer
      $url = "https://code.visualstudio.com/sha/download?build=stable&os=win32-x64"

      try {
          # Ensure temp directory exists
          if (-not (Test-Path $tempDir)) {
              New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
          }

          # Download
          Write-Host "[i] Downloading VS Code from official permalink..."
          Invoke-WebRequest -Uri $url -OutFile $installer -UseBasicParsing -TimeoutSec 300

          if (-not (Test-Path $installer)) {
              throw "Download failed: installer not found"
          }

          $fileSize = [math]::Round((Get-Item $installer).Length / 1MB, 2)
          Write-Host "[v] Download complete: $fileSize MB"

          # Install
          # /VERYSILENT - No UI
          # /SUPPRESSMSGBOXES - Suppress message boxes
          # /NORESTART - Don't restart
          # /MERGETASKS=!runcode - Don't run VS Code after install
          Write-Host "[i] Installing VS Code..."
          $proc = Start-Process -FilePath $installer `
              -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /MERGETASKS=!runcode" `
              -Wait -PassThru

          if ($proc.ExitCode -ne 0) {
              throw "Installation failed with exit code $($proc.ExitCode)"
          }

          # Validate
          Write-Host "[i] Validating installation..."
          $vscodePath = "C:\Program Files\Microsoft VS Code\Code.exe"
          if (-not (Test-Path $vscodePath)) {
              throw "Validation failed: VS Code executable not found"
          }

          # Cleanup
          Remove-Item $installer -Force -ErrorAction SilentlyContinue

          Write-Host "[v] Visual Studio Code installed successfully"
          exit 0

      } catch {
          Write-Host "[x] Error: $($_.Exception.Message)"
          exit 1
      }

  rollback:
    enabled: true
    steps:
      - name: "Uninstall VS Code"
        command: |
          $uninstaller = "C:\Program Files\Microsoft VS Code\unins000.exe"
          if (Test-Path $uninstaller) {
              Start-Process -FilePath $uninstaller -ArgumentList "/VERYSILENT" -Wait
          }

  fixes: []
