# ==============================================================================
# Capability Operation: Validate Resource Group
# Migrated from: modules/00-resource-group/operations/02-validate.yaml
# ==============================================================================

operation:
  id: "resource-group-validate"
  name: "Validate Resource Group"
  description: "Verify resource group is accessible and properly configured"

  capability: "management"
  operation_mode: "validate"
  resource_type: "Microsoft.Resources/resourceGroups"

  # Duration expectations
  duration:
    expected: 15
    timeout: 30
    type: "FAST"

  # Prerequisites
  prerequisites:
    required:
      - operation: "resource-group-create"
        status: "completed"

  # Parameters extracted from old operation
  parameters:
    required:
      - name: "resource_group"
        type: "string"
        description: "Name of the resource group to validate"
        default: "{{AZURE_RESOURCE_GROUP}}"
      - name: "location"
        type: "string"
        description: "Expected Azure region for the resource group"
        default: "{{AZURE_LOCATION}}"

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "resource_exists"
        resource_type: "Microsoft.Resources/resourceGroups"
        resource_name: "{{AZURE_RESOURCE_GROUP}}"
        description: "Resource group exists"

      - type: "property_equals"
        property: "properties.provisioningState"
        expected: "Succeeded"
        description: "Resource group is in Succeeded provisioning state"

  # Idempotency: Validation is idempotent
  idempotency:
    enabled: true
    check_command: |
      az group show --name "{{AZURE_RESOURCE_GROUP}}" --output none 2>/dev/null
    skip_if_exists: false

  # Template command (variables substituted at runtime)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/rg-02-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] Resource group validation: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"

      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $expectedLocation = "{{AZURE_LOCATION}}"

      Write-Host "[PROGRESS] Validating resource group: $resourceGroup"

      # Check if resource group exists
      $rgInfoJson = az group show --name $resourceGroup --output json 2>$null

      if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrEmpty($rgInfoJson)) {
        Write-Host "[ERROR] Resource group not found: $resourceGroup"
        exit 1
      }

      # Extract details
      $rgInfo = $rgInfoJson | ConvertFrom-Json
      $actualLocation = $rgInfo.location
      $provisioningState = $rgInfo.properties.provisioningState
      $rgId = $rgInfo.id

      Write-Host "[VALIDATE] Resource Group ID: $rgId"
      Write-Host "[VALIDATE] Location: $actualLocation (expected: $expectedLocation)"
      Write-Host "[VALIDATE] Provisioning State: $provisioningState"

      # Validate provisioning state
      if ($provisioningState -ne "Succeeded") {
        Write-Host "[ERROR] Resource group is not in 'Succeeded' state"
        Write-Host "[ERROR] Current state: $provisioningState"
        exit 1
      }

      # Validate location (warning only if different)
      if ($actualLocation -ne $expectedLocation) {
        Write-Host "[WARNING] Location mismatch (using existing location)"
        Write-Host "[WARNING]   Expected: $expectedLocation"
        Write-Host "[WARNING]   Actual: $actualLocation"
      }

      # Check permissions (try to list resources)
      Write-Host "[VALIDATE] Checking permissions..."
      $resourceList = az resource list --resource-group $resourceGroup --output json 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] Resource group is accessible and ready"
      } else {
        Write-Host "[ERROR] Cannot list resources in resource group (permission issue?)"
        exit 1
      }

      Write-Host "[SUCCESS] Resource group validation complete"
      exit 0
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/rg-02-wrapper.ps1
      rm -f /tmp/rg-02-wrapper.ps1

  # Rollback: No action needed for validation operation
  rollback:
    enabled: false
    steps: []

  # Self-healing: Previous fixes applied to this template
  fixes: []
