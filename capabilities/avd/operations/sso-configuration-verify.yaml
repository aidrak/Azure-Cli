# ==============================================================================
# Capability Operation: Verify SSO Configuration
# Migrated from: modules/08-sso/operations/02-verify-configuration.yaml
# ==============================================================================

operation:
  id: "sso-configuration-verify"
  name: "Verify SSO Configuration"
  description: "Verify SSO is properly configured in the host pool"

  capability: "avd"
  operation_mode: "verify"
  resource_type: "Microsoft.DesktopVirtualization/hostPools"

  # Duration expectations
  duration:
    expected: 60    # 1 minute
    timeout: 180    # 3 minutes (fail-fast if exceeds)
    type: "FAST"    # FAST (<5min) or WAIT (10+min)

  # Parameters extracted from old operation
  parameters:
    required:
      - name: "resource_group"
        type: "string"
        description: "Azure resource group name"
        default: "{{AZURE_RESOURCE_GROUP}}"
      - name: "host_pool_name"
        type: "string"
        description: "Name of the AVD host pool"
        default: "{{HOST_POOL_NAME}}"
    optional:
      - name: "sso_enabled"
        type: "boolean"
        description: "Whether SSO is enabled in configuration"
        default: "{{SSO_ENABLED}}"

  # Prerequisites (check state.json)
  requires:
    - operation: "sso-hostpool-configure"
      status: "completed"

  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          if (Test-Path "artifacts/outputs/sso-verification-complete.txt") {
            Write-Host "[VALIDATE] SSO verification completed"
            exit 0
          } else {
            Write-Host "[ERROR] SSO verification file not found"
            exit 1
          }
        description: "Verify SSO verification completed"

  # Template command (executed via PowerShell)
  template:
    type: "powershell-local"
    command: |
      cat > /tmp/sso-verify-wrapper.ps1 << 'PSWRAPPER'
      Write-Host "[START] SSO Configuration Verification: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $resourceGroup = "{{AZURE_RESOURCE_GROUP}}"
      $hostPoolName = "{{HOST_POOL_NAME}}"
      $ssoEnabled = "{{SSO_ENABLED}}"

      # Counters
      $totalChecks = 0
      $passedChecks = 0
      $failedChecks = 0
      $warningChecks = 0

      # Step 1: Validate Azure authentication
      Write-Host "[PROGRESS] Step 1/4: Validating Azure authentication..."
      az account show --output none 2>$null
      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Not authenticated to Azure"
        exit 1
      }

      # Step 2: Check if SSO is enabled in config
      Write-Host "[PROGRESS] Step 2/4: Checking SSO configuration..."
      if ($ssoEnabled -ne "true") {
        Write-Host "[WARNING] SSO is disabled in configuration"
        Write-Host "[WARNING] Skipping verification"

        $reportContent = "SSO Verification Skipped" + [Environment]::NewLine + "========================" + [Environment]::NewLine + "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" + [Environment]::NewLine + [Environment]::NewLine + "SSO is disabled in configuration." + [Environment]::NewLine + [Environment]::NewLine
        $reportContent | Out-File -FilePath "artifacts/outputs/sso-verification-complete.txt" -Encoding UTF8
        exit 0
      }

      # Step 3: Verify host pool configuration
      Write-Host "[PROGRESS] Step 3/4: Verifying host pool SSO configuration..."

      # Check if host pool exists
      $totalChecks++
      az desktopvirtualization hostpool show `
        --resource-group $resourceGroup `
        --name $hostPoolName `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] ✓ Host pool exists: $hostPoolName"
        $passedChecks++
      } else {
        Write-Host "[ERROR] ✗ Host pool not found: $hostPoolName"
        $failedChecks++
      }

      # Check RDP properties for SSO
      $totalChecks++
      $rdpProps = az desktopvirtualization hostpool show `
        --resource-group $resourceGroup `
        --name $hostPoolName `
        --query "customRdpProperty" -o tsv 2>$null

      if ($LASTEXITCODE -ne 0) {
        $rdpProps = ""
      }

      if ($rdpProps -match "enablerdsaadauth:i:1") {
        Write-Host "[SUCCESS] ✓ SSO enabled in RDP properties (enablerdsaadauth:i:1)"
        $passedChecks++
      } else {
        Write-Host "[ERROR] ✗ SSO not enabled in RDP properties"
        Write-Host "[ERROR]   Current RDP properties: $(if ($rdpProps) { $rdpProps } else { '<empty>' })"
        $failedChecks++
      }

      # Check session hosts exist
      $totalChecks++
      $sessionHostCount = az desktopvirtualization sessionhost list `
        --resource-group $resourceGroup `
        --host-pool-name $hostPoolName `
        --query "length(@)" -o tsv 2>$null

      if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrEmpty($sessionHostCount)) {
        $sessionHostCount = "0"
      }

      if ([int]$sessionHostCount -gt 0) {
        Write-Host "[SUCCESS] ✓ Session hosts exist: $sessionHostCount host(s)"
        $passedChecks++
      } else {
        Write-Host "[WARNING] ⚠ No session hosts found (they may not be registered yet)"
        $warningChecks++
      }

      # Check RBAC role assignment (Virtual Machine User Login)
      $totalChecks++
      Write-Host "[PROGRESS] Checking RBAC assignments..."

      # Get resource group ID
      $rgId = az group show --name $resourceGroup --query id -o tsv

      # Check if any VM login role is assigned
      $vmLoginAssignments = az role assignment list `
        --scope $rgId `
        --query "[?contains(roleDefinitionName, 'Virtual Machine') && contains(roleDefinitionName, 'Login')]" `
        --output tsv 2>$null

      if ($LASTEXITCODE -ne 0) {
        $vmLoginCount = 0
      } else {
        $vmLoginCount = ($vmLoginAssignments | Measure-Object -Line).Lines
      }

      if ($vmLoginCount -gt 0) {
        Write-Host "[SUCCESS] ✓ VM Login RBAC roles assigned ($vmLoginCount assignment(s))"
        $passedChecks++
      } else {
        Write-Host "[WARNING] ⚠ No VM Login RBAC roles found (may need Module 08)"
        $warningChecks++
      }

      # Step 4: Summary
      Write-Host "[PROGRESS] Step 4/4: Generating verification summary..."
      Write-Host ""
      Write-Host "=========================================="
      Write-Host "SSO VERIFICATION SUMMARY"
      Write-Host "=========================================="
      Write-Host "Total Checks: $totalChecks"
      Write-Host "Passed: $passedChecks"
      Write-Host "Failed: $failedChecks"
      Write-Host "Warnings: $warningChecks"
      Write-Host "=========================================="

      # Determine overall status
      if ($failedChecks -eq 0) {
        Write-Host "[SUCCESS] SSO configuration verification passed!"
        $verificationStatus = "PASSED"
        $exitCode = 0
      } else {
        Write-Host "[ERROR] Some SSO configuration checks failed"
        Write-Host "[ERROR] Please review the failed checks above"
        $verificationStatus = "FAILED"
        $exitCode = 1
      }

      # Save detailed verification report
      $reportContent = "SSO Configuration Verification Report" + [Environment]::NewLine + "======================================" + [Environment]::NewLine + "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" + [Environment]::NewLine + [Environment]::NewLine + "Overall Status: $verificationStatus" + [Environment]::NewLine + [Environment]::NewLine + "Summary:" + [Environment]::NewLine + "  Total Checks: $totalChecks" + [Environment]::NewLine + "  Passed: $passedChecks" + [Environment]::NewLine + "  Failed: $failedChecks" + [Environment]::NewLine + "  Warnings: $warningChecks" + [Environment]::NewLine + [Environment]::NewLine + "Host Pool: $hostPoolName" + [Environment]::NewLine + "Resource Group: $resourceGroup" + [Environment]::NewLine + [Environment]::NewLine + "Automated Checks:" + [Environment]::NewLine + "  1. Host pool exists" + [Environment]::NewLine + "  2. SSO enabled in RDP properties (enablerdsaadauth:i:1)" + [Environment]::NewLine + "  3. Session hosts registered" + [Environment]::NewLine + "  4. VM Login RBAC roles assigned" + [Environment]::NewLine + [Environment]::NewLine + "Manual Verification Required:" + [Environment]::NewLine + [Environment]::NewLine + "The following must be configured manually via Azure Portal:" + [Environment]::NewLine + [Environment]::NewLine + "1. Windows Cloud Login Service Principal" + [Environment]::NewLine + "   - Service Principal ID: 270efc09-cd0d-444b-a71f-39af4910ec45" + [Environment]::NewLine + "   - IsRemoteDesktopProtocolEnabled: True" + [Environment]::NewLine + "   - Configure via Microsoft Graph API or Portal" + [Environment]::NewLine + [Environment]::NewLine + "2. Trusted Device Groups (Optional)" + [Environment]::NewLine + "   - Add device group (e.g., AVD-Devices-Pooled-SSO)" + [Environment]::NewLine + "   - Eliminates consent prompts for managed devices" + [Environment]::NewLine + "   - Max 10 device groups allowed" + [Environment]::NewLine + [Environment]::NewLine + "3. Conditional Access Policies" + [Environment]::NewLine + "   - Required Cloud Apps:" + [Environment]::NewLine + "     * Azure Virtual Desktop (9cdead84-a844-4324-93f2-b2e6bb768d07)" + [Environment]::NewLine + "     * Windows Cloud Login (270efc09-cd0d-444b-a71f-39af4910ec45)" + [Environment]::NewLine + "     * Microsoft Remote Desktop (a4a365df-50f1-4397-bc59-1a1564b8bb9c)" + [Environment]::NewLine + [Environment]::NewLine + "   - IMPORTANT: Do NOT apply sign-in frequency to Windows Cloud Login" + [Environment]::NewLine + [Environment]::NewLine + "4. Session Host Requirements" + [Environment]::NewLine + "   - Session hosts must be Entra-joined (not hybrid)" + [Environment]::NewLine + "   - Run 'dsregcmd /status' on session host to verify:" + [Environment]::NewLine + "     * AzureAdJoined: YES" + [Environment]::NewLine + "     * AzureAdPrt: YES" + [Environment]::NewLine + [Environment]::NewLine + "Testing SSO:" + [Environment]::NewLine + "  1. User launches Windows App or Remote Desktop client" + [Environment]::NewLine + "  2. Signs in with Entra ID credentials" + [Environment]::NewLine + "  3. Desktop should launch WITHOUT additional credential prompt" + [Environment]::NewLine + "  4. If prompted for credentials, SSO is not working correctly" + [Environment]::NewLine + [Environment]::NewLine + "Troubleshooting:" + [Environment]::NewLine + "  - Wait 10-15 minutes for Azure AD changes to propagate" + [Environment]::NewLine + "  - Verify all manual configuration steps completed" + [Environment]::NewLine + "  - Check session hosts are properly Entra-joined" + [Environment]::NewLine + "  - Review Conditional Access policy configuration" + [Environment]::NewLine + "  - Verify RBAC roles assigned (Module 08)" + [Environment]::NewLine + "  - Check for conflicting per-user MFA settings" + [Environment]::NewLine + [Environment]::NewLine

      if ($failedChecks -gt 0) {
        $reportContent += "Action Required:" + [Environment]::NewLine + "  Review failed checks above and re-run SSO configuration operations" + [Environment]::NewLine + [Environment]::NewLine
      }

      $reportContent | Out-File -FilePath "artifacts/outputs/sso-verification-complete.txt" -Encoding UTF8

      if ($exitCode -eq 0) {
        Write-Host "[SUCCESS] SSO verification completed successfully"
        Write-Host ""
        Write-Host "Next Steps:"
        Write-Host "  1. Complete manual configuration steps (see report)"
        Write-Host "  2. Test user SSO experience"
        Write-Host "  3. Configure Conditional Access policies"
        Write-Host ""
      } else {
        Write-Host "[ERROR] SSO verification failed - see report for details"
      }

      exit $exitCode
      PSWRAPPER
      pwsh -NoProfile -NonInteractive -File /tmp/sso-verify-wrapper.ps1
      rm -f /tmp/sso-verify-wrapper.ps1

  # Self-healing: Previous fixes applied to this template
  fixes: []
