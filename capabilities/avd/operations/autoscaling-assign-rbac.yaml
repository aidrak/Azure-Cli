# ==============================================================================
# Capability Operation: Assign Autoscaling RBAC Role
# Migrated from: modules/09-autoscaling/operations/01-assign-rbac.yaml
# ==============================================================================

operation:
  id: "autoscaling-assign-rbac"
  name: "Assign Autoscaling RBAC Role"
  description: "Assign Desktop Virtualization Power On Off Contributor role to Azure Virtual Desktop service principal"
  capability: "avd"
  operation_mode: "create"
  resource_type: "Microsoft.Authorization/roleAssignments"
  # Duration expectations
  duration:
    expected: 120 # 2 minutes
    timeout: 300 # 5 minutes
    type: "FAST"
  # Parameters extracted from old operation
  parameters:
    optional:
      - name: "autoscaling_enabled"
        type: "boolean"
        description: "Whether autoscaling is enabled in config"
        default: "{{AUTOSCALING_ENABLED}}"
      - name: "role_name"
        type: "string"
        description: "RBAC role name to assign"
        default: "Desktop Virtualization Power On Off Contributor"
      - name: "service_principal_display_name"
        type: "string"
        description: "Service principal display name"
        default: "Azure Virtual Desktop"
  # Validation checks (run after operation completes)
  validation:
    enabled: true
    checks:
      - type: "powershell_command"
        command: |
          $subscriptionId = az account show --query id -o tsv
          $scope = "/subscriptions/$subscriptionId"

          # Get AVD service principal
          $avdSpId = az ad sp list --filter "displayName eq 'Azure Virtual Desktop'" --query "[0].id" -o tsv 2>$null

          if ([string]::IsNullOrEmpty($avdSpId) -or $avdSpId -eq "null") {
            Write-Host "[WARNING] Azure Virtual Desktop service principal not found"
            exit 0
          }

          # Check role assignment
          $roleAssignment = az role assignment list `
            --assignee $avdSpId `
            --scope $scope `
            --query "[?roleDefinitionName=='Desktop Virtualization Power On Off Contributor']" -o tsv 2>$null

          if ($roleAssignment -match "Desktop") {
            Write-Host "[VALIDATE] RBAC role assigned to AVD service principal"
            exit 0
          } else {
            Write-Host "[WARNING] RBAC role not found (may need manual assignment)"
            exit 0
          }
        description: "Verify RBAC role assigned"
  # Idempotency: Check for existing role assignment
  idempotency:
    enabled: true
    check_command: |
      az role assignment list \
        --role "Desktop Virtualization Power On Off Contributor" \
        --output none 2>/dev/null
    skip_if_exists: false
  # Template command (variables substituted at runtime)
  template:
    type: "powershell-direct"
  # Rollback: Reverse of creation
  rollback:
    enabled: true
    steps:
      - name: "Remove RBAC Role Assignment"
        description: "Revoke the role assignment from AVD service principal"
        command: |
          SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          AVD_SP_ID=$(az ad sp list --filter "displayName eq 'Azure Virtual Desktop'" --query "[0].id" -o tsv 2>/dev/null)

          if [ -n "$AVD_SP_ID" ] && [ "$AVD_SP_ID" != "null" ]; then
            az role assignment delete \
              --assignee "$AVD_SP_ID" \
              --role "Desktop Virtualization Power On Off Contributor" \
              --scope "/subscriptions/$SUBSCRIPTION_ID" \
              2>/dev/null || true
          fi
        continue_on_error: true
  # Self-healing: Previous fixes applied to this template
  fixes: []
  powershell:
    content: |
      Write-Host "[START] Autoscaling RBAC Assignment: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"

      # Configuration from config.yaml
      $autoscalingEnabled = "{{AUTOSCALING_ENABLED}}"

      # Step 1: Validate Azure authentication
      Write-Host "[PROGRESS] Step 1/5: Validating Azure authentication..."
      az account show --output none 2>$null
      if ($LASTEXITCODE -ne 0) {
        Write-Host "[ERROR] Not authenticated to Azure"
        exit 1
      }

      # Step 2: Check if autoscaling is enabled in config
      Write-Host "[PROGRESS] Step 2/5: Checking autoscaling configuration..."
      if ($autoscalingEnabled -ne "true") {
        Write-Host "[WARNING] Autoscaling is disabled in config.yaml (autoscaling.enabled: false)"
        Write-Host "[WARNING] Skipping RBAC assignment"

        $reportContent = "\n" + [Environment]::NewLine + "Autoscaling RBAC Assignment Skipped" + [Environment]::NewLine + "====================================" + [Environment]::NewLine + "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "Autoscaling is disabled in configuration." + [Environment]::NewLine + "To enable autoscaling, set autoscaling.enabled: true in config.yaml" + [Environment]::NewLine + "\n" + [Environment]::NewLine + "\n"
        exit 0
      }

      # Step 3: Get subscription ID
      Write-Host "[PROGRESS] Step 3/5: Getting subscription ID..."
      $subscriptionId = az account show --query id -o tsv
      $subscriptionScope = "/subscriptions/$subscriptionId"

      Write-Host "[VALIDATE] Subscription ID: $subscriptionId"
      Write-Host "[VALIDATE] Scope: $subscriptionScope"

      # Step 4: Find Azure Virtual Desktop service principal
      Write-Host "[PROGRESS] Step 4/5: Finding Azure Virtual Desktop service principal..."

      $avdSpId = az ad sp list `
        --filter "displayName eq 'Azure Virtual Desktop'" `
        --query "[0].id" -o tsv 2>$null

      if ($LASTEXITCODE -ne 0) {
        $avdSpId = ""
      }

      if ([string]::IsNullOrEmpty($avdSpId) -or $avdSpId -eq "null") {
        Write-Host "[WARNING] Azure Virtual Desktop service principal not found"
        Write-Host "[WARNING] This service principal may not exist in your tenant"
        Write-Host "[WARNING] You may need to manually assign the role via Azure Portal"
        exit 0
      }

      Write-Host "[VALIDATE] Azure Virtual Desktop service principal found: $avdSpId"

      # Step 5: Assign role
      Write-Host "[PROGRESS] Step 5/5: Assigning RBAC role..."
      Write-Host "[PROGRESS] Role: Desktop Virtualization Power On Off Contributor"
      Write-Host "[PROGRESS] Assignee: Azure Virtual Desktop (service principal)"
      Write-Host "[PROGRESS] Scope: Subscription"

      az role assignment create `
        --assignee $avdSpId `
        --role "Desktop Virtualization Power On Off Contributor" `
        --scope $subscriptionScope `
        --output none 2>$null

      if ($LASTEXITCODE -eq 0) {
        Write-Host "[SUCCESS] RBAC role assigned to AVD service principal"
      } else {
        # Check if already exists
        $existingAssignment = az role assignment list `
          --assignee $avdSpId `
          --scope $subscriptionScope `
          --query "[?roleDefinitionName=='Desktop Virtualization Power On Off Contributor']" -o tsv 2>$null

        if ($existingAssignment -match "Desktop") {
          Write-Host "[SUCCESS] RBAC role already assigned to AVD service principal"
        } else {
          Write-Host "[ERROR] Failed to assign RBAC role"
          Write-Host "[ERROR] You may need to manually assign the role via Azure Portal"
          exit 1
        }
      }

      # Verify assignment
      Write-Host "[VALIDATE] Verifying role assignment..."
      $roleAssignment = az role assignment list `
        --assignee $avdSpId `
        --scope $subscriptionScope `
        --query "[?roleDefinitionName=='Desktop Virtualization Power On Off Contributor'].roleDefinitionName" -o tsv

      Write-Host "[VALIDATE] Role assignment: $roleAssignment"


      Write-Host "[SUCCESS] Autoscaling RBAC assignment completed"
      exit 0
