#!/bin/bash

################################################################################
# Configuration Template for AVD Deployment Steps
#
# Purpose: Template for creating configuration files for new deployment steps
# Usage: Copy this file and customize for your deployment step
#
# Configuration Priority (highest to lowest):
#   1. Environment variables (already set)
#   2. This file (local config)
#   3. ../config/avd-config.sh (centralized config)
#   4. Script defaults
#
# Pattern:
#   export VAR_NAME="${VAR_NAME:-default_value}"
#   - Uses centralized value if set
#   - Allows environment variable override
#   - Provides default if neither set
#
# Notes:
#   - Never hardcode sensitive values (passwords, keys)
#   - Pass sensitive values via environment variables
#   - All variable names should be UPPERCASE_WITH_UNDERSCORES
#
################################################################################

# ============================================================================
# LOAD CENTRALIZED CONFIGURATION
# ============================================================================

# Source centralized config file first (gets global defaults)
CENTRALIZED_CONFIG="${CENTRALIZED_CONFIG:-../config/avd-config.sh}"
if [[ -f "$CENTRALIZED_CONFIG" ]]; then
    source "$CENTRALIZED_CONFIG"
fi

# ============================================================================
# AZURE ENVIRONMENT
# ============================================================================

# Subscription
export SUBSCRIPTION_ID="${SUBSCRIPTION_ID:-}"
export TENANT_ID="${TENANT_ID:-}"

# Resource Group
export RESOURCE_GROUP_NAME="${RESOURCE_GROUP_NAME:-RG-Azure-VDI-01}"
export LOCATION="${LOCATION:-centralus}"

# Tags for resources
export TAGS="${TAGS:-environment=production owner=infrastructure}"

# ============================================================================
# NETWORKING CONFIGURATION (if applicable)
# ============================================================================

# Virtual Network
export VNET_NAME="${VNET_NAME:-avd-vnet}"
export VNET_CIDR="${VNET_CIDR:-10.0.0.0/16}"

# Subnet
export SUBNET_NAME="${SUBNET_NAME:-avd-subnet}"
export SUBNET_CIDR="${SUBNET_CIDR:-10.0.1.0/24}"

# Network Security Group
export NSG_NAME="${NSG_NAME:-avd-nsg}"

# ============================================================================
# STORAGE CONFIGURATION (if applicable)
# ============================================================================

# Storage Account
export STORAGE_ACCOUNT_NAME="${STORAGE_ACCOUNT_NAME:-}"
export STORAGE_ACCOUNT_SKU="${STORAGE_ACCOUNT_SKU:-Standard_LRS}"
export STORAGE_ACCOUNT_KIND="${STORAGE_ACCOUNT_KIND:-StorageV2}"
export STORAGE_ACCOUNT_TIER="${STORAGE_ACCOUNT_TIER:-Hot}"

# File Share
export FILE_SHARE_NAME="${FILE_SHARE_NAME:-}"
export FILE_SHARE_QUOTA="${FILE_SHARE_QUOTA:-100}"

# ============================================================================
# COMPUTE CONFIGURATION (if applicable)
# ============================================================================

# Virtual Machine
export VM_NAME="${VM_NAME:-}"
export VM_SIZE="${VM_SIZE:-Standard_D4s_v5}"
export VM_IMAGE="${VM_IMAGE:-UbuntuLTS}"

# Administrator
export ADMIN_USERNAME="${ADMIN_USERNAME:-azureuser}"
export ADMIN_PASSWORD="${ADMIN_PASSWORD:-}"  # Pass via environment variable!

# Disks
export OS_DISK_SIZE="${OS_DISK_SIZE:-128}"
export DATA_DISK_SIZE="${DATA_DISK_SIZE:-}"

# ============================================================================
# IDENTITY & SECURITY (if applicable)
# ============================================================================

# Service Principal (for automation)
export SERVICE_PRINCIPAL_ID="${SERVICE_PRINCIPAL_ID:-}"
export SERVICE_PRINCIPAL_SECRET="${SERVICE_PRINCIPAL_SECRET:-}"  # Via environment!

# Key Vault (for secrets management)
export KEY_VAULT_NAME="${KEY_VAULT_NAME:-}"
export KEY_VAULT_RESOURCE_GROUP="${KEY_VAULT_RESOURCE_GROUP:-$RESOURCE_GROUP_NAME}"

# ============================================================================
# APPLICATION/SERVICE CONFIGURATION (if applicable)
# ============================================================================

# Application-specific variables
# export APP_NAME="${APP_NAME:-}"
# export APP_VERSION="${APP_VERSION:-}"
# export APP_PORT="${APP_PORT:-8080}"

# ============================================================================
# LOGGING & ARTIFACTS
# ============================================================================

# Logging
export LOG_LEVEL="${LOG_LEVEL:-INFO}"
export ENABLE_LOGGING="${ENABLE_LOGGING:-1}"

# Artifacts directory
export ARTIFACTS_DIR="${ARTIFACTS_DIR:-artifacts}"

# ============================================================================
# TIMING & RETRY CONFIGURATION
# ============================================================================

# Timeout values (in seconds)
export OPERATION_TIMEOUT="${OPERATION_TIMEOUT:-600}"
export POLLING_INTERVAL="${POLLING_INTERVAL:-10}"

# Retry configuration
export RETRY_ATTEMPTS="${RETRY_ATTEMPTS:-3}"
export RETRY_DELAY="${RETRY_DELAY:-5}"

# ============================================================================
# FEATURE FLAGS (for optional functionality)
# ============================================================================

# Enable/disable features
export ENABLE_MONITORING="${ENABLE_MONITORING:-0}"
export ENABLE_BACKUP="${ENABLE_BACKUP:-0}"
export ENABLE_ENCRYPTION="${ENABLE_ENCRYPTION:-1}"

# ============================================================================
# ADVANCED OPTIONS
# ============================================================================

# Debug mode
export DEBUG="${DEBUG:-0}"

# Dry run (validate without making changes)
export DRY_RUN="${DRY_RUN:-0}"

# Force operations (skip confirmations)
export FORCE="${FORCE:-0}"

# ============================================================================
# CONFIGURATION VALIDATION
# ============================================================================

# This section is executed when the config is sourced
# Uncomment to add validation

# Validate required variables
# required_vars=(
#     "RESOURCE_GROUP_NAME"
#     "LOCATION"
#     "VNET_NAME"
# )
#
# for var in "${required_vars[@]}"; do
#     if [[ -z "${!var:-}" ]]; then
#         echo "ERROR: Required configuration variable not set: $var"
#         exit 1
#     fi
# done

# ============================================================================
# CONFIGURATION SUMMARY
# ============================================================================

# Uncomment to print configuration on load
# echo ""
# echo "=== Configuration Loaded ==="
# echo "RESOURCE_GROUP_NAME = $RESOURCE_GROUP_NAME"
# echo "LOCATION = $LOCATION"
# echo "VNET_NAME = $VNET_NAME"
# echo "SUBNET_NAME = $SUBNET_NAME"
# echo ""
